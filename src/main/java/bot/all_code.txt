package bot.commands;

public class AboutCommand implements Command { // implements ‚Üí –∫–æ–≥–¥–∞ –∫–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

    @Override // –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–µ—Ç–æ–¥ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    public String getName() 
    { 
    	return "/about"; 
    }

    @Override
    public String getInformation() 
    { 
    	return "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞"; 
    }

    @Override
    public String realization(String[] args) 
    {
        return "–ü—Ä–∏–≤–µ—Ç! –Ø - –±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç —Ç–µ–±–µ –Ω–µ –∑–∞–±—ã–≤–∞—Ç—å –æ —Å–≤–æ–µ–º –¥–æ–º–∞—à–Ω–µ–º –∑–∞–¥–∞–Ω–∏–∏.";
    }
    
}
package bot.commands;

import bot.homework.SQLiteHomeworkStorage;
import bot.homework.HomeworkLinkStorage;
import bot.schedule.Schedule;
import bot.schedule.ScheduleManager;
import bot.schedule.Lesson;
import bot.user.User;
import bot.user.UserStorage;
import bot.fsm.DialogState;

import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.format.DateTimeParseException;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

public class AddHomeworkCommand implements Command {

    private final SQLiteHomeworkStorage storage;
    private final UserStorage userStorage;
    private final ScheduleManager scheduleManager;
    private final HomeworkLinkStorage linkStorage;

    private final Map<Long, Draft> pending = new ConcurrentHashMap<>();

    public AddHomeworkCommand(UserStorage userStorage) {
        this.userStorage = userStorage;
        this.storage = new SQLiteHomeworkStorage();
        this.storage.initialize();
        this.scheduleManager = new ScheduleManager(userStorage);
        this.linkStorage = new HomeworkLinkStorage();
    }

    @Override
    public String getName() {
        return "/addhw";
    }

    @Override
    public String getInformation() {
        return "–î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É";
    }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addhw *–æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è*.";
    }

    // –∑–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
    public String start(long chatId) {
        User user = userStorage.getUser(chatId);
        if (user == null) return "‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start.";

        pending.remove(chatId);
        pending.put(chatId, new Draft());

        user.setState(DialogState.ASK_HW_SUBJECT);
        userStorage.updateUser(user);

        Schedule schedule = scheduleManager.getScheduleForUser(chatId);
        if (schedule == null) {
            return "–®–∞–≥ 1/4 ‚Äî –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞).";
        }
        // –ø–æ–∫–∞–∑–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
        Set<String> subs = new LinkedHashSet<>();
        for (List<Lesson> dayLessons : schedule.getWeeklySchedule().values()) {
            if (dayLessons != null) {
                for (Lesson lesson : dayLessons) {
                    if (lesson != null && lesson.getSubject() != null) {
                        String subject = lesson.getSubject().trim();
                        subs.add(subject);
                    }
                }
            }
        }
        if (subs.isEmpty()) {
            return "–®–∞–≥ 1/4 ‚Äî –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç (–≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã).";
        }
        StringBuilder sb = new StringBuilder("–®–∞–≥ 1/4 ‚Äî –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç:\n");
        int counter = 1;
        for (String subject : subs) {
            sb.append(counter)
                    .append(". ")
                    .append(subject)
                    .append("\n");
            counter++;
        }

        sb.append("\n–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞.");
        return sb.toString();
    }

    public String handleStateMessage(long chatId, String messageText) {
        if (messageText == null) messageText = "";
        String txt = messageText.trim();

        User user = userStorage.getUser(chatId);
        if (user == null) return "‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start.";
        Draft draft = pending.get(chatId);
        if (draft == null) {
            draft = new Draft();
            pending.put(chatId, draft);
        }
        //–ü—Ä–µ–¥–º–µ—Ç
        if (user.getState() == DialogState.ASK_HW_SUBJECT) {

            if (txt.isEmpty()) {
                return "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.";
            }

            Schedule schedule = scheduleManager.getScheduleForUser(chatId);
            if (schedule != null) {
                final String subjectInput = txt;
                boolean found = schedule.getWeeklySchedule().values().stream() // –µ—Å—Ç—å –ª–∏ —Ç–∞–∫–æ–π –ø—Ä–µ–¥–º–µ—Ç —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        .filter(Objects::nonNull) // —É–±–∏—Ä–∞–µ–º –¥–Ω–∏ —Å null
                        .flatMap(Collection::stream) // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ Stream<Lesson>
                        .filter(Objects::nonNull)
                        .anyMatch(l -> l.getSubject() != null &&
                                            l.getSubject().equalsIgnoreCase(subjectInput)); // –∏—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è

                if (!found) {
                    return "‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏. –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç.";
                }
                else {
                    draft.subject = txt;
                    user.setState(DialogState.ASK_HW_TIME);
                    userStorage.updateUser(user);
                    return "–®–∞–≥ 2/4 ‚Äî –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É YYYY-MM-DD –∏–ª–∏ MONDAY.";
                }
            }

        }
        // –í—Ä–µ–º—è
        if (user.getState() == DialogState.ASK_HW_TIME) {
            if (txt.isEmpty()) return "–í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É YYYY-MM-DD –∏–ª–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (MONDAY..SUNDAY).";

            LocalDate date;
            try {
                date = LocalDate.parse(txt);
            }
            catch (DateTimeParseException e) { // –µ—Å–ª–∏ –±—ã–ª –≤–≤–µ–¥—ë–Ω –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ —Ç–∏–ø–∞ –º–æ–Ω–¥—ç–π–π
                // –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
                try {
                    DayOfWeek dow = DayOfWeek.valueOf(txt.toUpperCase());
                    LocalDate today = LocalDate.now();
                    int delta = (dow.getValue() - today.getDayOfWeek().getValue() + 7) % 7;
                    if (delta == 0) delta = 7;
                    date = today.plusDays(delta);
                } catch (Exception ex) {
                    return "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏—Ç–µ YYYY-MM-DD –∏–ª–∏ MONDAY..SUNDAY.";
                }
            }

            draft.dueDate = date;

            // –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –µ—Å—Ç—å ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–µ–¥–º–µ—Ç –µ—Å—Ç—å –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
            Schedule s = scheduleManager.getScheduleForUser(chatId);
            if (s != null && draft.subject != null) {
                String dayKey = date.getDayOfWeek().name();
                List<Lesson> lessons = s.getWeeklySchedule().get(dayKey);
                boolean ok = false;
                if (lessons != null) {
                    for (Lesson l : lessons) {
                        if (l != null && l.getSubject() != null && l.getSubject().equalsIgnoreCase(draft.subject.trim())) {
                            ok = true; break;
                        }
                    }
                }
                if (!ok) {
                    return "‚ùå –ù–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É –ø—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏. –í–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.";
                }
            }

            user.setState(DialogState.ASK_HW_DESCRIPTION);
            userStorage.updateUser(user);
            return "–®–∞–≥ 3/4 ‚Äî –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è (–∏–ª–∏ /skip –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è).";
        }
        // –û–∂–∏–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        if (user.getState() == DialogState.ASK_HW_DESCRIPTION) {
            if (txt.equalsIgnoreCase("/skip")) txt = "";
            draft.description = txt;

            // –ü–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ —à–∞–≥ –≤–æ–ø—Ä–æ—Å–∞ –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏
            user.setState(DialogState.ASK_HW_REMIND);
            userStorage.updateUser(user);
            return "–®–∞–≥ 4/4 ‚Äî –ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞ –Ω–∞–ø–æ–º–Ω–∏—Ç—å? –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1). –í–≤–µ–¥–∏—Ç–µ /skip –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (1).";
        }

        // –û–∂–∏–¥–∞–µ–º remind-days
        if (user.getState() == DialogState.ASK_HW_REMIND) {
            final int DEFAULT = 1;
            int remindDays = DEFAULT;
            if (txt.equalsIgnoreCase("/skip") || txt.isEmpty()) {
                remindDays = DEFAULT;
            } else {
                try {
                    remindDays = Integer.parseInt(txt);
                    if (remindDays < 0 || remindDays > 365) {
                        return "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 365 (0 ‚Äî –≤ –¥–µ–Ω—å –¥–µ–¥–ª–∞–π–Ω–∞), –ª–∏–±–æ –≤–≤–µ–¥–∏—Ç–µ /skip.";
                    }
                } catch (NumberFormatException e) {
                    return "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1) –∏–ª–∏ /skip.";
                }
            }

            draft.remindBeforeDays = remindDays;

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ –≤ –ë–î —Å remindBeforeDays
            try {
                storage.addHomework(
                        chatId,
                        draft.subject == null ? "-" : draft.subject,
                        draft.description == null ? "" : draft.description,
                        draft.dueDate == null ? LocalDate.now() : draft.dueDate,
                        draft.remindBeforeDays
                );
            } catch (Exception e) {
                e.printStackTrace();
                return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
            }

            // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –∫ –ø–∞—Ä–µ/—É—Ä–æ–∫—É
            try {
                Schedule sched = scheduleManager.getScheduleForUser(chatId);
                if (sched != null && draft.subject != null && draft.dueDate != null) {
                    String dayKey = draft.dueDate.getDayOfWeek().name();
                    List<Lesson> lessons = sched.getWeeklySchedule().get(dayKey);
                    if (lessons != null) {
                        for (int i = 0; i < lessons.size(); i++) {
                            Lesson l = lessons.get(i);
                            if (l != null && l.getSubject() != null &&
                                    l.getSubject().equalsIgnoreCase(draft.subject)) {
                                linkStorage.linkLatestHomeworkByUserSubjectDate(chatId, draft.subject, draft.dueDate, dayKey, i);
                                break;
                            }
                        }
                    }
                }
            } catch (Exception ex) {
                ex.printStackTrace();
            }

            pending.remove(chatId);
            user.setState(DialogState.REGISTERED);
            userStorage.updateUser(user);

            return "‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ: " + (draft.subject == null ? "-" : draft.subject)
                    + " ‚Äî " + (draft.description == null || draft.description.isEmpty() ? "-" : draft.description)
                    + " (–¥–æ " + (draft.dueDate == null ? "-" : draft.dueDate.toString()) + "). –ù–∞–ø–æ–º–Ω—é –∑–∞ " + draft.remindBeforeDays + " –¥–Ω.";
        }

        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
        user.setState(DialogState.ASK_HW_SUBJECT);
        userStorage.updateUser(user);
        return "–ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.";
    }

    private static class Draft {
        String subject;
        String description;
        LocalDate dueDate;
        int remindBeforeDays = 1;
    }
}
package bot.commands;

public class AuthorsCommand implements Command {
	
	@Override // –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–µ—Ç–æ–¥ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    public String getName() 
    { 
    	return "/authors"; 
    }

    @Override
    public String getInformation() 
    { 
    	return "–†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –±–æ—Ç–∞"; 
    }

    @Override
    public String realization(String[] args) 
    {
        return "–ù–µ—Å—Ç–µ—Ä–æ–≤–∞ –í–∏–∫—Ç–æ—Ä–∏—è, –í–æ—Ä–æ–±—å—ë–≤ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä, –ú–ï–ù-241001 (–ö–ë-202)";
    }

}
package bot.commands;

public interface Command {
	
	String getName();
	String getInformation();
	String realization(String[] args);

}
package bot.commands;

import bot.session.EditSessionManager;
import java.time.DayOfWeek;
import bot.session.Session;
import bot.fsm.DialogState;
import bot.schedule.Lesson;
import bot.schedule.Schedule;
import bot.schedule.ScheduleManager;
import bot.user.User;
import bot.user.UserStorage;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardButton;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardRow;

import java.time.LocalTime;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.List;

public class EditScheduleCommand implements Command {

    private final UserStorage userStorage;
    private final ScheduleManager scheduleManager;

    public EditScheduleCommand(UserStorage userStorage, ScheduleManager scheduleManager) {
        this.userStorage = userStorage;
        this.scheduleManager = scheduleManager;
    }

    @Override
    public String getName() {
        return "/editSchedule";
    }

    @Override
    public String getInformation() {
        return "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å (–¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É)\n"
        		+ "–ø—Ä–∏–º–µ—Ä –≤–≤–æ–¥–∞: /editSchedule monday";
    }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /editSchedule <–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏>, –Ω–∞–ø—Ä–∏–º–µ—Ä: /editSchedule monday";
    }


    public SendMessage processChange(long chatId, String[] args) { // —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–º–∞—à–∫–∏
        User user = userStorage.getUser(chatId);
        if (user == null) {
            return createMessage(chatId, "‚ùå‚ùå‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π /start");
        }

        if (args == null || args.length < 2 || args[1].trim().isEmpty()) {
            return createMessage(chatId, "‚ùå‚ùå‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: /editSchedule monday");
        }

        String dayInput = args[1].trim();
        
        DayOfWeek dayEnum = null;
        for (DayOfWeek day : DayOfWeek.values()) {
            if (day.name().equalsIgnoreCase(dayInput)) {
                dayEnum = day;
                break;
            }
        }
        if (dayEnum == null) { // –Ω–µ –Ω–∞—à–ª–∏ –≤ –¥–Ω—è—Ö –≤–≤–µ–¥–µ–Ω–Ω—ã–π –¥–µ–Ω—å
            return createMessage(chatId,
                "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏. –£–∫–∞–∂–∏—Ç–µ –æ–¥–∏–Ω –∏–∑: " +
                "Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday.");
        }

        String dayLower = dayEnum.name().toLowerCase();

        user.setWaitingForButton(false); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏, (—á—Ç–æ–±—ã StartCommand –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª –Ω–∞–∂–∞—Ç–∏—è)
        userStorage.updateUser(user);

        Session session = EditSessionManager.getSession(chatId); // –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        session.setDay(dayLower); // –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º lower; –ø–æ–∑–∂–µ –∑–∞–º–µ–Ω–∏–º –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫–ª—é—á 


     if (!scheduleManager.customScheduleExists(chatId)) { // –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è - –∫–æ–ø–∏—Ä—É–µ–º –æ–±—â–µ–µ
         scheduleManager.copyCommonToCustom(chatId);
     }

        Schedule schedule = scheduleManager.getScheduleForUser(chatId); // –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        if (schedule == null) {
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }

        // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —É—Ä–æ–∫–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–Ω—è (matchedDay)
        List<Lesson> lessons = schedule.getLessonsForDay(dayLower);
        
        String matchedDay = null;
        if (lessons != null && !lessons.isEmpty()) {
            matchedDay = dayLower;
        } else {
            String cap = dayLower.substring(0, 1).toUpperCase() + dayLower.substring(1).toLowerCase();
            lessons = schedule.getLessonsForDay(cap);
            if (lessons != null && !lessons.isEmpty()) {
                matchedDay = cap;
            } else {
                lessons = schedule.getLessonsForDay(dayLower.toUpperCase());
                if (lessons != null && !lessons.isEmpty()) {
                    matchedDay = dayLower.toUpperCase();
                }
            }
        }

        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø–∞—Ä—ã –ø–æ–¥ –∫–∞–∫–∏–º-—Ç–æ –∫–ª—é—á–æ–º ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —ç—Ç–æ—Ç –∫–ª—é—á –≤ —Å–µ—Å—Å–∏–∏, —á—Ç–æ–±—ã –¥–∞–ª—å–Ω–µ–π—à–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –µ–≥–æ.
        if (matchedDay != null) {
            session.setDay(matchedDay);
        } else {
            // –æ—Å—Ç–∞–≤–ª—è–µ–º lower –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –Ω–æ–≤—ã–µ –ø–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥ —ç—Ç–∏–º –∫–ª—é—á–æ–º
            session.setDay(dayLower);
        }

        StringBuilder text = new StringBuilder("üéì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ " + session.getDay() + ":\n\n");
        if (lessons == null || lessons.isEmpty()) {
            text.append("–ü–∞—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.\n\n");
        } else {
            for (int i = 0; i < lessons.size(); i++) {
                Lesson les = lessons.get(i);
                text.append(i + 1).append(". ")
                        .append(les.getSubject())
                        .append(" (").append(les.getStartTime())
                        .append(" - ").append(les.getEndTime())
                        .append(", ").append(les.getClassroom()).append(")\n");
            }
            text.append("\n");
        }
        text.append("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:");

        user.setState(DialogState.EDIT_CHOOSE_ACTION); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
        userStorage.updateUser(user);

        List<String> options = List.of("–î–æ–±–∞–≤–∏—Ç—å", "–£–¥–∞–ª–∏—Ç—å");
        return createMessageWithDynamicButtons(chatId, text.toString(), options);
    }


    public SendMessage processEdit(long chatId, String rawMessageText) { // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        String messageText = rawMessageText == null ? "" : rawMessageText.trim();

        User user = userStorage.getUser(chatId);
        if (user == null) {
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.");
        }

        Session session = EditSessionManager.getSession(chatId);
        if (session == null || session.getDay() == null) {
            // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞ ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
            user.setState(DialogState.REGISTERED);
            userStorage.updateUser(user);
            return createMessage(chatId, "‚ùå –°–µ—Å—Å–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ç—Ä–∞—á–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ /editSchedule <–¥–µ–Ω—å> —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.");
        }

        String day = session.getDay();
        Schedule schedule = scheduleManager.getScheduleForUser(chatId);
        if (schedule == null) {
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }

        switch (user.getState()) {
            case EDIT_CHOOSE_ACTION:
                if (messageText.equalsIgnoreCase("–î–æ–±–∞–≤–∏—Ç—å")) {
                    user.setState(DialogState.ASK_SUBJECT);
                    userStorage.updateUser(user);
                    return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:");
                } else if (messageText.equalsIgnoreCase("–£–¥–∞–ª–∏—Ç—å")) {
                    user.setState(DialogState.ASK_LESSON_INDEX);
                    userStorage.updateUser(user);
                    return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∞—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:");
                } else {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏: –î–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –£–¥–∞–ª–∏—Ç—å");
                }

            case ASK_SUBJECT:
                if (messageText.isEmpty()) {
                    return createMessage(chatId, "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:");
                }
                session.setSubject(messageText);
                user.setState(DialogState.ASK_ROOM);
                userStorage.updateUser(user);
                return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏:");

            case ASK_ROOM:
                if (messageText.isEmpty()) {
                    return createMessage(chatId, "‚ùå –ù–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é:");
                }
                session.setRoom(messageText);
                user.setState(DialogState.ASK_TIME_BEGIN);
                userStorage.updateUser(user);
                return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 09:00):");

            case ASK_TIME_BEGIN:
                if (messageText.isEmpty()) {
                    return createMessage(chatId, "‚ùå –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 09:00):");
                }
                session.setTimeBegin(messageText);
                user.setState(DialogState.ASK_TIME_END);
                userStorage.updateUser(user);
                return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10:30):");

            case ASK_TIME_END:
                if (messageText.isEmpty()) {
                    return createMessage(chatId, "‚ùå –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10:30):");
                }
                session.setTimeEnd(messageText);

                // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –ø–∞—Ä—É
                try {
                    LocalTime begin = LocalTime.parse(session.getTimeBegin());
                    LocalTime end = LocalTime.parse(session.getTimeEnd());
                    Lesson newLesson = new Lesson(session.getSubject(), begin, end, session.getRoom());

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º session.getDay() –∫–∞–∫ –∫–ª—é—á 
                    schedule.addLesson(session.getDay(), newLesson);
                    scheduleManager.saveCustomSchedule(chatId, schedule);

                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);
                    EditSessionManager.clearSession(chatId);

                    return createMessage(chatId, "‚úÖ –ü–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
                } catch (DateTimeParseException e) {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ ASK_TIME_END, –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                    user.setState(DialogState.ASK_TIME_END);
                    userStorage.updateUser(user);
                    return createMessage(chatId, "‚ùå –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–∞—Ä—ã. –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:mm, –Ω–∞–ø—Ä–∏–º–µ—Ä 09:00:");
                } catch (Exception e) {
                    e.printStackTrace();
                    return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–∞—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
                }

            case ASK_LESSON_INDEX:
                int index;
                try {
                    index = Integer.parseInt(messageText) - 1;
                } catch (NumberFormatException e) {
                    return createMessage(chatId, "‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∞—Ä—ã —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1):");
                }

                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —É—Ä–æ–∫–∏ –ø–æ session.getDay(), –∏ –µ—Å–ª–∏ —ç—Ç–æ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ–±—É–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞
                List<Lesson> lessons = schedule.getLessonsForDay(day);
                if (lessons == null || lessons.isEmpty()) {
                    String cap = day.substring(0, 1).toUpperCase() + day.substring(1).toLowerCase();
                    lessons = schedule.getLessonsForDay(cap);
                    if (lessons != null && !lessons.isEmpty()) {
                        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–µ—Å—Å–∏–∏ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –µ–≥–æ
                        session.setDay(cap);
                        day = cap;
                    } else {
                        lessons = schedule.getLessonsForDay(day.toUpperCase());
                        if (lessons != null && !lessons.isEmpty()) {
                            session.setDay(day.toUpperCase());
                            day = day.toUpperCase();
                        }
                    }
                }

                if (lessons == null || lessons.isEmpty()) { // –ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å
                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);
                    EditSessionManager.clearSession(chatId);
                    return createMessage(chatId, "‚ùå –ü–∞—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.");
                }

                if (index < 0 || index >= lessons.size()) {
                    return createMessage(chatId, "‚ùå –ü–∞—Ä—ã —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ—Ç. –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä:");
                }

                lessons.remove(index);

                try {
                    scheduleManager.saveCustomSchedule(chatId, schedule);

                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);
                    EditSessionManager.clearSession(chatId);

                    return createMessage(chatId, "‚úÖ –ü–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!");
                } catch (Exception e) {
                    e.printStackTrace();
                    return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
                }

            default: // –ï—Å–ª–∏ –ø–æ–ø–∞–ª–∏ —Å—é–¥–∞ ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                user.setState(DialogState.REGISTERED);
                userStorage.updateUser(user);
                EditSessionManager.clearSession(chatId);
                return createMessage(chatId, "‚ùå‚ùå‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ /editSchedule <–¥–µ–Ω—å> —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.");
        }
    }

    private SendMessage createMessage(long chatId, String text) { // —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        SendMessage message = new SendMessage();
        message.setChatId(String.valueOf(chatId));
        message.setText(text);
        return message;
    }

    private SendMessage createMessageWithDynamicButtons(long chatId, String text, List<String> options) { // —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫
        SendMessage message = new SendMessage(String.valueOf(chatId), text);

        ReplyKeyboardMarkup keyboardMarkup = new ReplyKeyboardMarkup();
        keyboardMarkup.setResizeKeyboard(true);
        keyboardMarkup.setOneTimeKeyboard(true);

        List<KeyboardRow> keyboard = new ArrayList<>();
        KeyboardRow currentRow = new KeyboardRow();

        for (int i = 0; i < options.size(); i++) {
            currentRow.add(new KeyboardButton(options.get(i)));
            if ((i + 1) % 2 == 0 || i == options.size() - 1) {
                keyboard.add(currentRow);
                currentRow = new KeyboardRow();
            }
        }

        keyboardMarkup.setKeyboard(keyboard);
        message.setReplyMarkup(keyboardMarkup);
        return message;
    }
}package bot.commands;

import java.util.Map;
public class HelpCommand implements Command {

	private final Map<String, Command> commands; //—Å—Å—ã–ª–∫–∞ –Ω–∞ –º–∞–ø—É –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥. final - 
    // –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å, –Ω–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç –Ω–µ –∑–∞–º–µ–Ω–∏—Ç—Å—è)

    public HelpCommand(Map<String, Command> commands) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥)
        this.commands = commands;
    }
    @Override
    public String getName() {
        return "/help";
    }

    @Override
    public String getInformation() {
        return "–í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ";
    }

    @Override
    public String realization(String[] args) {
        if (args.length > 1) { // —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ –ø–æ—Å–ª–µ /help –∏–¥–µ—Ç –∏–º—è –∫–æ–º–∞–Ω–¥—ã
        	String cmdName = args[1].trim().toLowerCase();
            Command cmd = commands.get(cmdName); // –∏—â–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–ª—é—á—É –≤ –º–∞–ø–µ
            if (cmd != null) {
                return cmd.getName() + " ‚Äî " + cmd.getInformation();
            } 
            else {
                return "–ö–æ–º–∞–Ω–¥–∞ " + cmdName + " –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.";
            }
        }
        
        else { // –µ—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã
        	String result = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n";
        	for (Command command : commands.values()) {
        	    result += command.getName() + " ‚Äî " + command.getInformation() + "\n\n\n";
            }
            return result;
        }
    }
}package bot.commands;

import bot.user.User;
import bot.user.UserStorage;
import bot.fsm.DialogState;
import bot.schedule.Schedule;
import bot.schedule.ScheduleFetcher;
import bot.schedule.ScheduleManager;

import org.telegram.telegrambots.meta.api.methods.send.SendMessage;

import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.util.Base64;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

public class InviteHandler {

    private final UserStorage userStorage;
    private final ObjectMapper mapper = new ObjectMapper();

    public InviteHandler(UserStorage userStorage) {
        this.userStorage = userStorage;
    }

    public SendMessage tryProcessInvite(long chatId, String fullText) {
        if (fullText == null) return null;

        String[] parts = fullText.split("\\s+");
        if (parts.length < 2) return null;

        String param = parts[1];
        if (!param.startsWith("invite_")) return null;

        try {
            String encoded = param.substring("invite_".length());

            // Base64 –∏–∑ URLDecoded
            String base64 = URLDecoder.decode(encoded, StandardCharsets.UTF_8);
            String json = new String(Base64.getDecoder().decode(base64), StandardCharsets.UTF_8);

            JsonNode obj = mapper.readTree(json);

            long inviterId = obj.has("inviter") ? obj.get("inviter").asLong(-1) : -1;

            if (inviterId == -1) {
                return msg(chatId, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏.");
            }

            // –∏—â–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
            User inviter = userStorage.getUser(inviterId);
            if (inviter == null) {
                return msg(chatId, "‚ùå –ü—Ä–∏–≥–ª–∞—à–∞—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.");
            }

            // —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-—Ü–µ–ª—å
            User user = userStorage.getUser(chatId);
            boolean existed = (user != null);
            if (!existed) {
                user = new User(chatId);
            }

            user.setGroup(inviter.getGroup());
            user.setUniversity(inviter.getUniversity());
            user.setDepartment(inviter.getDepartment());
            user.setCourse(inviter.getCourse());
            user.setWaitingForButton(false);

            // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Äî –æ–±–Ω–æ–≤–∏–º –∏ –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            if (existed && user.getState() == DialogState.REGISTERED) {
                userStorage.updateUser(user);

                try {
                    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º fetcher –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
                    ScheduleFetcher fetcher = new ScheduleFetcher();
                    Schedule schedule = fetcher.fetchForUser(user);

                    ScheduleManager sm = new ScheduleManager(userStorage);
                    if (schedule != null) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
                        sm.saveCommonSchedule(schedule);

                        // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª –∫–∞—Å—Ç–æ–º ‚Äî —Å–±—Ä–æ—Å–∏–º, —á—Ç–æ–±—ã –Ω–æ–≤–æ–µ –æ–±—â–µ–µ –≤—Å—Ç—É–ø–∏–ª–æ –≤ —Å–∏–ª—É
                        if (sm.customScheduleExists(chatId)) {
                            sm.resetToOriginalSchedule(chatId);
                        }
                        sm.close();

                        return msg(chatId,
                                "–í—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é! üéâ\n\n" +
                                        "–í–∞—à–∞ –≥—Ä—É–ø–ø–∞ –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n" +
                                        "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—ã–ª–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã.\n\n" +
                                        "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                                        "–ò–Ω—Å—Ç–∏—Ç—É—Ç: " + user.getUniversity() + "\n" +
                                        "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                                        "–ö—É—Ä—Å: " + user.getCourse());
                    } else {
                        sm.close();
                        return msg(chatId,
                                "–í—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é! üéâ\n\n" +
                                        "–î–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã.\n" +
                                        "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                                        "–ò–Ω—Å—Ç–∏—Ç—É—Ç: " + user.getUniversity() + "\n" +
                                        "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                                        "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                                        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö —É –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ.");
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                    return msg(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é.");
                }
            }

            // –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö / –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî –∫–∞–∫ –±—ã–ª–æ
            user.setState(DialogState.ASK_NAME_INVITE);

            if (existed) {
                userStorage.updateUser(user);
            } else {
                userStorage.saveUser(user);
            }

            return msg(chatId,
                    "–í—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é! üéâ\n\n" +
                            "–î–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±—ã–ª–∏ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:\n" +
                            "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                            "–ò–Ω—Å—Ç–∏—Ç—É—Ç: " + user.getUniversity() + "\n" +
                            "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                            "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                            "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");

        } catch (Exception e) {
            e.printStackTrace();
            return msg(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.");
        }
    }

    private SendMessage msg(long chatId, String text) {
        return new SendMessage(String.valueOf(chatId), text);
    }
}
package bot.commands;

import bot.homework.SQLiteHomeworkStorage;
import bot.homework.HomeworkItem;
import java.util.List;

public class MarkHomeworkCommand implements Command {

    private final SQLiteHomeworkStorage storage;
    private final boolean markAsDone;

    public MarkHomeworkCommand(boolean markAsDone) {
        this.storage = new SQLiteHomeworkStorage();
        this.storage.initialize();
        this.markAsDone = markAsDone;
    }

    @Override
    public String getName() {
        return markAsDone ? "/markhw" : "/unmarkhw";
    }

    @Override
    public String getInformation() {
        return markAsDone ? "–û—Ç–º–µ—Ç–∏—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ: /markhw <id>"
                : "–°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: /unmarkhw <id>";
    }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: " + (markAsDone ? "/markhw <id>" : "/unmarkhw <id>");
    }

    public String realizationWithChatId(long chatId, String[] args) { //–ø–µ—Ä–µ–¥–∞—ë–º id —á–∞—Ç–∞ –∏ –∫–æ–º–∞–Ω–¥—É, –ø–æ–ª—É—á–µ–Ω–Ω—É—é –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
        if (args == null || args.length < 2 || args[1].trim().isEmpty()) {
            return realization(args);
        }
        String idText = args[1].trim(); // —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        long id;
        try {
            id = Long.parseLong(idText);
        }
        catch (NumberFormatException e) {
            return "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: " + (markAsDone ? "/markhw <id>" : "/unmarkhw <id>");
        }

        try {
            List<HomeworkItem> items = storage.getHomeworkByUser(chatId);
            boolean found = items.stream().anyMatch(h -> h.getId() == id); //–µ—Å—Ç—å –ª–∏ –¥–∑ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!found) {
                return "‚ùå –ó–∞–¥–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —É –≤–∞—Å.";
            }

            storage.markAsCompleted(id, markAsDone);
            return markAsDone ? "‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ." : "‚úÖ –ü–æ–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–Ω—è—Ç–∞.";
        }
        catch (Exception e) {
            e.printStackTrace();
            return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞–Ω–∏—è.";
        }
    }
}
package bot.commands;

import bot.homework.SQLiteHomeworkStorage;
import bot.homework.HomeworkItem;

import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.format.DateTimeParseException;
import java.util.List;
import java.util.stream.Collectors;

public class PrintHomeworkCommand implements Command {

    private final SQLiteHomeworkStorage storage;

    public PrintHomeworkCommand() {
        this.storage = new SQLiteHomeworkStorage();
        this.storage.initialize();
    }

    @Override
    public String getName() {
        return "/homework";
    }

    @Override
    public String getInformation() {
        return "–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:\n"
        		+ "/homework ‚Äî –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è\n"
        		+ "/homework Monday ‚Äî –∑–∞–¥–∞–Ω–∏—è —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫\n"
        		+ "/homework 2025-11-20 ‚Äî –∑–∞–¥–∞–Ω–∏—è —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É\n"
        		+ "/homework *–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞* ‚Äî –∑–∞–¥–∞–Ω–∏—è –ø–æ –∫–æ–Ω—Ä–µ–∫—Ç–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É";
    }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n" +
                "/homework ‚Äî –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è\n" +
                "/homework Monday ‚Äî –∑–∞–¥–∞–Ω–∏—è —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫\n" +
                "/homework 2025-11-20 ‚Äî –∑–∞–¥–∞–Ω–∏—è —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É\n" +
                "/homework *–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞* ‚Äî –∑–∞–¥–∞–Ω–∏—è –ø–æ –∫–æ–Ω—Ä–µ–∫—Ç–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É";
    }

    public String realizationWithChatId(long chatId, String[] args) {
        try {
            List<HomeworkItem> all = storage.getHomeworkByUser(chatId);
            if (args != null && args.length > 1 && args[1] != null && !args[1].trim().isEmpty()) {
                String dayOrSubject = args[1].trim();
                for (DayOfWeek d : DayOfWeek.values()) { //–µ—Å–ª–∏ –±—ã–ª –≤–≤–µ–¥—ë–Ω –¥–µ–Ω—å (–º–æ–Ω–¥—ç–π —Ç—å—é—Å–¥–µ–π –∏ —Ç.–¥.)
                    if (d.name().equalsIgnoreCase(dayOrSubject)) {
                        List<HomeworkItem> filtered = all.stream() // —Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º—É –¥–Ω—é
                                .filter(h -> h.getDueDate() != null && h.getDueDate().getDayOfWeek() == d)
                                .collect(Collectors.toList());// –ø–æ—Ç–æ–∫ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ø–∏—Å–æ–∫
                        return formatHomeworkList(filtered, "–î–ó –Ω–∞ " + d.name());
                    }
                }
                try {
                    LocalDate date = LocalDate.parse(dayOrSubject); // –Ω—É –∞ —Ç—É—Ç –µ—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                    List<HomeworkItem> filtered = all.stream()
                            .filter(h -> h.getDueDate() != null && h.getDueDate().equals(date))
                            .collect(Collectors.toList());
                    return formatHomeworkList(filtered, "–î–ó –Ω–∞ " + date.toString());
                } catch (DateTimeParseException ignored) {
                    // –Ω–µ –¥–∞—Ç–∞ ‚Äî –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –ø—Ä–µ–¥–º–µ—Ç –∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É
                    List<HomeworkItem> filtered = storage.getHomeworkBySubject(chatId, dayOrSubject);
                    return formatHomeworkList(filtered, "–î–ó –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: " + dayOrSubject);
                }
            }

            return formatHomeworkList(all, "–í—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è");

        } catch (Exception e) {
            e.printStackTrace();
            return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π.";
        }
    }

    private String formatHomeworkList(List<HomeworkItem> list, String header) {
        StringBuilder sb = new StringBuilder();
        sb.append(header).append(":\n\n");
        if (list == null || list.isEmpty()) {
            sb.append(" ‚Äî –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–µ—Ç.");
            return sb.toString();
        }
        for (HomeworkItem item : list) {
            sb.append("ID: ").append(item.getId()).append(" | ")
                    .append(item.getSubject()).append(" ‚Äî ").append(item.getDescription())
                    .append(" (–¥–æ ").append(item.getDueDate()).append(") ")
                    .append(item.isCompleted() ? "‚úÖ" : "‚è≥")
                    .append("\n")
                    .append("\n");
        }
        return sb.toString();
    }
}
package bot.commands;

import bot.schedule.Schedule;
import bot.schedule.ScheduleManager; 
import bot.user.User;
import bot.user.UserStorage;

import java.time.DayOfWeek;
import java.util.List;
import java.util.Map;

public class ScheduleCommand implements Command {

    private final UserStorage userStorage;

    public ScheduleCommand(UserStorage userStorage) {
        this.userStorage = userStorage;
    }

    @Override
    public String getName() {
        return "/schedule";
    }

    @Override
    public String getInformation() {
        return "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å (/schedule Monday)";
    }

    @Override
    public String realization(String[] args) {
        return "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /schedule –∏–ª–∏ /schedule Monday";
    }


    public String realizationWithChatId(long chatId, String[] args) {
        try {
            User user = userStorage.getUser(chatId);
            if (user == null) {
                return "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start, —á—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.";
            }

            ScheduleManager manager = new ScheduleManager(userStorage); // —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–µ—Ä–µ–º —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂—Ä–µ, –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ
            Schedule sched = manager.getScheduleForUser(chatId);
            manager.close();

            if (sched == null) {
                return "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –û–Ω–æ –ª–∏–±–æ –µ—â—ë –Ω–µ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, " +
                        "–ª–∏–±–æ –≥—Ä—É–ø–ø–∞ –Ω–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏.";
            }

            
            if (args.length > 1) {
                String dayArg = args[1].trim();

                DayOfWeek day = null;
                for (DayOfWeek d : DayOfWeek.values()) {
                    if (d.name().equalsIgnoreCase(dayArg)) { 
                        day = d;
                        break;
                    }
                }

                if (day == null) {
                    return "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏–∑: Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday.";
                }

                String scheduleForDay = formatScheduleForDay(sched, day, user.getGroup());
                return scheduleForDay;
            }

            String out = formatScheduleForUser(sched); // –∏–Ω–∞—á–µ ‚Äî –≤—Å—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            return out;

        } catch (Exception e) {
            e.printStackTrace();
            return "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: " + e.getMessage();
        }
    }


    private String formatScheduleForDay(Schedule sched, DayOfWeek day, String group) {
        StringBuilder sb = new StringBuilder();

        String key = day.toString(); // –≤ Schedule –∫–ª—é—á–∏ –≤ –≤–∏–¥–µ "MONDAY"
        
        sb.append("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã: ");

        String groupName = sched.getGroupName();
        if (groupName != null) {
            sb.append(groupName);
        }

        sb.append("\n\n");

        List<bot.schedule.Lesson> lessons = getLessonsIgnoreCase(sched, key); // –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–Ω—è—Ç–∏–π –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É –∫–ª—é—á–∞ –¥–Ω—è

        if (lessons == null || lessons.isEmpty()) {
            sb.append("  ‚Äî –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –ø–∞—Ä –Ω–µ—Ç\n\n");

        } else {
            lessons.forEach(lesson -> {

                String start;
                if (lesson.getStartTime() == null) {
                    start = "";
                } else {
                    start = lesson.getStartTime().toString();
                }

                String end;
                if (lesson.getEndTime() == null) {
                    end = "";
                } else {
                    end = lesson.getEndTime().toString();
                }

                String subject;
                if (lesson.getSubject() == null) {
                    subject = "";
                } else {
                    subject = lesson.getSubject();
                }

                sb.append("  ")
                  .append(start)
                  .append(" - ")
                  .append(end)
                  .append(" | ")
                  .append(subject);

                if (lesson.getClassroom() != null && !lesson.getClassroom().isEmpty()) {
                    sb.append(" (").append(lesson.getClassroom()).append(")");
                }

                sb.append("\n");
            });

            sb.append("\n");
        }

        return sb.toString();
    }

    private String formatScheduleForUser(Schedule sched) {
        StringBuilder sb = new StringBuilder();

        sb.append("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã: ");

        String groupName = sched.getGroupName();
        if (groupName != null) {
            sb.append(groupName);
        }

        sb.append("\n\n");

        List<DayOfWeek> days = List.of(
                DayOfWeek.MONDAY, DayOfWeek.TUESDAY, DayOfWeek.WEDNESDAY,
                DayOfWeek.THURSDAY, DayOfWeek.FRIDAY, DayOfWeek.SATURDAY, DayOfWeek.SUNDAY
        );

        for (DayOfWeek day : days) {
            String key = day.toString(); // –≤ Schedule –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–ª—é—á–∏ –≤ –≤–∏–¥–µ "MONDAY"
            sb.append(day.toString()).append(":\n"); // –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è

            List<bot.schedule.Lesson> lessons = getLessonsIgnoreCase(sched, key); // –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–Ω—è—Ç–∏–π –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É –∫–ª—é—á–∞ –¥–Ω—è

            if (lessons == null || lessons.isEmpty()) {
                sb.append("  ‚Äî –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –ø–∞—Ä –Ω–µ—Ç\n\n");

            } else {
                lessons.forEach(lesson -> {

                    String start;
                    if (lesson.getStartTime() == null) {
                        start = "";
                    } else {
                        start = lesson.getStartTime().toString();
                    }

                    String end;
                    if (lesson.getEndTime() == null) {
                        end = "";
                    } else {
                        end = lesson.getEndTime().toString();
                    }

                    String subject;
                    if (lesson.getSubject() == null) {
                        subject = "";
                    } else {
                        subject = lesson.getSubject();
                    }
                    sb.append("  ")
                            .append(start)
                            .append(" - ")
                            .append(end)
                            .append(" | ")
                            .append(subject);

                    if (lesson.getClassroom() != null && !lesson.getClassroom().isEmpty()) {
                        sb.append(" (").append(lesson.getClassroom()).append(")");
                    }

                    sb.append("\n");
                });
                sb.append("\n");
            }
        }
        return sb.toString();
    }


    private List<bot.schedule.Lesson> getLessonsIgnoreCase(Schedule sched, String dayKey) { // –æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–Ω—è—Ç–∏–π –¥–ª—è –∫–ª—é—á–∞ dayKey, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ä–µ–≥–∏—Å—Ç—Ä –∫–ª—é—á–µ–π
        if (sched == null || sched.getWeeklySchedule() == null) return List.of();

        Map<String, List<bot.schedule.Lesson>> map = sched.getWeeklySchedule();

        // –ü—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π –ø–æ–∏—Å–∫
        if (map.containsKey(dayKey) && map.get(dayKey) != null) {
            return map.get(dayKey);
        }

        // –ò—â–µ–º –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É
        for (String k : map.keySet()) {
            if (k != null && k.equalsIgnoreCase(dayKey)) {
                return map.get(k);
            }
        }

        return List.of();
    }
}package bot.commands;

import bot.user.User;
import bot.user.UserStorage;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.time.Instant;
import java.time.temporal.ChronoUnit;
import java.util.Base64;

public class ShareGroupCommand implements Command {

    private final UserStorage userStorage;
    private final String botUsername;
    private final int expiryDays; // —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å—Å—ã–ª–∫–∏ –≤ –¥–Ω—è—Ö

    public ShareGroupCommand(UserStorage userStorage, String botUsername, int expiryDays) {
        this.userStorage = userStorage;
        this.botUsername = botUsername;
        this.expiryDays = expiryDays;
    }

    @Override
    public String getName() { return "/sharegroup"; }

    @Override
    public String getInformation() { return "–°–æ–∑–¥–∞—Ç—å deep-link –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (–ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–µ–π –≥—Ä—É–ø–ø–æ–π)"; }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /sharegroup ‚Äî —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (–¥–µ–π—Å—Ç–≤—É–µ—Ç " + expiryDays + " –¥–Ω–µ–π)";
    }

    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Homeworkbot –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ /sharegroup
    public String start(long chatId) {
        User user = userStorage.getUser(chatId);
        if (user == null) return "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.";
        String group = user.getGroup();
        if (group == null || group.trim().isEmpty()) return "‚ùå –£ –≤–∞—Å –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.";

        try {
            long inviter = chatId;
            // –§–æ—Ä–º–∏—Ä—É–µ–º JSON ‚Äî —Ç–æ–ª—å–∫–æ inviter.
            String json = String.format("{\"inviter\":%d}", inviter);

            // Base64 –≤ URLEncode
            String base64 = Base64.getEncoder().encodeToString(json.getBytes(StandardCharsets.UTF_8));
            String urlSafe = URLEncoder.encode(base64, StandardCharsets.UTF_8);

            String startParam = "invite_" + urlSafe;
            String link = "https://t.me/" + botUsername + "?start=" + startParam;

            return "‚úÖ –°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∞:\n" +
                    link +
                    "\n\n–ï—Å–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Å—Å—ã–ª–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, " +
                    "—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ:\n" +
                    "/start " + startParam;
        } catch (Exception e) {
            e.printStackTrace();
            return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.";
        }
    }

    // JSON-—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏–π (–∫–∞–≤—ã—á–∫–∏ –∏ –æ–±—Ä–∞—Ç–Ω—ã–π —Å–ª–µ—à)
    private String escapeJsonString(String s) {
        if (s == null) return "";
        return s.replace("\\", "\\\\").replace("\"", "\\\"");
    }
}
package bot.commands;

import bot.schedule.*;
import bot.user.*;
import bot.fsm.DialogState;


import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardButton;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardRow;

import java.util.*; //—á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Map, List 

public class StartCommand implements Command {
    private final UserStorage userStorage; // –æ–±—ä—è–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

    private static final Map<String, List<String>> INSTITUTE_DEPARTMENTS = new HashMap<>();

    static {
        INSTITUTE_DEPARTMENTS.put("–ò–ï–ù–∏–ú", List.of("–®–ù", "–®–ë"));
        INSTITUTE_DEPARTMENTS.put("–ò–Ω–≠–£", List.of("–®–ì–£–ü", "–®–£–ú–ò", "–®–≠–ú (–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç)"));
        INSTITUTE_DEPARTMENTS.put("–ò–§–ö–°–∏–ú–ü", List.of());
        INSTITUTE_DEPARTMENTS.put("–£–ì–ò", List.of("–ò", "–§", "–ñ", "–ò–ö–∏–î", "–ü–∏–°", "–ü", "–ú–û", "–õ", "–®–ê–∏–ü–†"));
        INSTITUTE_DEPARTMENTS.put("–ò–†–ò–¢-–†—Ç–§", List.of("–®–ë", "–®–ü–∏–ê–û"));
        INSTITUTE_DEPARTMENTS.put("–ò–ù–ú–¢", List.of("–°–ú", "–ú–∏–ú", "–ú", "–ù–ú–∏–¢ (–∏–Ω—Å—Ç–∏—Ç—É—Ç)"));
        INSTITUTE_DEPARTMENTS.put("–£—Ä–∞–ª–≠–ù–ò–ù", List.of());
        INSTITUTE_DEPARTMENTS.put("–§–¢–ò", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–ò–°–ê", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–•–¢–ò", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–ò–¢–û–û", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–ü–û–¥–ò–£", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–ë–ü–£–†", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–£–ü–ò–®", List.of("-"));
    }

    public StartCommand(UserStorage userStorage) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ 
        this.userStorage = userStorage;
    }

    
    @Override
    public String getName() {
        return "/start";
    }

    
    @Override
    public String getInformation() {
        return "–ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ —Å–∏—Å—Ç–µ–º–µ";
    }

    
    @Override
    public String realization(String[] args) {
        return "–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ /start –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º";
    }

   
    public SendMessage processStart(long chatId) { // –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
        try {
            User user = userStorage.getUser(chatId); // –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–¥
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å –∏ —É –Ω–µ–≥–æ –±—ã–ª–æ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
            ScheduleManager sm = new ScheduleManager(userStorage); // —Å–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
            if (sm.customScheduleExists(chatId)) { // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                sm.resetToOriginalSchedule(chatId); // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º (—É–¥–∞–ª—è–µ–º –∫–∞—Å—Ç–æ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ)
                System.out.println("–ö–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ /start –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + chatId);
            }
            sm.close(); // –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–∞–º–∏
            
            if (user == null) {
                user = new User(chatId);
                userStorage.saveUser(user);
                return createMessage(chatId, 
                    "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å –±–æ—Ç–æ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.\n\n" +
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
            }
            
            if (user.getState() ==  DialogState.REGISTERED) { // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –æ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                String userInfo = "üéì –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!\n\n" +
                                 "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                                 "–ò–º—è: " + user.getName() + "\n" +
                                 "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                                 "–ò–Ω—Å—Ç–∏—Ç—É—Ç: " + user.getUniversity() + "\n" +
                                 "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                                 "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                                 "–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è?";
                
                user.setWaitingForButton(true);
                userStorage.updateUser(user);
                
                return createMessageWithDynamicButtons(chatId, userInfo, List.of("–î–ê", "–ù–ï–¢")); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
            } else { // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                return continueRegistration(chatId, user);
            }
            
        } catch (Exception e) {
            e.printStackTrace();
            return createMessage(chatId, "‚ùå‚ùå‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã");
        }
    }

 
    public SendMessage processButtonResponse(long chatId, String messageText) { // –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–Ω–æ–ø–∫–∏ –¥–∞ –Ω–µ—Ç
        try {
            User user = userStorage.getUser(chatId);

            user.setWaitingForButton(false); // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            
            if (messageText.equalsIgnoreCase("–î–ê")) {
                user.setState(DialogState.ASK_NAME);
                userStorage.updateUser(user); // –æ–±–Ω–æ–≤–∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                return createMessage(chatId, 
                    "–ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö!\n\n" +
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –Ω–æ–≤–æ–µ –∏–º—è:");
            } else if (messageText.equalsIgnoreCase("–ù–ï–¢")) {
                userStorage.updateUser(user); 
                return createMessage(chatId, 
                    "–û—Ç–ª–∏—á–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n" +
                    "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞.\n" +
                    "–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–º–∞–Ω–¥.");
            } 
            
            return processRegistration(chatId, messageText);
            
        } catch (Exception e) {
            e.printStackTrace();
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ");
        }
    }

    
    private SendMessage continueRegistration(long chatId, User user) {  // –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        switch (user.getState()) {
            case ASK_NAME:
                return createMessage(chatId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
            case ASK_GROUP:
                return createMessage(chatId, 
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–ï–ù-241001):");
            default:
                return createMessage(chatId, "‚ùå‚ùå‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ /start");
        }
    }


    public SendMessage processRegistration(long chatId, String messageText) { // –ú–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        try {
            User user = userStorage.getUser(chatId); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
            switch (user.getState()) {
            case ASK_NAME:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
                }
                user.setName(messageText.trim()); 
                user.setState(DialogState.ASK_GROUP); 
                userStorage.updateUser(user); 
                return createMessage(chatId, 
                    "–û—Ç–ª–∏—á–Ω–æ, " + messageText.trim() + "!\n\n" +
                    "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–ï–ù-241001):");
                
            case ASK_NAME_INVITE:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
                }
                user.setName(messageText.trim()); 
                user.setState(DialogState.REGISTERED); // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É
                userStorage.updateUser(user);
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
                try {
                    ScheduleFetcher fetcher = new ScheduleFetcher();
                    Schedule schedule = fetcher.fetchForUser(user);
                    if (schedule != null) {
                        ScheduleManager sm = new ScheduleManager(userStorage);
                        sm.saveCommonSchedule(schedule);
                        sm.close();
                        return createMessage(chatId,
                            "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                            "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                            "–ò–º—è: " + user.getName() + "\n" +
                            "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                            "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç: " + user.getUniversity() + "\n" +
                            "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                            "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                            "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n" +
                            "–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.");
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }

                return createMessage(chatId, 
                    "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                    "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                    "–ò–º—è: " + user.getName() + "\n" +
                    "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                    "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç: " + user.getUniversity() + "\n" +
                    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                    "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                    "–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å!\n" +
                    "–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.");
                    
            case ASK_GROUP:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ì—Ä—É–ø–ø–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É:");
                }
                user.setGroup(messageText.trim());
                user.setState(DialogState.ASK_UNIVERSITY);
                userStorage.updateUser(user);
                return createMessageWithDynamicButtons(chatId, // —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ 
                    "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∏–Ω—Å—Ç–∏—Ç—É—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:",
                    new ArrayList<>(INSTITUTE_DEPARTMENTS.keySet())); // keyset –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–±–æ—Ä –∫–ª—é—á–µ–π (–≤—Å–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–Ω—Å—Ç–∏—Ç—É—Ç–æ–≤)

            case ASK_UNIVERSITY:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞:");
                } 

                String universityInput = messageText.trim();
                user.setUniversity(universityInput);
                user.setState(DialogState.ASK_DEPARTMENT);
                userStorage.updateUser(user);

                if (INSTITUTE_DEPARTMENTS.containsKey(universityInput)) { // –≤—ã–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –∏–Ω—Å—Ç–∏—Ç—É—Ç—É
                    List<String> deps = INSTITUTE_DEPARTMENTS.get(universityInput);
                    if (!deps.isEmpty()) {
                        return createMessageWithDynamicButtons(chatId,
                            "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:",
                            deps);
                    }
                }

                return createMessage(chatId, 
                    "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞:");

            case ASK_DEPARTMENT:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:");
                }
                
                user.setDepartment(messageText.trim());
                user.setState(DialogState.ASK_COURSE);
                userStorage.updateUser(user);
                
                List<String> courses = List.of("1", "2", "3", "4", "5", "6");
                
                return createMessageWithDynamicButtons(chatId, "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:", courses);

            case ASK_COURSE:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ö—É—Ä—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å:");
                }

                user.setCourse(messageText.trim());
                userStorage.updateUser(user);

                try {
                    ScheduleFetcher fetcher = new ScheduleFetcher();
                    Schedule schedule = fetcher.fetchForUser(user);

                    if (schedule != null) {
                        ScheduleManager sm = new ScheduleManager(userStorage);
                        sm.saveCommonSchedule(schedule);
                        sm.close();

                        user.setState(DialogState.REGISTERED);
                        userStorage.updateUser(user);

                        return createMessage(chatId,
                            "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                            "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                            "–ò–º—è: " + user.getName() + "\n" +
                            "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                            "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç: " + user.getUniversity() + "\n" +
                            "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                            "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                            "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n" +
                            "–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.");
                    } else {
                        user.setState(DialogState.REGISTERED);
                        userStorage.updateUser(user);

                        return createMessage(chatId,
                            "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                            "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n" +
                            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–≥—Ä—É–ø–ø–∞/–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç/–∫—É—Ä—Å).");
                    }

                } catch (bot.user.exception.ScheduleFetchException sfe) {

                    String errMsg = sfe.getMessage();
                    if (sfe.getMessage() == null) {
                        errMsg = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.";
                    } 
                    String lower = errMsg.toLowerCase();
                    String hint = "";

                    if (lower.contains("–≥—Ä—É–ø–ø–∞")) {
                        hint = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–ì—Ä—É–ø–ø–∞¬ª.";
                    } 
                    else if (lower.contains("–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç")) {
                        hint = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç¬ª.";
                    } 
                    else if (lower.contains("–∫—É—Ä—Å")) {
                        hint = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–ö—É—Ä—Å¬ª.";
                    } 
                    else if (lower.contains("—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç")) {
                        hint = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç¬ª.";
                    }

                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);

                    return createMessage(chatId,
                        "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                        "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                        "–ò–º—è: " + user.getName() + "\n" +
                        "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                        "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç: " + user.getUniversity() + "\n" +
                        "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                        "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                        "‚ö†Ô∏è –û–¥–Ω–∞–∫–æ: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: " + errMsg + "\n" +
                        hint + " –ï—Å–ª–∏ –≤—ã —É–≤–µ—Ä–µ–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
                } catch (Exception e) {

                    e.printStackTrace();
                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);

                    return createMessage(chatId,
                        "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                        "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.");
                }

                    
            default:
                return createMessage(chatId, "‚ùå‚ùå‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ /start");
            }
        } catch (Exception e) {
            e.printStackTrace();
            return createMessage(chatId, "‚ùå‚ùå‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ");
        }
    }


    // –º–µ—Ç–æ–¥ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã –∏–ª–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã)
    private SendMessage createMessageWithDynamicButtons(long chatId, String text, List<String> options) {
        SendMessage message = new SendMessage(String.valueOf(chatId), text);

        ReplyKeyboardMarkup keyboardMarkup = new ReplyKeyboardMarkup(); // ReplyKeyboardMarkup - –∫–ª–∞—Å—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–≤ tg api)
        keyboardMarkup.setResizeKeyboard(true); // —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–æ–∫ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        keyboardMarkup.setOneTimeKeyboard(true); // –°–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è

        List<KeyboardRow> keyboard = new ArrayList<>(); // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å—Ç—Ä–æ–∫ –∫–Ω–æ–ø–æ–∫

        KeyboardRow currentRow = new KeyboardRow(); // KeyboardRow - –∫–ª–∞—Å—Å –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ 1 —Å—Ç—Ä–æ–∫–∏ –∫–Ω–æ–ø–æ–∫
        for (int i = 0; i < options.size(); i++) { // –ø—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–Ω–æ–ø–∫–∞–º–∏
            currentRow.add(new KeyboardButton(options.get(i))); // –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫—É

            if ((i + 1) % 2 == 0 || i == options.size() - 1) { // –ø–µ—Ä–≤–æ–µ —ç—Ç–æ —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ –∫–∞–∂–¥—ã–µ 2 –∫–Ω–æ–ø–∫–∏ –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞, –∞ –≤—Ç–æ—Ä–æ–µ —ç—Ç–æ –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å 1 –∫–Ω–æ–ø–∫–∞
                keyboard.add(currentRow); // –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ –∫–ª–∞–∏–≤–∏–∞—Ç—É—Ä—É
                currentRow = new KeyboardRow(); // –¥–µ–ª–∞–µ–º –Ω–æ–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            }
        }

        keyboardMarkup.setKeyboard(keyboard); // keyboardMarkup –º–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞ ReplyKeyboardMarkup - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–Ω–æ–ø–æ–∫ (–∏—Ö –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ)
        message.setReplyMarkup(keyboardMarkup);
        return message;
    }

    private SendMessage createMessage(long chatId, String text) { // —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        SendMessage message = new SendMessage();
        message.setChatId(String.valueOf(chatId)); // –ø–µ—Ä–µ–≤–æ–¥–∏–º Id –≤ —á–∏—Å–ª–æ
        message.setText(text);
        return message;
    }


    public boolean isUserInRegistration(long chatId) { // –ø—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        User user = userStorage.getUser(chatId);
        if (user == null) return false;
        DialogState s = user.getState();
        return s == DialogState.ASK_NAME  // –Ø–≤–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
            || s == DialogState.ASK_GROUP
            || s == DialogState.ASK_UNIVERSITY
            || s == DialogState.ASK_DEPARTMENT
            || s == DialogState.ASK_COURSE
            || s == DialogState.ASK_NAME_INVITE
            || s == DialogState.WAITING_BUTTON;
    }


    public boolean isWaitingForButtonResponse(long chatId) { // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ–∂–∏–¥–∞–µ—Ç –ª–∏ –±–æ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∏
        User user = userStorage.getUser(chatId);  
        if (user != null &&  user.getWaitingForButton()) {
            return true;
        } else {
            return false;
        }
    }
}package bot.fsm;

public enum DialogState {

    ASK_NAME, // –∂–¥—ë–º –∏–º—è
    ASK_GROUP, // –∂–¥—ë–º –≥—Ä—É–ø–ø—É
    ASK_UNIVERSITY, // –∂–¥—ë–º —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
    ASK_DEPARTMENT, // –∂–¥—ë–º —Ñ–∞–∫—É–ª—å—Ç–µ—Ç
    ASK_COURSE, // –∂–¥—ë–º –∫—É—Ä—Å
    WAITING_BUTTON, // –∂–¥—ë–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
    REGISTERED,   // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
    
    EDIT_DAY,// –≤—ã–±—Ä–∞–ª–∏ –¥–µ–Ω—å
    EDIT_CHOOSE_ACTION, // –æ–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å
    ASK_LESSON_INDEX, // –∂–¥–µ–º –Ω–æ–º–µ—Ä –ø–∞—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    ASK_SUBJECT, // –∂–¥–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
    ASK_ROOM, // —É–∑–Ω–∞–µ–º –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏
    ASK_TIME_BEGIN, // —É–∑–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
    ASK_TIME_END, // —É–∑–Ω–∞–µ–º –≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞
    
    ASK_NAME_INVITE,

    ASK_HW_SUBJECT,   // –æ–∂–∏–¥–∞–Ω–∏–µ: –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç (–∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—ã)
    ASK_HW_TIME,      // –æ–∂–∏–¥–∞–Ω–∏–µ: –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É YYYY-MM-DD –∏–ª–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (MONDAY)
    ASK_HW_REMIND,
    ASK_HW_DESCRIPTION, // –∂–¥—ë–º –∏–º—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏–Ω–≤–∞–π—Ç–æ–º

}package bot.fsm;

import bot.commands.AddHomeworkCommand;
import bot.commands.StartCommand;
import bot.commands.EditScheduleCommand;
import bot.commands.InviteHandler; 
import bot.user.User;
import bot.user.UserStorage;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;

public class DialogStateMachine {

    private final UserStorage userStorage;
    private final StartCommand startCommand;
    private final EditScheduleCommand editScheduleCommand;
    private final InviteHandler inviteHandler;
    private final AddHomeworkCommand addHomeworkCommand;


    // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä 
    public DialogStateMachine(UserStorage userStorage, StartCommand startCommand,
                              EditScheduleCommand editScheduleCommand, InviteHandler inviteHandler, AddHomeworkCommand addHomeworkCommand) {
        this.userStorage = userStorage;
        this.startCommand = startCommand;
        this.editScheduleCommand = editScheduleCommand;
        this.inviteHandler = inviteHandler;
        this.addHomeworkCommand = addHomeworkCommand;
    }
    

    public SendMessage handleInput(long chatId, String messageText) {
        // --- –æ–±—Ä–∞–±–æ—Ç–∫–∞ deep-link (invite) –¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–æ–≤–æ–≥–æ –∏–ª–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ) ---
        if (messageText != null && messageText.startsWith("/start ")) {
            SendMessage reply = inviteHandler.tryProcessInvite(chatId, messageText);
            if (reply != null) {
                return reply; // –∏–Ω–≤–∞–π—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚Äî –≤—ã—Ö–æ–¥–∏–º
            }
        }

        User user = userStorage.getUser(chatId);

        // –ö–æ–º–∞–Ω–¥–∞ /start –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ
        if (messageText != null && messageText.equalsIgnoreCase("/start")) {
            return startCommand.processStart(chatId);
        }


        if (user.getWaitingForButton() && messageText != null) {
            return startCommand.processButtonResponse(chatId, messageText);
        }
        
        
        if (user.getState() == bot.fsm.DialogState.ASK_NAME_INVITE) {
            return startCommand.processRegistration(chatId, messageText);
        }
        

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (state != REGISTERED) ‚Äî –Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ StartCommand.processRegistration
        if (startCommand.isUserInRegistration(chatId)) {
            return startCommand.processRegistration(chatId, messageText);
        }

        // –ö–æ–º–∞–Ω–¥–∞ /editschedule (–Ω–∞—á–∞–ª–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        if (messageText != null && messageText.toLowerCase().startsWith("/editschedule")) {
            String[] args = messageText.split("\\s+");
            return editScheduleCommand.processChange(chatId, args);
        }

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ EditScheduleCommand.processEdit
        switch (user.getState()) {
            case EDIT_CHOOSE_ACTION:
            case ASK_SUBJECT:
            case ASK_ROOM:
            case ASK_TIME_BEGIN:
            case ASK_TIME_END:
            case ASK_LESSON_INDEX:
                return editScheduleCommand.processEdit(chatId, messageText);

            case ASK_HW_SUBJECT:
            case ASK_HW_TIME:
            case ASK_HW_DESCRIPTION:
            case ASK_HW_REMIND: {
                // –î–æ–ø. –∑–∞—â–∏—Ç–∞: –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å (–Ω–∞ —Å–ª—É—á–∞–π —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
                if (user.getState() != DialogState.REGISTERED
                        && !(user.getState() == DialogState.ASK_HW_SUBJECT
                        || user.getState() == DialogState.ASK_HW_TIME
                        || user.getState() == DialogState.ASK_HW_DESCRIPTION
                        || user.getState() == DialogState.ASK_HW_REMIND)) {
                    return sendSimple(chatId, "‚ùå –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è –≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start.");
                }
                String reply = addHomeworkCommand.handleStateMessage(chatId, messageText);
                return new SendMessage(String.valueOf(chatId), reply);
            }
            case REGISTERED:
            default:
                return sendSimple(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥");
        }
    }

    private SendMessage sendSimple(long chatId, String text) {
        return new SendMessage(String.valueOf(chatId), text);
    }
}
package bot.homework;

import java.time.LocalDate;

// –ö–ª–∞—Å—Å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

public class HomeworkItem {
    
    private long id;  // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ –≤ –±–¥ (—á—Ç–æ–±—ã –Ω—É–º–µ—Ä–æ–≤–∞—Ç—å –¥–∑ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –æ–¥–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É)
    private long chatId;
    private String subject; // –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
    private String description; // —Å–∞–º–æ –¥–∑
    private LocalDate dueDate; // –¥–∞—Ç–∞, –∫ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
    private boolean completed; // —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 
    private int remindBeforeDays; // –∑–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ —Å–¥–∞—á–∏ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–µ–¥–ª–∞–π–Ω–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–µ–Ω—å)


    public HomeworkItem(long id, long chatId, String subject, String description,
                        LocalDate dueDate, boolean completed, int remindBeforeDays) {
        this.id = id;
        this.chatId = chatId;
        this.subject = subject;
        this.description = description;
        this.dueDate = dueDate;
        this.completed = completed;
        this.remindBeforeDays = remindBeforeDays;
    }


    public long getId() {
    	return id; 
    	} 
    
    public long getChatId() { 
    	return chatId; 
    	} 
    
    public String getSubject() { 
    	return subject; 
    	} 
    
    public String getDescription() { 
    	return description;
    	} 
    
    public LocalDate getDueDate() { 
    	return dueDate; 
    	}
    public boolean isCompleted() { 
    	return completed;
    	} 
    public int getRemindBeforeDays() { 
    	return remindBeforeDays; 
    	} 

    public void setSubject(String subject) {
    	this.subject = subject;
    	} 
    
    public void setDescription(String description) { 
    	this.description = description; 
    	} 
    
    public void setDueDate(LocalDate dueDate) {
    	this.dueDate = dueDate;
    	} 
    public void setCompleted(boolean completed) {
    	this.completed = completed; 
    	}
    public void setRemindBeforeDays(int remindBeforeDays) { 
    	this.remindBeforeDays = remindBeforeDays;
    	} 


    @Override
    public String toString() {
        return String.format(
            "[%s] %s ‚Äî %s (–¥–æ %s)%s",
            subject, // –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
            description, // —Å–∞–º–æ –∑–∞–¥–∞–Ω–∏–µ
            completed ? "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ" : "‚è≥ –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ", // —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            dueDate, // –¥–∞—Ç–∞ –¥–µ–¥–ª–∞–π–Ω–∞
            remindBeforeDays > 0 ? " üîî –ù–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞ " + remindBeforeDays + " –¥–Ω." : "" // –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ‚Äî –≤—ã–≤–µ—Å—Ç–∏
        );
    }
}
package bot.homework;

import java.sql.*;
import java.time.LocalDate;

public class HomeworkLinkStorage { // —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–≤—è–∑—å

    private static final String DB_URL = "jdbc:sqlite:homework.db";

    public HomeworkLinkStorage() {
        init();
    }

    private void init() {
        String sql = "CREATE TABLE IF NOT EXISTS homework_link (" +
                "homework_id INTEGER PRIMARY KEY, " +
                "schedule_day TEXT, " +
                "lesson_index INTEGER)";
        try (Connection c = DriverManager.getConnection(DB_URL); Statement st = c.createStatement()) {
            st.execute(sql);
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    public void linkLatestHomeworkByUserSubjectDate(long userId, String subject, LocalDate dueDate,
                                                    String scheduleDay, Integer lessonIndex) throws SQLException {
        String find = "SELECT id FROM homework WHERE user_id = ? AND subject = ? AND due_date = ? ORDER BY id DESC LIMIT 1"; //–ø–æ–∏—Å–∫ –¥–∑
        try (Connection connection = DriverManager.getConnection(DB_URL);
             PreparedStatement ps = connection.prepareStatement(find)) { //–¥–µ–ª–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å
            ps.setLong(1, userId);
            ps.setString(2, subject);
            ps.setString(3, dueDate != null ? dueDate.toString() : null);
            try (ResultSet result = ps.executeQuery()) { //–æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É –¥–∑ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º, –∑–¥–µ—Å—å –ø–æ–ª—É—á–∞–µ–º –µ—ë ID
                if (result.next()) { //–µ—Å–ª–∏ –¥–∑ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ
                    long hwId = result.getLong("id");
                    String upsert = "INSERT OR REPLACE INTO homework_link(homework_id, schedule_day, lesson_index) VALUES (?, ?, ?)"; //–≤—Å—Ç–∞–≤–∫–∞ –∏–ª–∏ –∑–∞–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü—ã
                    try (PreparedStatement ps2 = connection.prepareStatement(upsert)) { //–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                        ps2.setLong(1, hwId);
                        ps2.setString(2, scheduleDay);
                        if (lessonIndex == null) ps2.setNull(3, Types.INTEGER);
                        else ps2.setInt(3, lessonIndex);
                        ps2.executeUpdate();
                    }
                }
            }
        }
    }
}
package bot.homework;

import java.sql.*;
import java.time.LocalDate;

public class HomeworkService { //–¥–æ–±–∞–≤–ª—è–µ—Ç –¥–∑ –≤ –ë–î –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ID

    private static final String DB_URL = "jdbc:sqlite:homework.db";
    private final SQLiteHomeworkStorage delegate;

    public HomeworkService(SQLiteHomeworkStorage delegate) {
        this.delegate = delegate;
    }

    public long addHomeworkAndReturnId(long chatId, String subject, String description, LocalDate dueDate, int remindBeforeDays) throws SQLException {
        delegate.addHomework(chatId, subject, description, dueDate, remindBeforeDays);

        String sql = "SELECT id FROM homework WHERE chatId = ? AND subject = ? AND dueDate = ? ORDER BY id DESC LIMIT 1";
        try (Connection conn = DriverManager.getConnection(DB_URL);
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setLong(1, chatId);
            ps.setString(2, subject);
            ps.setString(3, dueDate != null ? dueDate.toString() : null);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return rs.getLong("id");
                } else {
                    return -1L;
                }
            }
        }
    }
}
package bot.homework;

import java.time.LocalDate;
import java.util.List;


public interface HomeworkStorage {

    void initialize();
	
    void addHomework(long chatId, String subject, String description, LocalDate dueDate, int remindBeforeDays); // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ

    List<HomeworkItem> getHomeworkByUser(long chatId); // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    List<HomeworkItem> getHomeworkBySubject(long chatId, String subject); // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É 

    void updateHomework(long id, String newSubject, String newDescription, LocalDate newDueDate); // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ (–æ–ø–∏—Å–∞–Ω–∏–µ, –¥–∞—Ç—É –∏ –ø—Ä–µ–¥–º–µ—Ç) 

    void markAsCompleted(long id, boolean completed); // –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –∏–ª–∏ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ 

    void deleteHomework(long id);  // –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ ID 
 
    void deleteOldHomework(LocalDate date); // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è (—Å –ø—Ä–æ—à–µ–¥—à–µ–π –¥–∞—Ç–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

    void deleteAllHomeworkForUser(long chatId);  // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 
    
    List<HomeworkItem> getActiveHomeworkBySubjects(long chatId, List<String> subjects); // –¥–ª—è –≤–µ—á–µ—Ä–Ω–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏ (—Å–æ–±–∏—Ä–∞–µ—Ç –¥–∑ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å)
    
    List<HomeworkItem> getHomeworkWithCustomDeadline(long chatId, List<String> excludedSubjects, LocalDate date); // –¥–ª—è –≤–µ—á–µ—Ä–Ω–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏ (—Å–æ–±–∏—Ä–∞–µ—Ç –¥–∑, –¥–µ–¥–∞–ª–π–Ω –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏–ª)

}
package bot.homework;

import java.sql.*;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import bot.user.exception.ScheduleStorageException; 

public class SQLiteHomeworkStorage implements HomeworkStorage {

	private final String dbUrl = "jdbc:sqlite:homework.db"; // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    private Connection connection;
    
    
    @Override
    public void initialize() {
        try {
            connection = DriverManager.getConnection(dbUrl);

            // SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π
            String sql = "CREATE TABLE IF NOT EXISTS homework (" +
                         "id INTEGER PRIMARY KEY AUTOINCREMENT, " + // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
                         "chatId INTEGER NOT NULL, " +  // id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (chatId)
                         "subject TEXT NOT NULL, " + // –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
                         "description TEXT NOT NULL, " + // —Ç–µ–∫—Å—Ç –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
                         "dueDate TEXT NOT NULL, " +  // –¥–∞—Ç–∞ –¥–µ–¥–ª–∞–π–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                         "completed INTEGER DEFAULT 0, " +  // —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 
                         "remindBeforeDays INTEGER DEFAULT 1" + // –∑–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
                         ")";
            
            Statement statement = connection.createStatement();
            statement.execute(sql);
            statement.close();

        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π", e);
        }
    }


    @Override
    public void addHomework(long chatId, String subject, String description, LocalDate dueDate, int remindBeforeDays) {
        try {
            String sql = "INSERT INTO homework (chatId, subject, description, dueDate, completed, remindBeforeDays) " +
                         "VALUES (?, ?, ?, ?, 0, ?)";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setLong(1, chatId);
            pstatment.setString(2, subject);
            pstatment.setString(3, description);
            pstatment.setString(4, dueDate.toString());
            pstatment.setInt(5, remindBeforeDays);
            pstatment.executeUpdate();
            pstatment.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è", e);
        }
    }


    @Override
    public List<HomeworkItem> getHomeworkByUser(long chatId) {
        List<HomeworkItem> homeworkList = new ArrayList<>();
        try {
            String sql = "SELECT * FROM homework WHERE chatId = ? ORDER BY dueDate";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setLong(1, chatId);
            ResultSet result = pstatment.executeQuery();

            // –ø—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Å—Ç—Ä–æ–∫–∞–º
            while (result.next()) {
                homeworkList.add(mapToHomeworkItem(result)); // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –ë–î –≤ –æ–±—ä–µ–∫—Ç HomeworkItem
            }

            result.close();
            pstatment.close();
            return homeworkList;
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }


    @Override
    public List<HomeworkItem> getHomeworkBySubject(long chatId, String subject) { // –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É.
        List<HomeworkItem> homeworkList = new ArrayList<>();
        try {
            String sql = "SELECT * FROM homework WHERE chatId = ? AND subject = ? ORDER BY dueDate";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setLong(1, chatId);
            pstatment.setString(2, subject);
            ResultSet result = pstatment.executeQuery();

            while (result.next()) {
                homeworkList.add(mapToHomeworkItem(result));
            }

            result.close();
            pstatment.close();
            return homeworkList;
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É", e);
        }
    }

    
    @Override
    public List<HomeworkItem> getActiveHomeworkBySubjects(long chatId, List<String> subjects) {
        List<HomeworkItem> homeworkList = new ArrayList<>();
        if (subjects == null || subjects.isEmpty()) {
        	return homeworkList;
        }

        try {
            String placeholders = String.join(",", subjects.stream().map(s -> "?").toList());
            String sql = "SELECT * FROM homework WHERE chatId = ? AND subject IN (" + placeholders + ") " +
                         "AND completed = 0 AND dueDate >= ?";

            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setLong(1, chatId);

            int index = 2;
            for (String subj : subjects) {
            	pstatement.setString(index++, subj);
            }

            pstatement.setString(index, LocalDate.now().toString());

            ResultSet result = pstatement.executeQuery();
            while (result.next()) {
                homeworkList.add(mapToHomeworkItem(result));
            }

            result.close();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º", e);
        }

        return homeworkList;
    }
    
    
    @Override
    public List<HomeworkItem> getHomeworkWithCustomDeadline(long chatId, List<String> excludedSubjects, LocalDate date) {
    	// excludedSubjects ‚Äî —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞)
        List<HomeworkItem> homeworkList = new ArrayList<>();

        try {
            StringBuilder sql = new StringBuilder("SELECT * FROM homework WHERE chatId = ? AND completed = 0 AND dueDate = ?");
            
            if (excludedSubjects != null && !excludedSubjects.isEmpty()) {
            	// s -> "?" ‚Äî —ç—Ç–æ –ª—è–º–±–¥–∞-–≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ s –≤–µ—Ä–Ω—É—Ç—å –≤–æ–ø—Ä–æ—Å–∏–∫
                String placeholders = String.join(",", excludedSubjects.stream().map(s -> "?").toList()); // –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ "?, ?, ?, ?" ‚Äî –ø–æ —á–∏—Å–ª—É –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                sql.append(" AND subject NOT IN (").append(placeholders).append(")"); // –î–æ–±–∞–≤–ª—è–µ–º –≤ SQL —É—Å–ª–æ–≤–∏–µ: AND subject NOT IN (?, ?, ?)
            }

            PreparedStatement pstatement = connection.prepareStatement(sql.toString());
            pstatement.setLong(1, chatId);
            pstatement.setString(2, date.toString());

            int index = 3;
            if (excludedSubjects != null && !excludedSubjects.isEmpty()) {
                for (String subj : excludedSubjects) {
                	pstatement.setString(index++, subj);
                }
            }

            ResultSet result = pstatement.executeQuery();
            while (result.next()) {
                homeworkList.add(mapToHomeworkItem(result));
            }

            result.close();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤", e);
        }

        return homeworkList;
    }



    @Override
    public void updateHomework(long id, String newSubject, String newDescription, LocalDate newDueDate) { // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–∑
        try {
            String sql = "UPDATE homework SET subject = ?, description = ?, dueDate = ? WHERE id = ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setString(1, newSubject);
            pstatement.setString(2, newDescription);
            pstatement.setString(3, newDueDate.toString());
            pstatement.setLong(4, id);
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è", e);
        }
    }


    
    @Override
    public void markAsCompleted(long id, boolean completed) { // –ø–æ–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ, –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ (–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç —Ç–æ–∂–µ –º–æ–∂–Ω–æ)
        try {
            String sql = "UPDATE homework SET completed = ? WHERE id = ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setInt(1, completed ? 1 : 0); // –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ —Ç—Ä—É, –∑–∞–ø–∏—Å–∞–ª–∏ 1, –µ—Å–ª–∏ —Ñ–æ–ª—Å, –∑–∞–ø–∏—Å–∞–ª–∏ 0
            pstatement.setLong(2, id);
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó", e);
        }
    }



    @Override
    public void deleteHomework(long id) { // —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å –¥–∑ 
        try {
            String sql = "DELETE FROM homework WHERE id = ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setLong(1, id);
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è", e);
        }
    }


    @Override
    public void deleteOldHomework(LocalDate date) { // —É–¥–∞–ª–∏—Ç—å –¥–∑, —É –∫–æ—Ç–æ—Ä—ã—Ö –¥–µ–¥–ª–∞–π–Ω –ø—Ä–æ—à–µ–ª
        try {
            String sql = "DELETE FROM homework WHERE dueDate < ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setString(1, date.toString());
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π", e);
        }
    }


    @Override
    public void deleteAllHomeworkForUser(long chatId) { // —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try {
            String sql = "DELETE FROM homework WHERE chatId = ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setLong(1, chatId);
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }


    public void close() {
        try {
            if (connection != null) connection.close();
        } catch (SQLException ignored) {}
    }


    private HomeworkItem mapToHomeworkItem(ResultSet rs) throws SQLException { // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ ResultSet –≤ –æ–±—ä–µ–∫—Ç HomeworkItem
        return new HomeworkItem(
            rs.getLong("id"), // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è
            rs.getLong("chatId"), // id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            rs.getString("subject"), // –ø—Ä–µ–¥–º–µ—Ç
            rs.getString("description"), // —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è
            LocalDate.parse(rs.getString("dueDate")), // –¥–µ–¥–ª–∞–π–Ω (–ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ LocalDate)
            rs.getInt("completed") == 1, // —Å—Ç–∞—Ç—É—Å (1 ‚Äî true, 0 ‚Äî false)
            rs.getInt("remindBeforeDays") // –∑–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å
        );
    }
}
package bot.schedule;

import java.time.LocalTime;

public class Lesson {
    private String subject; // –ø—Ä–µ–¥–º–µ—Ç
    private LocalTime startTime; // –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
    private LocalTime endTime; // –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
    private String classroom; // –∞—É–¥–∏—Ç–æ—Ä–∏—è

    public Lesson(String subject, LocalTime startTime, LocalTime endTime, String classroom) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
        this.subject = subject;
        this.startTime = startTime;
        this.endTime = endTime;
        this.classroom = classroom;
    }

    public String getSubject() { 
    	return subject; 
    	}
    
    public LocalTime getStartTime() { 
    	return startTime; 
    	}
    
    public LocalTime getEndTime() {
    	return endTime;
    	}
    
    public String getClassroom() {
    	return classroom; 
    	}


    public void setSubject(String subject) { 
    	this.subject = subject; 
    	}
   
    public void setStartTime(LocalTime startTime) { 
    	this.startTime = startTime; 
    	}
    
    public void setEndTime(LocalTime endTime) { 
    	this.endTime = endTime; 
    	}
    
    public void setClassroom(String classroom) { 
    	this.classroom = classroom; 
    	}
}





package bot.schedule;

import java.util.*;

public class Schedule {
    private String groupId; // –∞–π–¥–∏ –≥—Ä—É–ø–ø—ã
    private String groupName;
    private Map<String, List<Lesson>> weeklySchedule; // –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ -> —Å–ø–∏—Å–æ–∫ –ø–∞—Ä

    public Schedule(String groupId, String groupName) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (–¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å –ø—É—Å—Ç–æ–π –º–∞–ø–æ–π)
        this.groupId = groupId;
        this.groupName = groupName;
        this.weeklySchedule = new HashMap<>();
    }

    public void addLesson(String dayOfWeek, Lesson lesson) {
        if (!weeklySchedule.containsKey(dayOfWeek)) { // –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–ø–∏—Å–∫–∞ –µ—â–µ –Ω–µ—Ç
            List<Lesson> lessonsForDay = new ArrayList<>(); // —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
            weeklySchedule.put(dayOfWeek, lessonsForDay); // –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—É –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ
        }
        
        List<Lesson> lessonsForDay = weeklySchedule.get(dayOfWeek);
        
        lessonsForDay.add(lesson); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–∞—Ä—É –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫
    }

    public List<Lesson> getLessonsForDay(String dayOfWeek) { // –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å
        return weeklySchedule.getOrDefault(dayOfWeek, new ArrayList<>());
    }


    public String getGroupId() { 
    	return groupId; 
    	}
    
    public String getGroupName() { 
    	return groupName;
    	}
    
    public Map<String, List<Lesson>> getWeeklySchedule() { 
    	return weeklySchedule; 
    	}


    public void setGroupId(String groupId) { 
    	this.groupId = groupId; 
    	}
    
    public void setGroupName(String groupName) { 
    	this.groupName = groupName;
    	}
    
    public void setWeeklySchedule(Map<String, List<Lesson>> weeklySchedule) { 
    	this.weeklySchedule = weeklySchedule; 
    	}
    
    
    
    
    
}package bot.schedule;

import bot.user.exception.ScheduleFetchException;
import bot.user.User;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.time.DayOfWeek;
import java.time.LocalDate; // –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–∞—Ç—ã
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;


public class ScheduleFetcher {

    private static final String DIVISIONS_URL = "https://urfu.ru/api/v2/schedule/divisions"; // –∞–¥—Ä–µ—Å –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    private static final DateTimeFormatter DATE_FORMAT = DateTimeFormatter.ISO_LOCAL_DATE; // –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç

    private final UrfuApiClient httpClient;
    private final ObjectMapper jsonMapper; // Jackson-–æ–±—ä–µ–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è JSON

    public ScheduleFetcher() { // –∫–æ–Ω—Å—Ç—Ä—É—Ç–æ—Ä 
        this.httpClient = new UrfuApiClient(); // –∫–ª–∏–µ–Ω—Ç –¥–ª—è http –∑–∞–ø—Ä–æ—Å–æ–≤
        this.jsonMapper = new ObjectMapper(); // –ø–∞—Ä—Å–µ—Ä json
    }

    
    
    public Schedule fetchForUser(User user) throws ScheduleFetchException { // –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        try {
            String instituteName = nullSafeTrim(user.getUniversity());
            String departmentName = nullSafeTrim(user.getDepartment());
            String groupName = nullSafeTrim(user.getGroup());
            int courseNumber = parseCourse(user.getCourse());
            
            // 1) –¥–µ–ª–∞–µ–º –º–∞—Å—Å–∏–≤ json –æ–±—ä–µ–∫—Ç–æ–≤
            String divisionsJson = httpClient.get(DIVISIONS_URL); // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É - —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ http –∑–∞–ø—Ä–æ—Å
            JsonNode divisionsArray = jsonMapper.readTree(divisionsJson); // –¥–∂–µ–∫—Å–æ–Ω –ø–∞—Ä—Å–∏—Ç –≤ json –æ–±—ä–µ–∫—Ç—ã –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π

            // 2) –ù–∞—Ö–æ–¥–∏–º –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç
            long departmentId = findDepartmentId(divisionsArray, instituteName, departmentName);
            if (departmentId == -1L) {
                long instituteId = findInstituteId(divisionsArray, instituteName);
                if (instituteId != -1L) {
                    // –µ—Å–ª–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º –∏–Ω—Å—Ç–∏—Ç—É—Ç
                    departmentId = instituteId;
                } else {
                    throw new ScheduleFetchException("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∏–ª–∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç.");
                }
            }

            // 3) –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—ã –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
            String groupsUrl = String.format("https://urfu.ru/api/v2/schedule/divisions/%d/groups?course=%d", departmentId, courseNumber);
            String groupsJson = httpClient.get(groupsUrl);
            JsonNode groupsArray = jsonMapper.readTree(groupsJson);

            long groupId = findGroupId(groupsArray, groupName);
            if (groupId == -1L) {
                throw new ScheduleFetchException("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É.");
            }

            // 4) –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
            LocalDate today = LocalDate.now(ZoneId.of("Asia/Yekaterinburg"));
            LocalDate monday = today.with(DayOfWeek.MONDAY); // –Ω–∞—Ö–æ–¥–∏–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
            LocalDate sunday = monday.plusDays(6); // –¥–æ–±–∞–≤–ª—è–µ–º 6 –¥–Ω–µ–π, –ø–æ–ª—É—á–∞–µ—Ç—Å—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ

            // 5) –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            String scheduleUrl = String.format(
                    "https://urfu.ru/api/v2/schedule/groups/%d/schedule?date_gte=%s&date_lte=%s",
                    groupId,
                    monday.format(DATE_FORMAT),
                    sunday.format(DATE_FORMAT)
            );

            String scheduleJson = httpClient.get(scheduleUrl);
            JsonNode scheduleRoot = jsonMapper.readTree(scheduleJson);
            
            JsonNode eventsNode;
            if (scheduleRoot.has("events")) { // –µ—Å–ª–∏ –≤ JSON –µ—Å—Ç—å –ø–æ–ª–µ events ‚Äî –±–µ—Ä—ë–º –∏–º–µ–Ω–Ω–æ –µ–≥–æ
                eventsNode = scheduleRoot.get("events");
            } else {
                eventsNode = scheduleRoot; // –µ—Å–ª–∏ –ø–æ–ª—è events –Ω–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, —Å–∞–º –∫–æ—Ä–µ–Ω—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º –∑–∞–Ω—è—Ç–∏–π
            }
            
            
            if (eventsNode == null || !eventsNode.isArray()) {
                throw new ScheduleFetchException("–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.");
            }

            // 6) –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            Schedule resultSchedule = new Schedule(String.valueOf(groupId), groupName);

            for (JsonNode eventNode : eventsNode) {
                String dateText = firstNonNullText(eventNode, "date", "lesson_date", "lessonDate");
                String timeBeginText = firstNonNullText(eventNode, "timeBegin", "time_begin", "timeStart", "time_start");
                String timeEndText = firstNonNullText(eventNode, "timeEnd", "time_end");
                String subjectText = firstNonNullText(eventNode, "title", "discipline", "name");
                String classroomText = firstNonNullText(eventNode, "auditoryTitle", "auditoryLocation", "auditorium");

                if (dateText == null || subjectText == null) { // –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ - —Å–∫–∏–ø
                	continue;
                }

                LocalTime startTime = parseTimeOrNull(timeBeginText);
                LocalTime endTime = parseTimeOrNull(timeEndText);
                LocalDate lessonDate = LocalDate.parse(dateText, DATE_FORMAT);

                if (classroomText == null) {
                    classroomText = "";
                }
                
                Lesson lesson = new Lesson(subjectText, startTime, endTime, classroomText);
                resultSchedule.addLesson(lessonDate.getDayOfWeek().toString(), lesson);
            }

            return resultSchedule;

        } catch (ScheduleFetchException e) {
            throw e;
        } catch (Exception e) {
            throw new ScheduleFetchException("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.");
        }
    }

    
    private long findInstituteId(JsonNode divisionsArray, String instituteName) {
        if (instituteName == null || instituteName.isEmpty()) {
            return -1L;
        }

        String normalizedInstitute = normalize(instituteName);

        // –ø–æ –ø—Ä—è–º–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
        for (JsonNode node : divisionsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && title.toLowerCase().contains(instituteName.toLowerCase())) {
                return node.path("id").asLong(-1);
            }
        }

        // –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
        for (JsonNode node : divisionsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && normalize(title).contains(normalizedInstitute)) {
                return node.path("id").asLong(-1);
            }
        }

        return -1L;
    }

    

    private long findDepartmentId(JsonNode divisionsArray, String instituteName, String departmentName) {
        String normalizedInstitute = normalize(instituteName); // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ 
        String normalizedDepartment = normalize(departmentName);

        Long instituteId = null;
        if (instituteName != null && !instituteName.isEmpty()) { // —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞—Ç—å –ø–æ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–µ
            for (JsonNode node : divisionsArray) {
                String title = firstNonNullText(node, "title", "name");
                if (title != null && title.toLowerCase().contains(instituteName.toLowerCase())) {
                    instituteId = node.path("id").asLong(-1);
                    break;
                }
            }
            // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ‚Äî –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é, –µ—Å–ª–∏ –ø—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
            if (instituteId == null || instituteId == -1) {
                for (JsonNode node : divisionsArray) {
                    String title = firstNonNullText(node, "title", "name");
                    if (title != null && normalize(title).contains(normalizedInstitute)) {
                        instituteId = node.path("id").asLong(-1);
                        break;
                    }
                }
            }
        }

        List<JsonNode> searchArea = new ArrayList<>(); // —Å–ø–∏—Å–æ–∫ –∏–∑ json node –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å–∫–∞—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –±—É–¥–µ–º
        if (instituteId != null && instituteId != -1) {
            for (JsonNode node : divisionsArray) {
                if (node.path("parentId").asLong(-1) == instituteId) { // –±–µ—Ä–µ–º —É–∑–ª—ã, –≥–¥–µ parentId —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∞–π–¥–∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞
                    searchArea.add(node);
                }
            }
        } else {
            // –ï—Å–ª–∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∏—â–µ–º —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–∞
            for (JsonNode node : divisionsArray) { 
                searchArea.add(node);
            }
        }

        // –ï—Å–ª–∏ departmentName –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –Ω–µ –∏—Å–∫–∞—Ç—å –ø–æ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–µ (–∏–Ω–∞—á–µ —Å–æ–≤–ø–∞–¥–µ—Ç —Å –ª—é–±—ã–º title)
        if (departmentName == null || departmentName.isEmpty()) {
            return -1L;
        }

        // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –ø—Ä—è–º–æ–º—É –≤—Ö–æ–∂–¥–µ–Ω–∏—é
        for (JsonNode node : searchArea) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && title.toLowerCase().contains(departmentName.toLowerCase())) {
                return node.path("id").asLong(-1); // –≤–µ—Ä–Ω–µ–º –∞–π–¥–∏ –Ω—É–∂–Ω–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
            }
        }

        // –ü–æ—Ç–æ–º –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
        for (JsonNode node : searchArea) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && normalize(title).contains(normalizedDepartment)) {
                return node.path("id").asLong(-1); // –≤–µ—Ä–Ω–µ–º –∞–π–¥–∏ –Ω—É–∂–Ω–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
            }
        }

        return -1L;
    }


    
    private long findGroupId(JsonNode groupsArray, String groupName) {
        if (groupName == null || groupName.isEmpty()) {
        	return -1L;
        }
        String normalizedGroup = normalize(groupName);
        for (JsonNode node : groupsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && title.toLowerCase().contains(groupName.toLowerCase())) {
                return node.path("id").asLong(-1);
            }
        }
        for (JsonNode node : groupsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && normalize(title).contains(normalizedGroup)) {
                return node.path("id").asLong(-1);
            }
        }

        String groupWithoutHyphen = groupName.replace("-", "").toLowerCase();
        for (JsonNode node : groupsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && title.toLowerCase().replace("-", "").contains(groupWithoutHyphen)) {
                return node.path("id").asLong(-1);
            }
        }
        return -1L;
    }


    
    private static String firstNonNullText(JsonNode node, String... keys) { // –ø—Ä–∏–Ω–∏–º–∞–µ—Ç json node –∏ —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∫–ª—é—á–µ–π
        if (node == null) {
        	return null;
        }
        for (String key : keys) {
            if (node.has(key) && !node.get(key).isNull()) { // –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤ json node –µ—Å—Ç—å –ø–æ–ª–µ —Å –¥–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º –∏ –æ–Ω–æ –Ω–µ –ø—É—Å—Ç–æ–µ
                return node.get(key).asText(); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (asText –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ —Å—Ç—Ä–æ–∫—É)
            }
        }
        return null;
    }

    
    private static LocalTime parseTimeOrNull(String text) {
        if (text == null || text.isEmpty()) { // –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        	return null;
        }
        try {
            return LocalTime.parse(text.trim()); // –º–µ—Ç–æ–¥ –∏–∑ –ø–∞–∫–µ—Ç–∞ java.time, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ –æ–±—ä–µ–∫—Ç –≤—Ä–µ–º–µ–Ω–∏
        } catch (Exception e) {
            return null;
        }
    }

    
    private static int parseCourse(String courseText) { // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–º–µ—Ä –∫—É—Ä—Å–∞ –≤ –≤–∏–¥–µ –∏–Ω—Ç 
        if (courseText == null) {
        	return 0;
        }
        try {
            return Integer.parseInt(courseText.trim());
        } catch (Exception e) {
            return 0;
        }
    }

    
    private static String nullSafeTrim(String s) { // —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏
        if (s == null) {
        	return null;
        }
        String trimmed = s.trim();
        
        if (trimmed.isEmpty()) { // –µ—Å–ª–∏ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è
        	return null ;
        } else {
        	return trimmed;
        }
        
    }

    
    private static String normalize(String s) { // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        if (s == null) {
        	return "";
        }
        return s.toLowerCase() // –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
                .replaceAll("[^\\p{Alnum}\\s]", " ") // –∑–∞–º–µ–Ω—è–µ—Ç –≤—Å—ë, —á—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –±—É–∫–≤–∞–º–∏, —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ –ø—Ä–æ–±–µ–ª–æ–º, –Ω–∞ –ø—Ä–æ–±–µ–ª
                .replaceAll("\\s+", " ") // —Å–∂–∏–º–∞–µ—Ç –≤—Å–µ –∏–¥—É—â–∏–µ –ø–æ–¥—Ä—è–¥ –ø—Ä–æ–±–µ–ª—ã –≤ –æ–¥–∏–Ω
                .trim(); // —É–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã —Å –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏
    }
    
    
    private static String removeSpaces(String s) { // –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—É—Å—Ç–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
        if (s == null) {
            return null;
        }
        String trimmed = s.trim();

        // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª "-" –∏–ª–∏ "‚Äî" –∏–ª–∏ "–Ω–µ—Ç", —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –Ω–µ—Ç
        if (trimmed.isEmpty() || trimmed.equals("-") || trimmed.equals("‚Äî") || trimmed.equalsIgnoreCase("–Ω–µ—Ç")) {
            return null;
        }

        return trimmed;
    }

}


package bot.schedule;

import bot.user.exception.UserNotFoundException;
import bot.user.User;
import bot.user.UserStorage;

import java.util.Map;
import java.util.List;

public class ScheduleManager {
    private final ScheduleStorage commonStorage;    // –¥–ª—è schedules.db 
    private final ScheduleStorage customStorage;    // –¥–ª—è custom_schedules.db 
    private final UserStorage userStorage;

    public ScheduleManager(UserStorage userStorage) { // –∫–æ–Ω—Å—Ç—Ä—É—Ç–æ—Ä (–¥–µ–ª–∞–µ–º –¥–≤–µ –±–¥ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—Ü–µ–º –∏—Ö)
        this.commonStorage = new SQLiteScheduleStorage("schedules.db");
        this.customStorage = new SQLiteScheduleStorage("custom_schedules.db");
        this.userStorage = userStorage;

        this.commonStorage.initialize();
        this.customStorage.initialize();

        this.commonStorage.technicalMaintenance(200);
    }


    public Schedule getScheduleForUser(long userId) { // –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        User user = userStorage.getUser(userId);
        if (user == null) {
            throw new UserNotFoundException(userId);
        }

        String customGroupId = String.valueOf(userId);

        // –µ—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ customStorage ‚Äî –æ—Ç–¥–∞—ë–º –µ–≥–æ.
        if (customStorage.scheduleExists(customGroupId)) {
            return customStorage.getScheduleByGroupId(customGroupId);
        }

        // –∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã 
        return commonStorage.getScheduleByGroupName(user.getGroup());
    }


    public void saveCustomSchedule(long userId, Schedule schedule) { // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        User user = userStorage.getUser(userId);
        if (user == null) {
            throw new UserNotFoundException(userId);
        }

        // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º schedule –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
        schedule.setGroupId(String.valueOf(userId)); // –ò—Å–ø–æ–ª—å–∑—É–µ–º userId –∫–∞–∫ groupId –≤ –∫–∞—Å—Ç–æ–º–Ω–æ–π –ë–î
        schedule.setGroupName(user.getGroup()); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ –∏–º—è –≥—Ä—É–ø–ø—ã


        if (customStorage.scheduleExists(String.valueOf(userId))) {
            customStorage.updateSchedule(schedule);
        } else {
            customStorage.saveSchedule(schedule);
        }

        // –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç user –≤ –ø–∞–º—è—Ç–∏ —É—Å—Ç–∞—Ä–µ–ª)
        User fresh = userStorage.getUser(userId);
        if (fresh != null) {
            fresh.setHasCustomSchedule(true);
            userStorage.updateUser(fresh);
        } 
    }


    public void resetToOriginalSchedule(long userId) { // —Å–±—Ä–æ—Å–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—â–µ–º—É (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–¥–æ –±—É–¥–µ—Ç)
        User user = userStorage.getUser(userId);
        if (user == null) {
            throw new UserNotFoundException(userId);
        }

        customStorage.deleteSchedule(String.valueOf(userId)); // —É–¥–∞–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

        user.setHasCustomSchedule(false); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
        userStorage.updateUser(user);
    }


    public void copyCommonToCustom(long userId) { // —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –æ–±—â–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ –∫–∞—Å—Ç–æ–º–Ω–æ–µ
        User user = userStorage.getUser(userId);

        if (user == null) {
            throw new UserNotFoundException(userId);
        }

        // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ (–æ–±—â–µ–µ) —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
        Schedule original = commonStorage.getScheduleByGroupName(user.getGroup());
        if (original == null) {
            // –ï—Å–ª–∏ –æ–±—â–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º 
            throw new IllegalStateException("–û–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã '" + user.getGroup() + "' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
        }

        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Schedule –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –ë–î (–Ω–µ –º—É—Ç–∏—Ä—É–µ–º original)
        Schedule copy = new Schedule(String.valueOf(userId), original.getGroupName());
        // –ö–æ–ø–∏—Ä—É–µ–º –ø–∞—Ä—ã 
        for (Map.Entry<String, List<Lesson>> entry : original.getWeeklySchedule().entrySet()) {
            String day = entry.getKey(); // —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
            for (Lesson l : entry.getValue()) { // –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —É—Ä–æ–∫–∏
                // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Lesson, —á—Ç–æ–±—ã –Ω–µ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —Ç–µ –∂–µ –æ–±—ä–µ–∫—Ç—ã
                Lesson lessonCopy = new Lesson(l.getSubject(), l.getStartTime(), l.getEndTime(), l.getClassroom());
                copy.addLesson(day, lessonCopy);
            }
        }

        String customGroupId = String.valueOf(userId);
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤ customStorage 
        if (customStorage.scheduleExists(customGroupId)) {
            customStorage.updateSchedule(copy);
        } else {
            customStorage.saveSchedule(copy);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        User fresh = userStorage.getUser(userId);
        if (fresh != null) {
            fresh.setHasCustomSchedule(true);
            userStorage.updateUser(fresh);
        }
    }


    public void saveCommonSchedule(Schedule schedule) { // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        if (commonStorage.scheduleExists(schedule.getGroupId())) {
            commonStorage.updateSchedule(schedule);
        } else {
            commonStorage.saveSchedule(schedule);
        }
    }
    
    public boolean customScheduleExists(long userId) { // –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        return customStorage.scheduleExists(String.valueOf(userId));
    }

    public void close() {
        commonStorage.close();
        customStorage.close();
    }
}package bot.schedule;

public interface ScheduleStorage {
    
    void initialize();
	
    Schedule getScheduleByGroupId(String groupId); // –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    
    Schedule getScheduleByGroupName(String groupName); // –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
    
    void saveSchedule(Schedule schedule); // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ 
    
    void updateSchedule(Schedule schedule); // –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    
    void deleteSchedule(String groupId); // —É–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –≥—Ä—É–ø–ø–µ
    
    boolean scheduleExists(String groupId); // –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ 
    
    void close();
    
    
    
    String getGroupIdByName(String groupName); // –≤–µ—Ä–Ω—É—Ç—å –∞–π–¥–∏ –≥—Ä—É–ø–ø—ã –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
    
    void saveGroupMapping(String groupName, String groupId); // —Å–æ—Ö—Ä–≤–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É –≤ —Ç–∞–±–ª–∏—Ü—É
    
    boolean groupMappingExists(String groupName); // –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –≥—Ä—É–ø–ø–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ 
     
    void updateMappingTimestamp(String groupName);
    
    void technicalMaintenance(int daysOld);
}package bot.schedule;

import java.sql.*;
import java.time.LocalTime;
import java.util.*;

import bot.user.exception.ScheduleStorageException;

public class SQLiteScheduleStorage implements ScheduleStorage {
    private final String dbUrl;
    private Connection connection;

    public SQLiteScheduleStorage(String dbFileName) { // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å –ø—É—Ç–µ–º –∫ –ë–î (–ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ 2 –±–¥)
        this.dbUrl = "jdbc:sqlite:" + dbFileName;
    }

    
    @Override
    public void initialize() {
        try {
            connection = DriverManager.getConnection(dbUrl); // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–¥
            
            // –¢–∞–±–ª–∏—Ü–∞ mapping (–≥—Ä—É–ø–ø–∞ -> groupId)
            String mappingSql = "CREATE TABLE IF NOT EXISTS group_mapping (" +
                               "groupName TEXT PRIMARY KEY," +
                               "groupId TEXT NOT NULL," +
                               "lastUpdated TIMESTAMP DEFAULT CURRENT_TIMESTAMP" +
                               ")";
            
            // –¢–∞–±–ª–∏—Ü–∞ –≥—Ä—É–ø–ø
            String groupsSql = "CREATE TABLE IF NOT EXISTS groups (" +
                              "groupId TEXT PRIMARY KEY," +
                              "groupName TEXT UNIQUE NOT NULL" +
                              ")";
            
            // –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            String scheduleSql = "CREATE TABLE IF NOT EXISTS schedule_lessons (" +
                                "id INTEGER PRIMARY KEY AUTOINCREMENT," +
                                "groupId TEXT," +
                                "dayOfWeek TEXT NOT NULL," +
                                "subject TEXT NOT NULL," +
                                "startTime TEXT NOT NULL," +
                                "endTime TEXT NOT NULL," +
                                "classroom TEXT," +
                                "FOREIGN KEY (groupId) REFERENCES groups(groupId)" +
                                ")";
            
            Statement statement = connection.createStatement(); // —Å–æ–∑–¥–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ 
            statement.execute(mappingSql); // –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å (—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É)
            statement.execute(groupsSql);
            statement.execute(scheduleSql);
            statement.close();
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: ", e);
        }
    }

    
    @Override
    public String getGroupIdByName(String groupName) {
        try {
            String sql = "SELECT groupId FROM group_mapping WHERE groupName = ?";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupName);
            
            ResultSet result =  pstatment.executeQuery(); // –æ–Ω–æ –≤–µ—Ä–Ω–µ—Ç –∫—É—Ä—Å–æ—Ä –Ω–∞ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏
            if (result.next()) { // –µ—Å–ª–∏ –Ω–∞—à–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç 
                String groupId = result.getString("groupId");
                result.close();
                pstatment.close();
                
                updateMappingTimestamp(groupName);
                
                return groupId;
            }
            result.close();
            pstatment.close();
            return null;
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è groupId –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã: ", e);
        }
    }
    
    
    @Override
    public void saveGroupMapping(String groupName, String groupId) {
        try {
            String sql = "INSERT OR REPLACE INTO group_mapping (groupName, groupId) VALUES (?, ?)";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupName);
            pstatment.setString(2, groupId);
            pstatment.executeUpdate();
            pstatment.close();
            
            updateMappingTimestamp(groupName);
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è mapping –≥—Ä—É–ø–ø—ã: ", e);
        }
    }

    
    @Override
    public boolean groupMappingExists(String groupName) {
        try {
            String sql = "SELECT 1 FROM group_mapping WHERE groupName = ?"; // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º –≥—Ä—É–ø–ø—ã –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–¥
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupName);
            
            ResultSet result = pstatment.executeQuery();
            boolean exists = result.next();
            
            result.close();
            pstatment.close();
            return exists;
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ mapping –≥—Ä—É–ø–ø—ã: ", e);
        }
    }
    
    
    @Override
    public void updateMappingTimestamp(String groupName) {
        try {
            String sql = "UPDATE group_mapping SET lastUpdated = CURRENT_TIMESTAMP WHERE groupName = ?";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupName);
            pstatment.executeUpdate();
            pstatment.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ mapping", e);
        }
    }
    
    
    @Override
    public void technicalMaintenance(int daysOld) {
        try {
            String sql = "DELETE FROM group_mapping WHERE lastUpdated < datetime('now', ?)";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, "-" + daysOld + " days");
            
            int deletedCount = pstatment.executeUpdate();
            pstatment.close();
            
            System.out.println("–£–¥–∞–ª–µ–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö mapping: " + deletedCount);
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö mapping", e);
        }
    }


    @Override
    public Schedule getScheduleByGroupId(String groupId) {
        try {
            String groupSql = "SELECT groupName FROM groups WHERE groupId = ?"; // –≤–µ—Ä–Ω–µ—Ç –∏–º—è –≥—Ä—É–ø–ø—ã, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∞–π–¥–∏
            PreparedStatement pstatment = connection.prepareStatement(groupSql);
            pstatment.setString(1, groupId);
            
            ResultSet result = pstatment.executeQuery();
            if (!result.next()) { // –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            	result.close();
            	pstatment.close();
                return null;
            }
            
            String groupName = result.getString("groupName");
            result.close();
            pstatment.close();

            String lessonsSql = "SELECT dayOfWeek, subject, startTime, endTime, classroom " +
                               "FROM schedule_lessons WHERE groupId = ? ORDER BY dayOfWeek, startTime"; // ORDER BY dayOfWeek, startTime —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ –¥–Ω—é –Ω–µ–¥–µ–ª–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
            
            PreparedStatement lessonsStmt = connection.prepareStatement(lessonsSql);
            lessonsStmt.setString(1, groupId);
            
            ResultSet lessonsResult = lessonsStmt.executeQuery();
            
            Schedule schedule = new Schedule(groupId, groupName);
            
            while (lessonsResult.next()) {
                String dayOfWeek = lessonsResult.getString("dayOfWeek");
                String subject = lessonsResult.getString("subject");
                LocalTime startTime = LocalTime.parse(lessonsResult.getString("startTime")); // –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É –∏ –ø–∞—Ä—Å–∏–º –≤ LocalTime –æ–±—ä–µ–∫—Ç
                LocalTime endTime = LocalTime.parse(lessonsResult.getString("endTime"));
                String classroom = lessonsResult.getString("classroom");
                
                Lesson lesson = new Lesson(subject, startTime, endTime, classroom);
                schedule.addLesson(dayOfWeek, lesson); // –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ä—É –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥ –Ω—É–∂–Ω—ã–º –¥–Ω–µ–º
            }
            
            lessonsResult.close();
            lessonsStmt.close();
            return schedule;
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ ID –≥—Ä—É–ø–ø—ã: ", e);
        }
    }

    
    @Override
    public Schedule getScheduleByGroupName(String groupName) {
        try {
            String groupId = getGroupIdByName(groupName); // –ù–∞—Ö–æ–¥–∏–º groupId —á–µ—Ä–µ–∑ mapping
            if (groupId == null) {
                return null;  // –µ—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            }
            
            return getScheduleByGroupId(groupId);
            
        } catch (Exception e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã: ", e);
        }
    }

    @Override
    public void saveSchedule(Schedule schedule) {
        if (scheduleExists(schedule.getGroupId())) {
            throw new ScheduleStorageException("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        
        try {
            if (!groupMappingExists(schedule.getGroupName())) { // –°–æ—Ö—Ä–∞–Ω—è–µ–º mapping (–µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç)
                saveGroupMapping(schedule.getGroupName(), schedule.getGroupId());
            } else {
                updateMappingTimestamp(schedule.getGroupName()); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ mapping —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥—Ä—É–ø—Å
            String groupSql = "INSERT INTO groups (groupId, groupName) VALUES (?, ?)";
            PreparedStatement groupStmt = connection.prepareStatement(groupSql);
            groupStmt.setString(1, schedule.getGroupId());
            groupStmt.setString(2, schedule.getGroupName());
            groupStmt.executeUpdate();
            groupStmt.close();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä—ã
            String lessonSql = "INSERT INTO schedule_lessons (groupId, dayOfWeek, subject, startTime, endTime, classroom) VALUES (?, ?, ?, ?, ?, ?)";
            PreparedStatement lessonStmt = connection.prepareStatement(lessonSql);
            
            for (Map.Entry<String, List<Lesson>> entry : schedule.getWeeklySchedule().entrySet()) {
                String day = entry.getKey();
                for (Lesson lesson : entry.getValue()) {
                    lessonStmt.setString(1, schedule.getGroupId());
                    lessonStmt.setString(2, day);
                    lessonStmt.setString(3, lesson.getSubject());
                    lessonStmt.setString(4, lesson.getStartTime().toString());
                    lessonStmt.setString(5, lesson.getEndTime().toString());
                    lessonStmt.setString(6, lesson.getClassroom());
                    lessonStmt.addBatch(); // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø–∞—á–∫—É, –Ω–æ –ø–æ–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º
                }
            }
            lessonStmt.executeBatch(); // –≤—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞ —Ä–∞–∑
            lessonStmt.close();
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã", e);
        }
    }

    @Override
    public void updateSchedule(Schedule schedule) {
        if (!scheduleExists(schedule.getGroupId())) {
            throw new ScheduleStorageException("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        
        deleteSchedule(schedule.getGroupId());
        
        saveSchedule(schedule);
    }
    
    
    @Override
    public void deleteSchedule(String groupId) {
        try {
            // –£–¥–∞–ª—è–µ–º –ø–∞—Ä—ã
            String lessonsSql = "DELETE FROM schedule_lessons WHERE groupId = ?";
            PreparedStatement lessonsStmt = connection.prepareStatement(lessonsSql);
            lessonsStmt.setString(1, groupId);
            lessonsStmt.executeUpdate();
            lessonsStmt.close();

            // –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É
            String groupSql = "DELETE FROM groups WHERE groupId = ?";
            PreparedStatement groupStmt = connection.prepareStatement(groupSql);
            groupStmt.setString(1, groupId);
            groupStmt.executeUpdate();
            groupStmt.close();
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã: ", e);
        }
    }
    

    @Override
    public boolean scheduleExists(String groupId) {
        try {
            String sql = "SELECT 1 FROM groups WHERE groupId = ?";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupId);
            
            ResultSet result = pstatment.executeQuery();
            boolean exists = result.next();
            
            result.close();
            pstatment.close();
            
            return exists;
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã: ", e);
        }
    }
    
    
    @Override
    public void close() {
        try {
            if (connection != null) {
                connection.close();
            }
        } catch (SQLException e) {
        }
    }
}package bot.schedule;

import okhttp3.OkHttpClient; // –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ OkHttp –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
import okhttp3.Request;
import okhttp3.Response;
import java.io.IOException;
import java.time.Duration; // –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏

public class UrfuApiClient {
	
    private final OkHttpClient client; // –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è - –∫–ª–∏–µ–Ω—Ç 

    public UrfuApiClient() { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä 
        client = new OkHttpClient.Builder() 
                .connectTimeout(Duration.ofSeconds(20)) // —Ç–∞–π–º–∞—É—Ç –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ—Ç 20 —Å–µ–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è - —Ç–æ –±—Ä–æ—Å–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)
                .readTimeout(Duration.ofSeconds(30)) // –≤—Ä–µ–º—è –Ω–∞ —á—Ç–µ–Ω–∏–µ
                .callTimeout(Duration.ofSeconds(60)) // –æ–±—â–∏–π —Ç–∞–π–º–µ—Ä –Ω–∞ –∑–∞–ø—Ä–æ—Å
                .build(); // –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
    }

    
    public String get(String url) throws IOException {
        Request req = new Request.Builder() // –±–∏–ª–¥–µ—Ä –¥–ª—è http –∑–∞–ø—Ä–æ—Å–∞
                .url(url)
                .header("Accept", "application/json") // –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–≥–æ–≤–æ—Ä–∏—Ç —Å–µ—Ä–≤–µ—Ä—É, —á—Ç–æ –º—ã –∂–¥–µ–º json –≤ –æ—Ç–≤–µ—Ç)
                .build();
        
        // —Å–æ–∑–¥–∞–µ—Ç –≤—ã–∑–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å (response —Å–∞–º –∑–∞–∫—Ä–æ–µ—Ç—Å—è, —Ç–∫ try-with-resources)
        // newCall —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç Call –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
        try (Response resp = client.newCall(req).execute()) { 
            if (!resp.isSuccessful()) { // –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
                throw new IOException();
            }
            
            if(resp.body() == null) {
            	return "";
            	
            } else {
            	return resp.body().string(); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
            }
        }
    }
}
package bot.session;

import java.util.concurrent.ConcurrentHashMap; // –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å (–ø–æ—Ç–æ—á–Ω–æ-–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è map)
import java.util.Map;

public class EditSessionManager {
    private static final Map<Long, Session> sessions = new ConcurrentHashMap<>();

    public static Session getSession(long chatId) {
    	Session session = sessions.get(chatId);
    	if (session == null) {
    	    session = new Session();
    	    sessions.put(chatId, session);
    	}
    	return session;
    }

    public static void clearSession(long chatId) {
        sessions.remove(chatId);
    }
}
package bot.session;

public class Session {
    private String day;
    private Integer lessonIndex;
    private String subject;
    private String room;
    private String timeBegin;
    private String timeEnd;

    // –≥–µ—Ç—Ç–µ—Ä—ã –∏ —Å–µ—Ç—Ç–µ—Ä—ã
    public String getDay() { 
    	return day;
    	}
    
    public void setDay(String day) { 
    	this.day = day;
    	}

    public Integer getLessonIndex() {
    	return lessonIndex;
    	}
    
    public void setLessonIndex(Integer lessonIndex) { 
    	this.lessonIndex = lessonIndex;
    	}

    public String getSubject() {
    	return subject;
    	}
    
    public void setSubject(String subject) { 
    	this.subject = subject;
    	}

    public String getRoom() {
    	return room;
    	}
    
    public void setRoom(String room) {
    	this.room = room;
    	}

    public String getTimeBegin() { 
    	return timeBegin;
    	}
    
    public void setTimeBegin(String timeBegin) { 
    	this.timeBegin = timeBegin;
    	}

    public String getTimeEnd() { 
    	return timeEnd;
    	}
    
    public void setTimeEnd(String timeEnd) { 
    	this.timeEnd = timeEnd;
    	}
    
}package bot.start;

import bot.commands.*;
import bot.user.*;
import bot.fsm.*;
import bot.schedule.ScheduleManager;

import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

import java.util.Map;
import java.util.TreeMap; // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å

public class Homeworkbot extends TelegramLongPollingBot {

    private final Map<String, Command> commands = new TreeMap<>();

    private final UserStorage userStorage;
    private final StartCommand startCommand;
    private final EditScheduleCommand editScheduleCommand; 
    private final DialogStateMachine stateMachine;
    private final ShareGroupCommand shareGroupCommand;

    private final String envToken = System.getenv("BOT_TOKEN");

    public Homeworkbot() {
        userStorage = new SQLiteUserStorage();
        userStorage.initialize();
        startCommand = new StartCommand(userStorage);
        editScheduleCommand = new EditScheduleCommand(userStorage, new ScheduleManager(userStorage));
        shareGroupCommand = new ShareGroupCommand(userStorage, getBotUsername(), 1); // —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è 1 –¥–µ–Ω—å
        AddHomeworkCommand addHomeworkCommand = new AddHomeworkCommand(userStorage);
        
        commands.put("/start", startCommand);
        commands.put("/about", new AboutCommand());
        commands.put("/authors", new AuthorsCommand());
        commands.put("/help", new HelpCommand(commands));
        commands.put("/schedule", new ScheduleCommand(userStorage)); 
        commands.put("/editschedule", editScheduleCommand); 
        commands.put("/sharegroup", shareGroupCommand);
        commands.put("/addhw", addHomeworkCommand);
        commands.put("/homework", new PrintHomeworkCommand());
        commands.put("/markhw", new MarkHomeworkCommand(true));
        commands.put("/unmarkhw", new MarkHomeworkCommand(false));
        
        InviteHandler inviteHandler = new InviteHandler(userStorage); // —Å–æ–∑–¥–∞–µ–º invitehandler

        stateMachine = new DialogStateMachine(userStorage, startCommand, editScheduleCommand, inviteHandler, addHomeworkCommand);

    }

    @Override
    public void onUpdateReceived(Update update) {  // –æ–±—ä–µ–∫—Ç update - —ç—Ç–æ –≤—Å—ë, —á—Ç–æ –ø—Ä–∏—à–ª–æ –æ—Ç –¢–ì
        if (update.hasMessage() && update.getMessage().hasText()) {
            String text = update.getMessage().getText().trim(); // trim —É–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã —Å –∫–æ–Ω—Ü–∞ –∏ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏
            long chatId = update.getMessage().getChatId(); // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞
            
            if (text != null && text.startsWith("/start invite_")) {
                try {
                    SendMessage response = stateMachine.handleInput(chatId, text);
                    if (response != null) {
                        execute(response);
                        return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É, —Ç–∞–∫ –∫–∞–∫ –∏–Ω–≤–∞–π—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω
                    }
                } catch (Exception e) {
                    System.out.println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–Ω–≤–∞–π—Ç–∞: " + e.getMessage());
                    sendText(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.");
                    return;
                }
            }

            String[] parts = text.split("\\s+", 2); // —Ä–µ–≥—É–ª—è—Ä–∫–∞: 1 –∏–ª–∏ –±–æ–ª–µ–µ –ø—Ä–æ–±–µ–ª–æ–≤
            String commandName = parts[0].toLowerCase(); // toLowerCase —á—Ç–æ–±—ã —Ä–µ–≥–∏—Å—Ç—Ä –Ω–µ –º–µ—à–∞–ª

            try {
                if (text.startsWith("/")) {  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π
                    Command cmd = commands.get(commandName); // –∏—â–µ–º –∫–æ–º–∞–Ω–¥—É –≤ –º–∞–ø–µ
                    if (cmd != null) {
                    	
                        if (cmd instanceof StartCommand) {
                            execute(startCommand.processStart(chatId));  // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∏

                        } else if (cmd instanceof ScheduleCommand) {
                            String response = ((ScheduleCommand) cmd).realizationWithChatId(chatId, parts);
                            sendText(chatId, response);

                        } else if (cmd instanceof EditScheduleCommand) {
                            execute(((EditScheduleCommand) cmd).processChange(chatId, parts));

                        } else if (cmd instanceof ShareGroupCommand) {
                            String link = shareGroupCommand.start(chatId);
                            sendText(chatId, link);

                        } else if (cmd instanceof AddHomeworkCommand) {
                            AddHomeworkCommand ahref = (AddHomeworkCommand) cmd;
                            String response = ahref.start(chatId);
                            sendText(chatId, response); // –∏–ª–∏ build SendMessage –∏ execute

                        } else if (cmd instanceof PrintHomeworkCommand) {
                            String response = ((PrintHomeworkCommand) cmd).realizationWithChatId(chatId, parts);
                            sendText(chatId, response);

                        } else if (cmd instanceof MarkHomeworkCommand) {
                            String response = ((MarkHomeworkCommand) cmd).realizationWithChatId(chatId, parts);
                            sendText(chatId, response);

                        } else {
                            sendText(chatId, cmd.realization(parts));
                        }

                    } else {
                        User user = userStorage.getUser(chatId);

                        if (user != null && user.getState() != DialogState.REGISTERED) {
                            // –ø–µ—Ä–µ–¥–∞—ë–º –∫–æ–º–∞–Ω–¥—É –≤ FSM ‚Äî —Ç–∞–º –æ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –∫–∞–∫ /skip
                            SendMessage resp = stateMachine.handleInput(chatId, text);
                            if (resp != null) {
                                execute(resp);
                                return;
                            }
                        }

                        // –µ—Å–ª–∏ –Ω–µ –≤ –¥–∏–∞–ª–æ–≥–µ ‚Äî –≤—ã–≤–æ–¥–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        sendText(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.");
                    }

                } else {
                    // –æ–±—ã—á–Ω—ã–π –≤–≤–æ–¥ (FSM)
                    SendMessage response = stateMachine.handleInput(chatId, text);
                    execute(response);
                }

            } catch (Exception e) {
                System.out.println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: " + e.getMessage());
                sendText(chatId, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
            }
        }
    }

    private void sendText(long chatId, String text) {
        SendMessage msg = new SendMessage(String.valueOf(chatId), text);
        try {
            execute(msg);
        } catch (TelegramApiException e) {
            e.printStackTrace();
        }
    }

    @Override
    public String getBotUsername() {
        return "HomeworkHelperUrfu_bot";
    }

    @Override
    public String getBotToken() {
        return envToken;
    }
}package bot.start;

import org.telegram.telegrambots.meta.TelegramBotsApi; // –∫–ª–∞—Å—Å –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞ –∏ –∑–∞–ø—É—Å–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Telegram.
import org.telegram.telegrambots.updatesreceivers.DefaultBotSession; // c–ø–æ—Å–æ–± —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º Telegram —á–µ—Ä–µ–∑ –æ–ø—Ä–æ—Å

public class Main {
    public static void main(String[] args) {
        try {
            TelegramBotsApi botsApi = new TelegramBotsApi(DefaultBotSession.class);
            botsApi.registerBot(new Homeworkbot());
            System.out.println("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
package bot.user;
import bot.user.exception.UserStorageException;

import java.sql.*;
import bot.fsm.DialogState;

public class SQLiteUserStorage implements UserStorage {
    private final String DB_URL = "jdbc:sqlite:users.db"; // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    private Connection connection;

    
    @Override
    public void initialize() { // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç)
        try {
            connection = DriverManager.getConnection(DB_URL); // –æ–∫—Ç—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–¥ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
            String sql = "CREATE TABLE IF NOT EXISTS users (" + // —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ sql –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
                         "chatId INTEGER PRIMARY KEY," +
                         "name TEXT," +
                         "groupName TEXT," +
                         "university TEXT," +       
                         "department TEXT," +       
                         "course TEXT," +  
                         "state TEXT," +
                         "waitingForButton INTEGER," +
                         "hasCustomSchedule INTEGER DEFAULT 0" +
                         ")";
            
            // –≤—ã–∑—ã–≤–∞–µ–º —É –æ–±—ä–µ–∫—Ç–∞ connection –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞: –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–æ–≤
            Statement statment = connection.createStatement(); 
            statment.execute(sql); // –≤—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ execute (–æ–±—ä–µ–∫—Ç–∞ statment), –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å
            statment.close(); // –∑–∞–∫—Ä—ã–≤–∞–µ–º statment (–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏, –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω)
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö", e); 
            // –Ω–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (—á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        }
    }

    
    @Override 
    public User getUser(long chatId) { // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ chatId (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞ —é–∑–µ—Ä)
        try {
            String sql = "SELECT * FROM users WHERE chatId = ?"; // "–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ –ø–æ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞–¥–∞–Ω–Ω–æ–µ id
            // PreparedStatment - —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            PreparedStatement pstatment = connection.prepareStatement(sql); // —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä–æ–∫–∏ sql 
            pstatment.setLong(1, chatId);  // –≤ –ø–µ—Ä–≤—ã–π ? –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å chatId
            
            ResultSet result = pstatment.executeQuery(); // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è sql –∑–∞–ø—Ä–æ—Å–∞ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç ResultSet, —Ç.–µ. –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ)
            
            if (result.next()) { // –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –∫—É—Ä—Å–æ—Ä –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∑–∞–ø—Ä–æ—Å–∞
                String name = result.getString("name");
                String group = result.getString("groupName");
                String university = result.getString("university");   
                String department = result.getString("department");   
                String course = result.getString("course");   
                
                String stateStr = result.getString("state");
                DialogState state = DialogState.valueOf(stateStr); // valueOf –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è
                
                boolean waitingForButton = result.getInt("waitingForButton") == 1; // –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫–µ —Å–æ–≤–ø–∞–ª–æ —Å 1, —Ç–æ –≤–µ—Ä–Ω–µ—Ç true, –∏–Ω–∞—á–µ false
                boolean hasCustomSchedule = result.getInt("hasCustomSchedule") == 1;
                		
                
                result.close();
                pstatment.close();
                
                User user = new User(chatId, name, group, university, department, course, state);
                user.setWaitingForButton(waitingForButton); 
                user.setHasCustomSchedule(hasCustomSchedule);
                return user;
            }
            result.close();
            pstatment.close();
            return null;
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—â–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ id", e);
        }
    }

    
    @Override
    public void saveUser(User user) { // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (userExists(user.getChatId())) { // –ø—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ
            throw new UserStorageException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        try {
        	 String sql = "INSERT INTO users (chatId, name, groupName, university, department, course, state, waitingForButton, hasCustomSchedule) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";
            PreparedStatement pstatment = connection.prepareStatement(sql); // —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä–æ–∫–∏ sql
            
            pstatment.setLong(1, user.getChatId());
            pstatment.setString(2, user.getName());
            pstatment.setString(3, user.getGroup());
            pstatment.setString(4, user.getUniversity());
            pstatment.setString(5, user.getDepartment()); 
            pstatment.setString(6, user.getCourse());   
            pstatment.setString(7, user.getState().name());
            pstatment.setInt(8, user.getWaitingForButton() ? 1 : 0);
            pstatment.setInt(9, user.getHasCustomSchedule() ? 1 : 0);
            
            pstatment.executeUpdate(); // –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
            
            pstatment.close();
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }

   
    @Override
    public void updateUser(User user) { // –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!userExists(user.getChatId())) { // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞–µ—Ç–ª—è
            throw new UserStorageException("–ü–æ–ª—å–∑–æ–≤–∞–µ—Ç–ª—è —Å —Ç–∞–∫–∏–º ID –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö");
        }
        try {
        	// –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID
        	String sql = "UPDATE users SET name = ?, groupName = ?, university = ?, department = ?, course = ?, state = ?, waitingForButton = ?, hasCustomSchedule = ? WHERE chatId = ?";  
            PreparedStatement pstatment = connection.prepareStatement(sql);
            
            pstatment.setString(1, user.getName());
            pstatment.setString(2, user.getGroup());
            pstatment.setString(3, user.getUniversity()); 
            pstatment.setString(4, user.getDepartment()); 
            pstatment.setString(5, user.getCourse());   
            pstatment.setString(6, user.getState().name());
            pstatment.setInt(7, user.getWaitingForButton() ? 1 : 0);
            pstatment.setInt(8, user.getHasCustomSchedule() ? 1 : 0);
            pstatment.setLong(9, user.getChatId());
            
            pstatment.executeUpdate();
            
            pstatment.close();
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }

   
    @Override
    public void deleteUser(long chatId) { // –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try {
            String sql = "DELETE FROM users WHERE chatId = ?"; // —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º Id –∏–∑ 
            PreparedStatement pstatment = connection.prepareStatement(sql);
            
            pstatment.setLong(1, chatId);
            
            pstatment.executeUpdate();
            
            pstatment.close();
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }

    
    @Override
    public boolean userExists(long chatId) { // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        try {
            String sql = "SELECT 1 FROM users WHERE chatId = ?"; // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–¥–∞–Ω–Ω—ã–º ID –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–¥
            PreparedStatement pstatment = connection.prepareStatement(sql);
            
            pstatment.setLong(1, chatId);
            
            ResultSet result = pstatment.executeQuery(); // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è sql –∑–∞–ø—Ä–æ—Å–∞ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç ResultSet, —Ç.–µ. –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ)
            boolean exists = result.next(); // –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –∫—É—Ä—Å–æ—Ä –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∑–∞–ø—Ä–æ—Å–∞
            
            result.close();
            pstatment.close();
            
            return exists;
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }
    
    
    public void close() {
        try {
            if (connection != null) {
            	connection.close();
            }
        } catch (SQLException e) {
            // ignore
        }
    }
}package bot.user;
import bot.fsm.DialogState;

public class User {
    private Long chatId;
    private String name;
    private String group;
    private String university; 
    private String department; 
    private String course;
   
    private DialogState state; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    private boolean waitingForButton;
    private boolean hasCustomSchedule; 
    
    
    public User(Long chatId) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        this.chatId = chatId;
        this.university = "";
        this.department = "";
        this.course = "";
        this.state = DialogState.ASK_NAME; // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç —Å —ç—Ç–∞–ø–∞ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
        this.waitingForButton = false; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false
        this.hasCustomSchedule = false; // —Ñ–ª–∞–≥ –∏–∑–º–µ–Ω—è–ª –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        
    }
    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    public User(Long chatId, String name, String group, String university, String department, String course, DialogState state) { 
        this.chatId = chatId;
        this.name = name;
        this.group = group;
        this.university = university;
        this.department = department;
        this.course = course;
        this.state = state; // —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        this.waitingForButton = false; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false
        this.hasCustomSchedule = false;
    }

    
    public Long getChatId() {  // Id —á–∞—Ç–∞ –ø–æ–º–µ–Ω—è—Ç—å –Ω–µ –º–æ–∂–µ–º, –º–æ–∂–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ä–Ω—É—Ç—å
        return chatId; 
    }
    
    public String getName() { 
        return name; 
    }
    
    public void setName(String name) { 
        this.name = name; 
    }
    
    public String getGroup() { 
        return group; 
    }
    
    public void setGroup(String group) { 
        this.group = group; 
    }
    
    public String getUniversity() {
        return university;
    }

    public void setUniversity(String university) {
        this.university = university;
    }

    public String getDepartment() {
        return department;
    }

    public void setDepartment(String department) {
        this.department = department;
    }

    public String getCourse() {
        return course;
    }

    public void setCourse(String course) {
        this.course = course;
    }
    
    public DialogState getState() { 
        return state; 
    }
    
    public void setState(DialogState state) { 
        this.state = state; 
    }
    
    public boolean getWaitingForButton() {
        return waitingForButton;
    }
    
    public void setWaitingForButton(boolean waitingForButton) {
        this.waitingForButton = waitingForButton;
    }
    
    public boolean getHasCustomSchedule() { 
    	return hasCustomSchedule; 
    	}
    
    public void setHasCustomSchedule(boolean hasCustomSchedule) { 
        this.hasCustomSchedule = hasCustomSchedule; 
    }


    @Override
    public String toString() { // –°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ 
        return "User{" +
                "chatId=" + chatId +
                ", name='" + name + '\'' +
                ", group='" + group + '\'' +
                ", university='" + university + '\'' +   
                ", department='" + department + '\'' +   
                ", course='" + course + '\'' +          
                ", state=" + state +
                '}';
    }
}package bot.user;

import java.util.List;

public interface UserStorage {
    
    User getUser(long chatId); // –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É —á–∞—Ç–∞.
    
    void saveUser(User user); // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    
    void updateUser(User user); // –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    void deleteUser(long chatId); // –£–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
    
    boolean userExists(long chatId); // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
    
    void initialize(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (—Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ë–î –∏ —Ç.–¥.)
    
}package bot.user.exception;

public class ScheduleFetchException extends Exception {
    public ScheduleFetchException(String message) {
        super(message);
    }
}
package bot.user.exception;
// —á—Ç–æ–±—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –∑–Ω–∞–ª–∞ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö, –∞ –∑–Ω–∞–ª–∞ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –∏—Å–∫–ª—é—á–µ–µ–Ω–∏–µ –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å
public class ScheduleStorageException extends RuntimeException {
    public ScheduleStorageException(String message) { // –°–æ–∑–¥–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        super(message); // –ü–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä RuntimeException
    }
    
    public ScheduleStorageException(String message, Throwable cause) { // –°–æ–∑–¥–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ò –ø—Ä–∏—á–∏–Ω–æ–π
        super(message, cause);
    }
}package bot.user.exception;

public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(long userId) {
        super("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: " + userId);
    }
    
    public UserNotFoundException(String message) {
        super(message);
    }
}
package bot.user.exception;

public class UserStorageException extends RuntimeException {
    public UserStorageException(String message) {
        super(message);
    }
    
    public UserStorageException(String message, Throwable cause) {
        super(message, cause);
    }
}
