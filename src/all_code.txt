package bot.commands;

public class AboutCommand implements Command { // implements ‚Üí –∫–æ–≥–¥–∞ –∫–ª–∞—Å—Å —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

    @Override // –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–µ—Ç–æ–¥ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    public String getName() 
    { 
    	return "/about"; 
    }

    @Override
    public String getInformation() 
    { 
    	return "–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞"; 
    }

    @Override
    public String realization(String[] args) 
    {
        return "üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É—á–µ–±–µ \r\n"
        		+ "\r\n"
        		+ "–Ø –±—É–¥—É:\r\n"
        		+ "‚Ä¢ üìÖ –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –ø–∞—Ä\r\n"
        		+ "‚Ä¢ üìö –ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏—è—Ö  \r\n"
        		+ "‚Ä¢ ‚è∞ –ü—Ä–∏—Å—ã–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è\r\n"
        		+ "‚Ä¢ üí´ –ü–æ–º–æ–≥–∞—Ç—å —É—á–∏—Ç—å—Å—è –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞\r\n"
        		+ "\r\n"
        		+ "–í–º–µ—Å—Ç–µ –º—ã —Å–¥–µ–ª–∞–µ–º —É—á–µ–±—É –ø—Ä–æ—â–µ! ‚ú®";
    }
    
}
package bot.commands;

import bot.homework.SQLiteHomeworkStorage;
import bot.homework.HomeworkLinkStorage;
import bot.schedule.Schedule;
import bot.schedule.ScheduleManager;
import bot.schedule.Lesson;
import bot.user.User;
import bot.user.UserStorage;
import bot.fsm.DialogState;

import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.format.DateTimeParseException;
import java.util.*;
import java.util.concurrent.ConcurrentHashMap;

import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardRemove;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardButton;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardRow;

public class AddHomeworkCommand implements Command {

    private final SQLiteHomeworkStorage storage;
    private final UserStorage userStorage;
    private final ScheduleManager scheduleManager;
    private final HomeworkLinkStorage linkStorage;

    private final Map<Long, Draft> pending = new ConcurrentHashMap<>();

    public AddHomeworkCommand(UserStorage userStorage) {
        this.userStorage = userStorage;
        this.storage = new SQLiteHomeworkStorage();
        this.storage.initialize(); // –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ë–î
        this.scheduleManager = new ScheduleManager(userStorage);
        this.linkStorage = new HomeworkLinkStorage();
    }

    @Override
    public String getName() {
        return "/addhw";
    }

    @Override
    public String getInformation() {
        return "–î–æ–±–∞–≤–∏—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É";
    }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /addhw *–æ–ø–∏—Å–∞–Ω–∏–µ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è*.";
    }

    // –∑–∞–ø—É—Å–∫ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞
    public SendMessage start(long chatId) {
        User user = userStorage.getUser(chatId);
        if (user == null) {
            return new SendMessage(String.valueOf(chatId),
                    "‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start.");
        }

        // –Ω–æ–≤—ã–π/–æ—á–∏—â–µ–Ω–Ω—ã–π draft
        pending.remove(chatId);
        pending.put(chatId, new Draft());

        user.setState(DialogState.ASK_HW_SUBJECT);
        userStorage.updateUser(user);

        Schedule schedule = scheduleManager.getScheduleForUser(chatId);
        if (schedule == null) {
            return new SendMessage(String.valueOf(chatId),
                    "–®–∞–≥ 1/4 ‚Äî –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞).");
        }

        // —Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –∏–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
        Set<String> subs = new LinkedHashSet<>();
        for (List<Lesson> dayLessons : schedule.getWeeklySchedule().values()) {
            if (dayLessons != null) {
                for (Lesson lesson : dayLessons) {
                    if (lesson != null && lesson.getSubject() != null) {
                        subs.add(lesson.getSubject().trim());
                    }
                }
            }
        }

        if (subs.isEmpty()) {
            return new SendMessage(String.valueOf(chatId),
                    "–®–∞–≥ 1/4 ‚Äî –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç (–≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã).");
        }

        List<String> buttons = new ArrayList<>(subs);

        return createMessageWithDynamicButtons(
                chatId,
                "–®–∞–≥ 1/4 ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:",
                buttons
        );
    }

    public SendMessage handleStateMessage(long chatId, String messageText) {
        if (messageText == null) messageText = "";
        String txt = messageText.trim();

        User user = userStorage.getUser(chatId);
        if (user == null) return createMessage(chatId, "‚ùå –ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start.");

        Draft draft = pending.get(chatId);
        if (draft == null) {
            draft = new Draft();
            pending.put(chatId, draft);
        }

        DialogState state = user.getState();
        if (state == null) {
            user.setState(DialogState.ASK_HW_SUBJECT);
            userStorage.updateUser(user);
            return start(chatId);
        }

        switch (state) {
            case ASK_HW_SUBJECT:
                return handleSubject(chatId, user, draft, txt);
            case ASK_HW_TIME:
                return handleTime(chatId, user, draft, txt);
            case ASK_HW_DESCRIPTION:
                return handleDescription(chatId, user, draft, txt);
            case ASK_HW_REMIND:
                return handleRemind(chatId, user, draft, txt);
            default:
                user.setState(DialogState.ASK_HW_SUBJECT);
                userStorage.updateUser(user);
                return createMessage(chatId, "–ù–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ. –í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.");
        }
    }

    // –ü—Ä–µ–¥–º–µ—Ç
    private SendMessage handleSubject(long chatId, User user, Draft draft, String txt) {
        if (txt.isEmpty()) {
            return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç.");
        }

        Schedule schedule = scheduleManager.getScheduleForUser(chatId);
        if (schedule != null) {
            final String subjectInput = txt;
            boolean found = schedule.getWeeklySchedule().values().stream()
                    .filter(Objects::nonNull) // —É–±–∏—Ä–∞–µ–º –¥–Ω–∏ —Å null
                    .flatMap(Collection::stream) // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ Stream<Lesson>
                    .filter(Objects::nonNull)
                    .anyMatch(l -> l.getSubject() != null &&
                            l.getSubject().equalsIgnoreCase(subjectInput)); // –∏—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è

            if (!found) {
                return createMessage(chatId, "‚ùå –ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏. –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç.");
            }
            else {
                draft.subject = txt;
                user.setState(DialogState.ASK_HW_TIME);
                userStorage.updateUser(user);

                List<String> days = List.of(
                        "MONDAY", "TUESDAY", "WEDNESDAY",
                        "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"
                );

                return createMessageWithDynamicButtons(
                        chatId,
                        "–®–∞–≥ 2/4 ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É YYYY-MM-DD:",
                        days
                );
            }
        } else {
            // –ï—Å–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç ‚Äî –ø–æ–∑–≤–æ–ª–∏–º –≤–≤–µ—Å—Ç–∏ –ø—Ä–µ–¥–º–µ—Ç –∏ –∏–¥—Ç–∏ –¥–∞–ª—å—à–µ
            draft.subject = txt;
            user.setState(DialogState.ASK_HW_TIME);
            userStorage.updateUser(user);

            List<String> days = List.of(
                    "MONDAY", "TUESDAY", "WEDNESDAY",
                    "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"
            );

            return createMessageWithDynamicButtons(
                    chatId,
                    "–®–∞–≥ 2/4 ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É YYYY-MM-DD:",
                    days
            );
        }
    }

    // –í—Ä–µ–º—è
    private SendMessage handleTime(long chatId, User user, Draft draft, String txt) {
        List<String> days = List.of(
                "MONDAY", "TUESDAY", "WEDNESDAY",
                "THURSDAY", "FRIDAY", "SATURDAY", "SUNDAY"
        );

        if (txt.isEmpty()) {
            return createMessageWithDynamicButtons(
                    chatId,
                    "–®–∞–≥ 2/4 ‚Äî –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É YYYY-MM-DD:",
                    days
            );
        }

        LocalDate date;
        try {
            date = LocalDate.parse(txt);
        } catch (DateTimeParseException e) {
            // –≤–æ–∑–º–æ–∂–Ω–æ ‚Äî –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
            try {
                DayOfWeek dow = DayOfWeek.valueOf(txt.toUpperCase());
                LocalDate today = LocalDate.now();
                int delta = (dow.getValue() - today.getDayOfWeek().getValue() + 7) % 7;
                if (delta == 0) delta = 7; // –µ—Å–ª–∏ –≤—ã–±—Ä–∞–ª–∏ —Ç–æ—Ç –∂–µ –¥–µ–Ω—å ‚Äî –±–µ—Ä–µ–º —Å–ª–µ–¥—É—é—â–∏–π
                date = today.plusDays(delta);
            } catch (Exception ex) {
                return createMessageWithDynamicButtons(
                        chatId,
                        "–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É YYYY-MM-DD –∏–ª–∏ –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏:",
                        days
                );
            }
        }

        draft.dueDate = date;

        // –ø—Ä–æ–≤–µ—Ä–∫–∞: –µ—Å–ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –µ—Å—Ç—å ‚Äî —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–µ–¥–º–µ—Ç –µ—Å—Ç—å –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
        Schedule s = scheduleManager.getScheduleForUser(chatId);
        if (s != null && draft.subject != null) {
            String dayKey = date.getDayOfWeek().name();
            List<Lesson> lessons = getLessonsIgnoreCaseFromSchedule(s, dayKey);
            boolean ok = false;
            if (lessons != null) {
                for (Lesson l : lessons) {
                    if (l != null && l.getSubject() != null &&
                            l.getSubject().equalsIgnoreCase(draft.subject.trim())) {
                        ok = true;
                        break;
                    }
                }
            }
            if (!ok) {
                return createMessage(chatId, "‚ùå –ù–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É –ø—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏. –í–≤–µ–¥–∏—Ç–µ –¥—Ä—É–≥—É—é –¥–∞—Ç—É.");
            }
        }

        user.setState(DialogState.ASK_HW_DESCRIPTION);
        userStorage.updateUser(user);
        return createMessage(chatId, "–®–∞–≥ 3/4 ‚Äî –≤–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è (–∏–ª–∏ /skip –¥–ª—è –ø—Ä–æ–ø—É—Å–∫–∞ –æ–ø–∏—Å–∞–Ω–∏—è).");
    }

    // –û–∂–∏–¥–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
    private SendMessage handleDescription(long chatId, User user, Draft draft, String txt) {
        if (txt.equalsIgnoreCase("/skip")) txt = ""; // /skip ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ
        draft.description = txt;

        // –ü–µ—Ä–µ–≤–æ–¥–∏–º –Ω–∞ —à–∞–≥ –≤–æ–ø—Ä–æ—Å–∞ –æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–∏
        user.setState(DialogState.ASK_HW_REMIND);
        userStorage.updateUser(user);
        return createMessage(chatId, "–®–∞–≥ 4/4 ‚Äî –ó–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ –¥–µ–¥–ª–∞–π–Ω–∞ –Ω–∞–ø–æ–º–Ω–∏—Ç—å? –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä: 1). –í–≤–µ–¥–∏—Ç–µ /skip –¥–ª—è –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (1).");
    }

    // –û–∂–∏–¥–∞–µ–º remind-days
    private SendMessage handleRemind(long chatId, User user, Draft draft, String txt) {
        final int DEFAULT = 1;
        int remindDays = DEFAULT;
        if (txt.equalsIgnoreCase("/skip") || txt.isEmpty()) {
            remindDays = DEFAULT;
        } else {
            try {
                remindDays = Integer.parseInt(txt);
                if (remindDays < 0 || remindDays > 365) {
                    return createMessage(chatId, "‚ùå –£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ –æ—Ç 0 –¥–æ 365 (0 ‚Äî –≤ –¥–µ–Ω—å –¥–µ–¥–ª–∞–π–Ω–∞), –ª–∏–±–æ –≤–≤–µ–¥–∏—Ç–µ /skip.");
                }
            } catch (NumberFormatException e) {
                return createMessage(chatId, "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä 1) –∏–ª–∏ /skip.");
            }
        }

        draft.remindBeforeDays = remindDays;

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–∞–¥–∞–Ω–∏–µ –≤ –ë–î —Å remindBeforeDays
        try {
            storage.addHomework(
                    chatId,
                    draft.subject == null ? "-" : draft.subject,
                    draft.description == null ? "" : draft.description,
                    draft.dueDate == null ? LocalDate.now() : draft.dueDate,
                    draft.remindBeforeDays
            );
        } catch (Exception e) {
            e.printStackTrace();
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }

        // –ü–æ–ø—ã—Ç–∫–∞ –ø—Ä–∏–≤—è–∑–∞—Ç—å –¥–∑ –∫ –ø–∞—Ä–µ/—É—Ä–æ–∫—É
        try {
            Schedule sched = scheduleManager.getScheduleForUser(chatId);
            if (sched != null && draft.subject != null && draft.dueDate != null) {
                String dayKey = draft.dueDate.getDayOfWeek().name();
                List<Lesson> lessons = sched.getWeeklySchedule().get(dayKey);
                if (lessons != null) {
                    for (int i = 0; i < lessons.size(); i++) {
                        Lesson l = lessons.get(i);
                        if (l != null && l.getSubject() != null &&
                                l.getSubject().equalsIgnoreCase(draft.subject)) {
                            try {
                                linkStorage.linkLatestHomeworkByUserSubjectDate(chatId, draft.subject, draft.dueDate, dayKey, i);
                            } catch (Exception ignore) {
                                // –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω–æ ‚Äî –ª–æ–≥–∏—Ä—É–µ–º, –Ω–æ –Ω–µ –º–µ—à–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                                ignore.printStackTrace();
                            }
                            break;
                        }
                    }
                }
            }
        } catch (Exception ex) {
            ex.printStackTrace();
        }

        // –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
        pending.remove(chatId);
        user.setState(DialogState.REGISTERED);
        userStorage.updateUser(user);

        return createMessage(chatId, "‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ: " + (draft.subject == null ? "-" : draft.subject)
                + " ‚Äî " + (draft.description == null || draft.description.isEmpty() ? "-" : draft.description)
                + " (–¥–æ " + (draft.dueDate == null ? "-" : draft.dueDate.toString()) + "). –ù–∞–ø–æ–º–Ω—é –∑–∞ " + draft.remindBeforeDays + " –¥–Ω.");
    }

    private static class Draft {
        String subject;
        String description;
        LocalDate dueDate;
        int remindBeforeDays = 1;
    }

    private SendMessage createMessageWithDynamicButtons(long chatId, String text, List<String> options) {
        SendMessage message = new SendMessage(String.valueOf(chatId), text);

        ReplyKeyboardMarkup keyboardMarkup = new ReplyKeyboardMarkup();
        keyboardMarkup.setResizeKeyboard(true);
        keyboardMarkup.setOneTimeKeyboard(true);

        List<KeyboardRow> keyboard = new ArrayList<>();
        KeyboardRow currentRow = new KeyboardRow();

        for (int i = 0; i < options.size(); i++) {
            currentRow.add(new KeyboardButton(options.get(i))); // –∫–Ω–æ–ø–∫–∞
            if ((i + 1) % 2 == 0 || i == options.size() - 1) {
                keyboard.add(currentRow);
                currentRow = new KeyboardRow();
            }
        }

        keyboardMarkup.setKeyboard(keyboard);
        message.setReplyMarkup(keyboardMarkup);
        return message;
    }

    private SendMessage createMessage(long chatId, String text) { // —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        SendMessage message = new SendMessage();
        message.setChatId(String.valueOf(chatId));
        message.setText(text);
        
        boolean isFinalMessage = 
                text.contains("‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") ||
                text.contains("‚úÖ –ü–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ") ||
                text.contains("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞") ||
                text.contains("üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞") ||
                text.contains("–û—Ç–ª–∏—á–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã") ||
                (text.contains("–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:") && text.contains("–ò–º—è:") && text.contains("–ì—Ä—É–ø–ø–∞:"));
            
            if (isFinalMessage) {
                ReplyKeyboardRemove keyboardRemove = new ReplyKeyboardRemove();
                keyboardRemove.setRemoveKeyboard(true);
                message.setReplyMarkup(keyboardRemove);
            }
        
        return message;
    }

    private List<Lesson> getLessonsIgnoreCaseFromSchedule(Schedule s, String dayKey) {
        if (s == null || s.getWeeklySchedule() == null) return Collections.emptyList();

        Map<String, List<Lesson>> map = s.getWeeklySchedule();

        if (map.containsKey(dayKey) && map.get(dayKey) != null) {
            return map.get(dayKey);
        }

        for (String k : map.keySet()) {
            if (k != null && k.equalsIgnoreCase(dayKey)) {
                return map.get(k) == null ? Collections.emptyList() : map.get(k);
            }
        }

        return Collections.emptyList();
    }
}
package bot.commands;

public class AuthorsCommand implements Command {
	
	@Override // –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –º–µ—Ç–æ–¥ —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ –∫–ª–∞—Å—Å–∞ –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
    public String getName() 
    { 
    	return "/authors"; 
    }

    @Override
    public String getInformation() 
    { 
    	return "–†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –±–æ—Ç–∞"; 
    }

    @Override
    public String realization(String[] args) 
    {
        return "üëã –ü—Ä–∏–≤–µ—Ç! –ú—ã - –í–∏–∫—Ç–æ—Ä–∏—è –ù–µ—Å—Ç–µ—Ä–æ–≤–∞ –∏ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –í–æ—Ä–æ–±—å—ë–≤\n\n"
        		+ "üìñ –°—Ç—É–¥–µ–Ω—Ç—ã –≥—Ä—É–ø–ø—ã –ú–ï–ù-241001 (–ö–ë-202)\r\n"
        		+ "\r\n"
        		+ "–°–æ–∑–¥–∞–ª–∏ —ç—Ç–æ–≥–æ –±–æ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–∞–∫–∏–º –∂–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º, –∫–∞–∫ –º—ã! ‚ù§Ô∏è";
    }

}
package bot.commands;

public interface Command {
	
	String getName();
	String getInformation();
	String realization(String[] args);

}
package bot.commands;

import bot.homework.SQLiteHomeworkStorage;
import bot.homework.HomeworkItem;
import bot.homework.HomeworkLinkStorage;

import java.util.List;
import java.util.stream.Collectors;

public class DeleteHomeworkCommand implements Command {

    private final SQLiteHomeworkStorage storage;
    private final HomeworkLinkStorage linkStorage;

    public DeleteHomeworkCommand() {
        this.storage = new SQLiteHomeworkStorage();
        this.storage.initialize();
        this.linkStorage = new HomeworkLinkStorage();
    }

    @Override
    public String getName() {
        return "/deletehw";
    }

    @Override
    public String getInformation() {
        return "–£–¥–∞–ª–∏—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ ID.\n" +
                "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n" +
                "/deletehw ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤–∞—à–∏—Ö –î–ó —Å ID\n" +
                "/deletehw <id> ‚Äî —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID";
    }

    @Override
    public String realization(String[] args) {
        return getInformation();
    }

    public String realizationWithChatId(long chatId, String[] args) {
        try {
            List<HomeworkItem> all = storage.getHomeworkByUser(chatId);

            // –ï—Å–ª–∏ –Ω–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç–∞ ‚Äî –≤–µ—Ä–Ω—ë–º —Å–ø–∏—Å–æ–∫ —Å ID, —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–≤–∏–¥–µ–ª, —á—Ç–æ —É–¥–∞–ª–∏—Ç—å
            if (args == null || args.length < 2 || args[1] == null || args[1].trim().isEmpty()) {
                if (all.isEmpty()) return "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è.";
                String list = all.stream()
                        .map(h -> String.format("[%d] %s ‚Äî %s (–¥–æ %s)%s",
                                h.getId(),
                                h.getSubject() == null ? "-" : h.getSubject(),
                                h.getDescription() == null || h.getDescription().isEmpty() ? "-" : h.getDescription(),
                                h.getDueDate() == null ? "-" : h.getDueDate().toString(),
                                h.getRemindBeforeDays() > 0 ? " üîî –∑–∞ " + h.getRemindBeforeDays() + " –¥–Ω." : ""))
                        .collect(Collectors.joining("\n"));
                return "–í–∞—à–∏ –∑–∞–¥–∞–Ω–∏—è:\n" + list + "\n\n–ß—Ç–æ–±—ã —É–¥–∞–ª–∏—Ç—å ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /deletehw <id>";
            }

            // –ü—ã—Ç–∞–µ–º—Å—è —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å ID
            String idStr = args[1].trim();
            long id;
            try {
                id = Long.parseLong(idStr);
            } catch (NumberFormatException e) {
                return "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID. –£–∫–∞–∂–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ. –ü—Ä–∏–º–µ—Ä: /deletehw 123";
            }

            // –ü—Ä–æ–≤–µ—Ä–∏–º, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ —ç—Ç–æ –∑–∞–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
            boolean found = all.stream().anyMatch(h -> h.getId() == id);
            if (!found) {
                return "‚ùå –ó–∞–¥–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —É –≤–∞—Å. –í—ã–ø–æ–ª–Ω–∏—Ç–µ /deletehw —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Å ID.";
            }

            // –£–¥–∞–ª—è–µ–º —Å–≤—è–∑—å –≤ —Ç–∞–±–ª–∏—Ü–µ homework_link
            try {
                linkStorage.unlinkHomework(id);
            } catch (Exception ignore) {
                try { ignore.printStackTrace(); } catch (Exception ex) {}
            }

            // –£–¥–∞–ª—è–µ–º —Å–∞–º–æ –∑–∞–¥–∞–Ω–∏–µ
            storage.deleteHomework(id);

            return "‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ —Å ID " + id + " —É–¥–∞–ª–µ–Ω–æ.";
        } catch (Exception e) {
            e.printStackTrace();
            return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
        }
    }
}
package bot.commands;

import bot.session.EditSessionManager;
import java.time.DayOfWeek;
import bot.session.Session;
import bot.fsm.DialogState;
import bot.schedule.Lesson;
import bot.schedule.Schedule;
import bot.schedule.ScheduleManager;
import bot.user.User;
import bot.user.UserStorage;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardRemove;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardButton;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardRow;

import java.time.LocalTime;
import java.time.format.DateTimeParseException;
import java.util.ArrayList;
import java.util.List;

public class EditScheduleCommand implements Command {

    private final UserStorage userStorage;
    private final ScheduleManager scheduleManager;

    public EditScheduleCommand(UserStorage userStorage, ScheduleManager scheduleManager) {
        this.userStorage = userStorage;
        this.scheduleManager = scheduleManager;
    }

    @Override
    public String getName() {
        return "/editSchedule";
    }

    @Override
    public String getInformation() {
        return "–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å (–¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–∞—Ä—É)\n"
        		+ "–ø—Ä–∏–º–µ—Ä –≤–≤–æ–¥–∞: /editSchedule monday";
    }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /editSchedule <–¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏>, –Ω–∞–ø—Ä–∏–º–µ—Ä: /editSchedule monday";
    }


    public SendMessage processChange(long chatId, String[] args) { // —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–º–∞—à–∫–∏
        User user = userStorage.getUser(chatId);
        if (user == null) {
            return createMessage(chatId, "‚ùå‚ùå‚ùå –°–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –∫–æ–º–∞–Ω–¥–æ–π /start");
        }

        if (args == null || args.length < 2 || args[1].trim().isEmpty()) {
            return createMessage(chatId, "‚ùå‚ùå‚ùå –£–∫–∞–∂–∏—Ç–µ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: /editSchedule monday");
        }

        String dayInput = args[1].trim();
        
        DayOfWeek dayEnum = null;
        for (DayOfWeek day : DayOfWeek.values()) {
            if (day.name().equalsIgnoreCase(dayInput)) {
                dayEnum = day;
                break;
            }
        }
        if (dayEnum == null) { // –Ω–µ –Ω–∞—à–ª–∏ –≤ –¥–Ω—è—Ö –≤–≤–µ–¥–µ–Ω–Ω—ã–π –¥–µ–Ω—å
            return createMessage(chatId,
                "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏. –£–∫–∞–∂–∏—Ç–µ –æ–¥–∏–Ω –∏–∑: " +
                "Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday.");
        }

        String dayLower = dayEnum.name().toLowerCase();

        user.setWaitingForButton(false); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏, (—á—Ç–æ–±—ã StartCommand –Ω–µ –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–ª –Ω–∞–∂–∞—Ç–∏—è)
        userStorage.updateUser(user);

        Session session = EditSessionManager.getSession(chatId); // –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        session.setDay(dayLower); // –≤—Ä–µ–º–µ–Ω–Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º lower; –ø–æ–∑–∂–µ –∑–∞–º–µ–Ω–∏–º –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω—ã–π –∫–ª—é—á 


        if (!scheduleManager.customScheduleExists(chatId)) { // –µ—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è - –∫–æ–ø–∏—Ä—É–µ–º –æ–±—â–µ–µ
            try {
                scheduleManager.copyCommonToCustom(chatId);
            } catch (Exception e) {
                // >>> –î–û–ë–ê–í–õ–ï–ù–û: –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Ç–µ–∫) –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                e.printStackTrace();
                return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
            }
        }

        Schedule schedule = scheduleManager.getScheduleForUser(chatId); // –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        if (schedule == null) {
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }

        // –ü–æ–ø—ã—Ç–∫–∞ –Ω–∞–π—Ç–∏ —É—Ä–æ–∫–∏ –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–Ω—è (matchedDay)
        List<Lesson> lessons = schedule.getLessonsForDay(dayLower);
        
        String matchedDay = null;
        if (lessons != null && !lessons.isEmpty()) {
            matchedDay = dayLower;
        } else {
            String cap = dayLower.substring(0, 1).toUpperCase() + dayLower.substring(1).toLowerCase();
            lessons = schedule.getLessonsForDay(cap);
            if (lessons != null && !lessons.isEmpty()) {
                matchedDay = cap;
            } else {
                lessons = schedule.getLessonsForDay(dayLower.toUpperCase());
                if (lessons != null && !lessons.isEmpty()) {
                    matchedDay = dayLower.toUpperCase();
                }
            }
        }

        // –ï—Å–ª–∏ –Ω–∞—à–ª–∏ –ø–∞—Ä—ã –ø–æ–¥ –∫–∞–∫–∏–º-—Ç–æ –∫–ª—é—á–æ–º ‚Äî —Å–æ—Ö—Ä–∞–Ω—è–µ–º —ç—Ç–æ—Ç –∫–ª—é—á –≤ —Å–µ—Å—Å–∏–∏, —á—Ç–æ–±—ã –¥–∞–ª—å–Ω–µ–π—à–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –µ–≥–æ.
        if (matchedDay != null) {
            session.setDay(matchedDay);
        } else {
            // –æ—Å—Ç–∞–≤–ª—è–µ–º lower –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –Ω–æ–≤—ã–µ –ø–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–¥ —ç—Ç–∏–º –∫–ª—é—á–æ–º
            session.setDay(dayLower);
        }

        StringBuilder text = new StringBuilder("üéì –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ " + session.getDay() + ":\n\n");
        if (lessons == null || lessons.isEmpty()) {
            text.append("–ü–∞—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.\n\n");
        } else {
            for (int i = 0; i < lessons.size(); i++) {
                Lesson les = lessons.get(i);
                text.append(i + 1).append(". ")
                        .append(les.getSubject())
                        .append(" (").append(les.getStartTime())
                        .append(" - ").append(les.getEndTime())
                        .append(", ").append(les.getClassroom()).append(")\n");
            }
            text.append("\n");
        }
        text.append("–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:");

        user.setState(DialogState.EDIT_CHOOSE_ACTION); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –Ω–∞ –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è
        userStorage.updateUser(user);

        List<String> options = List.of("–î–æ–±–∞–≤–∏—Ç—å", "–£–¥–∞–ª–∏—Ç—å");
        return createMessageWithDynamicButtons(chatId, text.toString(), options);
    }


    public SendMessage processEdit(long chatId, String rawMessageText) { // –æ–±—Ä–∞–±–æ—Ç–∫–∞ —à–∞–≥–æ–≤ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        String messageText = rawMessageText == null ? "" : rawMessageText.trim();

        User user = userStorage.getUser(chatId);
        if (user == null) {
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.");
        }

        Session session = EditSessionManager.getSession(chatId);
        if (session == null || session.getDay() == null) {
            // –ï—Å–ª–∏ —Å–µ—Å—Å–∏—è –ø–æ—Ç–µ—Ä—è–Ω–∞ ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
            user.setState(DialogState.REGISTERED);
            userStorage.updateUser(user);
            return createMessage(chatId, "‚ùå –°–µ—Å—Å–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É—Ç—Ä–∞—á–µ–Ω–∞. –í–≤–µ–¥–∏—Ç–µ /editSchedule <–¥–µ–Ω—å> —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.");
        }

        String day = session.getDay();
        Schedule schedule = scheduleManager.getScheduleForUser(chatId);
        if (schedule == null) {
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞: —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
        }

        switch (user.getState()) {
            case EDIT_CHOOSE_ACTION:
                if (messageText.equalsIgnoreCase("–î–æ–±–∞–≤–∏—Ç—å")) {
                    user.setState(DialogState.ASK_SUBJECT);
                    userStorage.updateUser(user);
                    return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:");
                } else if (messageText.equalsIgnoreCase("–£–¥–∞–ª–∏—Ç—å")) {
                    user.setState(DialogState.ASK_LESSON_INDEX);
                    userStorage.updateUser(user);
                    return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∞—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è:");
                } else {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏: –î–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –£–¥–∞–ª–∏—Ç—å");
                }

            case ASK_SUBJECT:
                if (messageText.isEmpty()) {
                    return createMessage(chatId, "‚ùå –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:");
                }
                session.setSubject(messageText);
                user.setState(DialogState.ASK_ROOM);
                userStorage.updateUser(user);
                return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏:");

            case ASK_ROOM:
                if (messageText.isEmpty()) {
                    return createMessage(chatId, "‚ùå –ù–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é:");
                }
                session.setRoom(messageText);
                user.setState(DialogState.ASK_TIME_BEGIN);
                userStorage.updateUser(user);
                return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 09:00):");

            case ASK_TIME_BEGIN:
                if (messageText.isEmpty()) {
                    return createMessage(chatId, "‚ùå –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 09:00):");
                }
                session.setTimeBegin(messageText);
                user.setState(DialogState.ASK_TIME_END);
                userStorage.updateUser(user);
                return createMessage(chatId, "–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10:30):");

            case ASK_TIME_END:
                if (messageText.isEmpty()) {
                    return createMessage(chatId, "‚ùå –í—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10:30):");
                }
                session.setTimeEnd(messageText);

                // –ü–∞—Ä—Å–∏–º –≤—Ä–µ–º—è –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–æ–≤—É—é –ø–∞—Ä—É
                try {
                    LocalTime begin = LocalTime.parse(session.getTimeBegin());
                    LocalTime end = LocalTime.parse(session.getTimeEnd());
                    Lesson newLesson = new Lesson(session.getSubject(), begin, end, session.getRoom());

                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º session.getDay() –∫–∞–∫ –∫–ª—é—á 
                    schedule.addLesson(session.getDay(), newLesson);
                    scheduleManager.saveCustomSchedule(chatId, schedule);

                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);
                    EditSessionManager.clearSession(chatId);

                    return createMessage(chatId, "‚úÖ –ü–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
                } catch (DateTimeParseException e) {
                    // –û—Å—Ç–∞–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ ASK_TIME_END, –ø—Ä–æ—Å–∏–º –≤–≤–µ—Å—Ç–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
                    user.setState(DialogState.ASK_TIME_END);
                    userStorage.updateUser(user);
                    return createMessage(chatId, "‚ùå –§–æ—Ä–º–∞—Ç –≤—Ä–µ–º–µ–Ω–∏ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–∞—Ä—ã. –í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:mm, –Ω–∞–ø—Ä–∏–º–µ—Ä 09:00:");
                } catch (Exception e) {
                    e.printStackTrace();
                    return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –ø–∞—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
                }

            case ASK_LESSON_INDEX:
                int index;
                try {
                    index = Integer.parseInt(messageText) - 1;
                } catch (NumberFormatException e) {
                    return createMessage(chatId, "‚ùå –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–∞—Ä—ã —á–∏—Å–ª–æ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä, 1):");
                }

                // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å —É—Ä–æ–∫–∏ –ø–æ session.getDay(), –∏ –µ—Å–ª–∏ —ç—Ç–æ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–æ–±—É–µ–º –∏–∑–≤–µ—Å—Ç–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞
                List<Lesson> lessons = schedule.getLessonsForDay(day);
                if (lessons == null || lessons.isEmpty()) {
                    String cap = day.substring(0, 1).toUpperCase() + day.substring(1).toLowerCase();
                    lessons = schedule.getLessonsForDay(cap);
                    if (lessons != null && !lessons.isEmpty()) {
                        // —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Å–µ—Å—Å–∏–∏ —Ä–µ–∞–ª—å–Ω—ã–π –∫–ª—é—á, —á—Ç–æ–±—ã –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –µ–≥–æ
                        session.setDay(cap);
                        day = cap;
                    } else {
                        lessons = schedule.getLessonsForDay(day.toUpperCase());
                        if (lessons != null && !lessons.isEmpty()) {
                            session.setDay(day.toUpperCase());
                            day = day.toUpperCase();
                        }
                    }
                }

                if (lessons == null || lessons.isEmpty()) { // –ù–µ—á–µ–≥–æ —É–¥–∞–ª—è—Ç—å
                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);
                    EditSessionManager.clearSession(chatId);
                    return createMessage(chatId, "‚ùå –ü–∞—Ä—ã –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.");
                }

                if (index < 0 || index >= lessons.size()) {
                    return createMessage(chatId, "‚ùå –ü–∞—Ä—ã —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –Ω–µ—Ç. –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä:");
                }

                lessons.remove(index);

                try {
                    scheduleManager.saveCustomSchedule(chatId, schedule);

                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);
                    EditSessionManager.clearSession(chatId);

                    return createMessage(chatId, "‚úÖ –ü–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞!");
                } catch (Exception e) {
                    e.printStackTrace();
                    return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–∞—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
                }

            default: // –ï—Å–ª–∏ –ø–æ–ø–∞–ª–∏ —Å—é–¥–∞ ‚Äî –ø–æ–ø—Ä–æ—Å–∏–º –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ
                user.setState(DialogState.REGISTERED);
                userStorage.updateUser(user);
                EditSessionManager.clearSession(chatId);
                return createMessage(chatId, "‚ùå‚ùå‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ /editSchedule <–¥–µ–Ω—å> —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ.");
        }
    }

    private SendMessage createMessage(long chatId, String text) { // —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        SendMessage message = new SendMessage();
        message.setChatId(String.valueOf(chatId));
        message.setText(text);
        
        boolean isFinalMessage = 
                text.contains("‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") ||
                text.contains("‚úÖ –ü–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ") ||
                text.contains("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞") ||
                text.contains("üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞") ||
                text.contains("–û—Ç–ª–∏—á–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã") ||
                (text.contains("–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:") && text.contains("–ò–º—è:") && text.contains("–ì—Ä—É–ø–ø–∞:"));
            
            if (isFinalMessage) {
                ReplyKeyboardRemove keyboardRemove = new ReplyKeyboardRemove();
                keyboardRemove.setRemoveKeyboard(true);
                message.setReplyMarkup(keyboardRemove);
            }
        
        return message;
    }

    private SendMessage createMessageWithDynamicButtons(long chatId, String text, List<String> options) { // —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫
        SendMessage message = new SendMessage(String.valueOf(chatId), text);

        ReplyKeyboardMarkup keyboardMarkup = new ReplyKeyboardMarkup();
        keyboardMarkup.setResizeKeyboard(true);
        keyboardMarkup.setOneTimeKeyboard(true);

        List<KeyboardRow> keyboard = new ArrayList<>();
        KeyboardRow currentRow = new KeyboardRow();

        for (int i = 0; i < options.size(); i++) {
            currentRow.add(new KeyboardButton(options.get(i)));
            if ((i + 1) % 2 == 0 || i == options.size() - 1) {
                keyboard.add(currentRow);
                currentRow = new KeyboardRow();
            }
        }

        keyboardMarkup.setKeyboard(keyboard);
        message.setReplyMarkup(keyboardMarkup);
        return message;
    }
}package bot.commands;

import java.util.Map;
public class HelpCommand implements Command {

	private final Map<String, Command> commands; //—Å—Å—ã–ª–∫–∞ –Ω–∞ –º–∞–ø—É –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥. final - 
    // –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω—è—Ç—å, –Ω–æ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–±—ä–µ–∫—Ç –Ω–µ –∑–∞–º–µ–Ω–∏—Ç—Å—è)

    public HelpCommand(Map<String, Command> commands) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (–ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–æ–º–∞–Ω–¥)
        this.commands = commands;
    }
    @Override
    public String getName() {
        return "/help";
    }

    @Override
    public String getInformation() {
        return "–í—ã–≤–æ–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ";
    }

    @Override
    public String realization(String[] args) {
        if (args.length > 1) { // —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ –ø–æ—Å–ª–µ /help –∏–¥–µ—Ç –∏–º—è –∫–æ–º–∞–Ω–¥—ã
        	String cmdName = args[1].trim().toLowerCase();
            Command cmd = commands.get(cmdName); // –∏—â–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–ª—é—á—É –≤ –º–∞–ø–µ
            if (cmd != null) {
                return cmd.getName() + " ‚Äî " + cmd.getInformation();
            } 
            else {
                return "–ö–æ–º–∞–Ω–¥–∞ " + cmdName + " –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.";
            }
        }
        
        else { // –µ—Å–ª–∏ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –Ω–µ—Ç ‚Äî –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∫–æ–º–∞–Ω–¥—ã
        	String result = "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:\n";
        	for (Command command : commands.values()) {
        	    result += command.getName() + " ‚Äî " + command.getInformation() + "\n\n\n";
            }
            return result;
        }
    }
}package bot.commands;

import bot.user.User;
import bot.user.UserStorage;
import bot.fsm.DialogState;
import bot.schedule.Schedule;
import bot.schedule.ScheduleFetcher;
import bot.schedule.ScheduleManager;

import org.telegram.telegrambots.meta.api.methods.send.SendMessage;

import java.net.URLDecoder;
import java.nio.charset.StandardCharsets;
import java.util.Base64;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

public class InviteHandler {

    private final UserStorage userStorage;
    private final ObjectMapper mapper = new ObjectMapper();

    public InviteHandler(UserStorage userStorage) {
        this.userStorage = userStorage;
    }

    public SendMessage tryProcessInvite(long chatId, String fullText) {
        if (fullText == null) return null;

        String[] parts = fullText.split("\\s+");
        if (parts.length < 2) return null;

        String param = parts[1];
        if (!param.startsWith("invite_")) return null;

        try {
            String encoded = param.substring("invite_".length());

            // Base64 –∏–∑ URLDecoded
            String base64 = URLDecoder.decode(encoded, StandardCharsets.UTF_8);
            String json = new String(Base64.getDecoder().decode(base64), StandardCharsets.UTF_8);

            JsonNode obj = mapper.readTree(json);

            long inviterId = obj.has("inviter") ? obj.get("inviter").asLong(-1) : -1;

            if (inviterId == -1) {
                return msg(chatId, "‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–∏.");
            }

            // –∏—â–µ–º –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ
            User inviter = userStorage.getUser(inviterId);
            if (inviter == null) {
                return msg(chatId, "‚ùå –ü—Ä–∏–≥–ª–∞—à–∞—é—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω.");
            }

            // —Å–æ–∑–¥–∞—ë–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è-—Ü–µ–ª—å
            User user = userStorage.getUser(chatId);
            boolean existed = (user != null);
            if (!existed) {
                user = new User(chatId);
            }

            user.setGroup(inviter.getGroup());
            user.setUniversity(inviter.getUniversity());
            user.setDepartment(inviter.getDepartment());
            user.setCourse(inviter.getCourse());
            user.setWaitingForButton(false);

            // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω ‚Äî –æ–±–Ω–æ–≤–∏–º –∏ –ø–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–¥–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            if (existed && user.getState() == DialogState.REGISTERED) {
                userStorage.updateUser(user);

                try {
                    // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã (–∏—Å–ø–æ–ª—å–∑—É–µ–º fetcher –∫–∞–∫ —Ä–∞–Ω—å—à–µ)
                    ScheduleFetcher fetcher = new ScheduleFetcher();
                    Schedule schedule = fetcher.fetchForUser(user);

                    ScheduleManager sm = new ScheduleManager(userStorage);
                    if (schedule != null) {
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ (–∫–∞–∫ —Ä–∞–Ω—å—à–µ)
                        sm.saveCommonSchedule(schedule);

                        // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –±—ã–ª –∫–∞—Å—Ç–æ–º ‚Äî —Å–±—Ä–æ—Å–∏–º, —á—Ç–æ–±—ã –Ω–æ–≤–æ–µ –æ–±—â–µ–µ –≤—Å—Ç—É–ø–∏–ª–æ –≤ —Å–∏–ª—É
                        if (sm.customScheduleExists(chatId)) {
                            sm.resetToOriginalSchedule(chatId);
                        }
                        sm.close();

                        return msg(chatId,
                                "–í—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é! üéâ\n\n" +
                                        "–í–∞—à–∞ –≥—Ä—É–ø–ø–∞ –∏ —Å–æ–ø—É—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.\n" +
                                        "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±—ã–ª–æ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∏ –∑–∞–º–µ–Ω–µ–Ω–æ –Ω–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω–æ–π –≥—Ä—É–ø–ø—ã.\n\n" +
                                        "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                                        "–ò–Ω—Å—Ç–∏—Ç—É—Ç: " + user.getUniversity() + "\n" +
                                        "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                                        "–ö—É—Ä—Å: " + user.getCourse());
                    } else {
                        sm.close();
                        return msg(chatId,
                                "–í—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é! üéâ\n\n" +
                                        "–î–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã.\n" +
                                        "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                                        "–ò–Ω—Å—Ç–∏—Ç—É—Ç: " + user.getUniversity() + "\n" +
                                        "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                                        "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                                        "–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö —É –ø—Ä–∏–≥–ª–∞—Å–∏–≤—à–µ–≥–æ.");
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                    return msg(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ—Å–ª–µ –ø–µ—Ä–µ—Ö–æ–¥–∞ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é.");
                }
            }

            // –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –Ω–æ–≤—ã—Ö / –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π ‚Äî –∫–∞–∫ –±—ã–ª–æ
            user.setState(DialogState.ASK_NAME_INVITE);

            if (existed) {
                userStorage.updateUser(user);
            } else {
                userStorage.saveUser(user);
            }

            return msg(chatId,
                    "–í—ã –ø–µ—Ä–µ—à–ª–∏ –ø–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—é! üéâ\n\n" +
                            "–Ø - —É–º–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π:\r\n"
                            + "üìÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–ª–µ–¥–∏—Ç –∑–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º\r\n"
                            + "üìö –ù–∞–ø–æ–º–∏–Ω–∞–µ—Ç –æ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏—è—Ö\r\n"
                            + "‚è∞ –ü—Ä–∏—Å—ã–ª–∞–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è\n\n" +
                            "–î–∞–Ω–Ω—ã–µ –≥—Ä—É–ø–ø—ã –±—ã–ª–∏ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:\n" +
                            "üë• –ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                            "üèõÔ∏è –ò–Ω—Å—Ç–∏—Ç—É—Ç: " + user.getUniversity() + "\n" +
                            "üìã –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                            "üéì –ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                            "–î–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");

        } catch (Exception e) {
            e.printStackTrace();
            return msg(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.");
        }
    }

    private SendMessage msg(long chatId, String text) {
        return new SendMessage(String.valueOf(chatId), text);
    }
}
package bot.commands;

import bot.homework.SQLiteHomeworkStorage;
import bot.homework.HomeworkItem;
import java.util.List;

public class MarkHomeworkCommand implements Command {

    private final SQLiteHomeworkStorage storage;
    private final boolean markAsDone;

    public MarkHomeworkCommand(boolean markAsDone) {
        this.storage = new SQLiteHomeworkStorage();
        this.storage.initialize();
        this.markAsDone = markAsDone;
    }

    @Override
    public String getName() {
        return markAsDone ? "/markhw" : "/unmarkhw";
    }

    @Override
    public String getInformation() {
        return markAsDone ? "–û—Ç–º–µ—Ç–∏—Ç—å –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ: /markhw <id>"
                : "–°–Ω—è—Ç—å –æ—Ç–º–µ—Ç–∫—É –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: /unmarkhw <id>";
    }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: " + (markAsDone ? "/markhw <id>" : "/unmarkhw <id>");
    }

    public String realizationWithChatId(long chatId, String[] args) { //–ø–µ—Ä–µ–¥–∞—ë–º id —á–∞—Ç–∞ –∏ –∫–æ–º–∞–Ω–¥—É, –ø–æ–ª—É—á–µ–Ω–Ω—É—é –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏
        if (args == null || args.length < 2 || args[1].trim().isEmpty()) {
            return realization(args);
        }
        String idText = args[1].trim(); // —É–¥–∞–ª—è–µ–º –ø—Ä–æ–±–µ–ª—å–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        long id;
        try {
            id = Long.parseLong(idText);
        }
        catch (NumberFormatException e) {
            return "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: " + (markAsDone ? "/markhw <id>" : "/unmarkhw <id>");
        }

        try {
            List<HomeworkItem> items = storage.getHomeworkByUser(chatId);
            boolean found = items.stream().anyMatch(h -> h.getId() == id); //–µ—Å—Ç—å –ª–∏ –¥–∑ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!found) {
                return "‚ùå –ó–∞–¥–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —É –≤–∞—Å.";
            }

            storage.markAsCompleted(id, markAsDone);
            return markAsDone ? "‚úÖ –ó–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ." : "‚úÖ –ü–æ–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–Ω—è—Ç–∞.";
        }
        catch (Exception e) {
            e.printStackTrace();
            return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–¥–∞–Ω–∏—è.";
        }
    }
}
package bot.commands;

import bot.homework.SQLiteHomeworkStorage;
import bot.homework.HomeworkItem;

import java.time.DayOfWeek;
import java.time.LocalDate;
import java.time.format.DateTimeParseException;
import java.util.List;
import java.util.stream.Collectors;

public class PrintHomeworkCommand implements Command {

    private final SQLiteHomeworkStorage storage;

    public PrintHomeworkCommand() {
        this.storage = new SQLiteHomeworkStorage();
        this.storage.initialize();
    }

    @Override
    public String getName() {
        return "/homework";
    }

    @Override
    public String getInformation() {
        return "–ü–æ–∫–∞–∑–∞—Ç—å –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è:\n"
        		+ "/homework ‚Äî –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è\n"
        		+ "/homework Monday ‚Äî –∑–∞–¥–∞–Ω–∏—è —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫\n"
        		+ "/homework 2025-11-20 ‚Äî –∑–∞–¥–∞–Ω–∏—è —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É\n"
        		+ "/homework *–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞* ‚Äî –∑–∞–¥–∞–Ω–∏—è –ø–æ –∫–æ–Ω—Ä–µ–∫—Ç–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É";
    }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n" +
                "/homework ‚Äî –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è\n" +
                "/homework Monday ‚Äî –∑–∞–¥–∞–Ω–∏—è —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –≤ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫\n" +
                "/homework 2025-11-20 ‚Äî –∑–∞–¥–∞–Ω–∏—è —Å –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –¥–∞—Ç—É\n" +
                "/homework *–Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞* ‚Äî –∑–∞–¥–∞–Ω–∏—è –ø–æ –∫–æ–Ω—Ä–µ–∫—Ç–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É";
    }

    public String realizationWithChatId(long chatId, String[] args) {
        try {
            List<HomeworkItem> all = storage.getHomeworkByUser(chatId);
            if (args != null && args.length > 1 && args[1] != null && !args[1].trim().isEmpty()) {
                String dayOrSubject = args[1].trim();
                for (DayOfWeek d : DayOfWeek.values()) { //–µ—Å–ª–∏ –±—ã–ª –≤–≤–µ–¥—ë–Ω –¥–µ–Ω—å (–º–æ–Ω–¥—ç–π —Ç—å—é—Å–¥–µ–π –∏ —Ç.–¥.)
                    if (d.name().equalsIgnoreCase(dayOrSubject)) {
                        List<HomeworkItem> filtered = all.stream() // —Å–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º—É –¥–Ω—é
                                .filter(h -> h.getDueDate() != null && h.getDueDate().getDayOfWeek() == d)
                                .collect(Collectors.toList());// –ø–æ—Ç–æ–∫ –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Å–ø–∏—Å–æ–∫
                        return formatHomeworkList(filtered, "–î–ó –Ω–∞ " + d.name());
                    }
                }
                try {
                    LocalDate date = LocalDate.parse(dayOrSubject); // –Ω—É –∞ —Ç—É—Ç –µ—Å–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –¥–∞—Ç–∞ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
                    List<HomeworkItem> filtered = all.stream()
                            .filter(h -> h.getDueDate() != null && h.getDueDate().equals(date))
                            .collect(Collectors.toList());
                    return formatHomeworkList(filtered, "–î–ó –Ω–∞ " + date.toString());
                } catch (DateTimeParseException ignored) {
                    // –Ω–µ –¥–∞—Ç–∞ ‚Äî –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–∫ –ø—Ä–µ–¥–º–µ—Ç –∏ –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É
                    List<HomeworkItem> filtered = storage.getHomeworkBySubject(chatId, dayOrSubject);
                    return formatHomeworkList(filtered, "–î–ó –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É: " + dayOrSubject);
                }
            }

            return formatHomeworkList(all, "–í—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è");

        } catch (Exception e) {
            e.printStackTrace();
            return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π.";
        }
    }

    private String formatHomeworkList(List<HomeworkItem> list, String header) {
        StringBuilder sb = new StringBuilder();
        sb.append(header).append(":\n\n");
        if (list == null || list.isEmpty()) {
            sb.append(" ‚Äî –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –Ω–µ—Ç.");
            return sb.toString();
        }
        for (HomeworkItem item : list) {
            sb.append("ID: ").append(item.getId()).append(" | ")
                    .append(item.getSubject()).append(" ‚Äî ").append(item.getDescription())
                    .append(" (–¥–æ ").append(item.getDueDate()).append(") ")
                    .append(item.isCompleted() ? "‚úÖ" : "‚è≥")
                    .append("\n")
                    .append("\n");
        }
        return sb.toString();
    }
}
package bot.commands;

import bot.schedule.Schedule;
import bot.schedule.ScheduleManager; 
import bot.user.User;
import bot.user.UserStorage;

import java.time.DayOfWeek;
import java.util.List;
import java.util.Map;

public class ScheduleCommand implements Command {

    private final UserStorage userStorage;

    public ScheduleCommand(UserStorage userStorage) {
        this.userStorage = userStorage;
    }

    @Override
    public String getName() {
        return "/schedule";
    }

    @Override
    public String getInformation() {
        return "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å (/schedule Monday)";
    }

    @Override
    public String realization(String[] args) {
        return "–ß—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /schedule –∏–ª–∏ /schedule Monday";
    }


    public String realizationWithChatId(long chatId, String[] args) {
        try {
            User user = userStorage.getUser(chatId);
            if (user == null) {
                return "–í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start, —á—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.";
            }

            ScheduleManager manager = new ScheduleManager(userStorage); // —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –±–µ—Ä–µ–º —á–µ—Ä–µ–∑ –º–µ–Ω–µ–¥–∂—Ä–µ, –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –µ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ
            Schedule sched = manager.getScheduleForUser(chatId);
            manager.close();

            if (sched == null) {
                return "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≤–∞—à–µ–π –≥—Ä—É–ø–ø—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –û–Ω–æ –ª–∏–±–æ –µ—â—ë –Ω–µ –±—ã–ª–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, " +
                        "–ª–∏–±–æ –≥—Ä—É–ø–ø–∞ –Ω–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–≤—Ç–æ—Ä–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –∏–ª–∏ –ø–æ–¥–æ–∂–¥–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏.";
            }

            
            if (args.length > 1) {
                String dayArg = args[1].trim();

                DayOfWeek day = null;
                for (DayOfWeek d : DayOfWeek.values()) {
                    if (d.name().equalsIgnoreCase(dayArg)) { 
                        day = d;
                        break;
                    }
                }

                if (day == null) {
                    return "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–¥–∏–Ω –∏–∑: Monday, Tuesday, Wednesday, Thursday, Friday, Saturday, Sunday.";
                }

                String scheduleForDay = formatScheduleForDay(sched, day, user.getGroup());
                return scheduleForDay;
            }

            String out = formatScheduleForUser(sched); // –∏–Ω–∞—á–µ ‚Äî –≤—Å—ë —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            return out;

        } catch (Exception e) {
            e.printStackTrace();
            return "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: " + e.getMessage();
        }
    }


    private String formatScheduleForDay(Schedule sched, DayOfWeek day, String group) {
        StringBuilder sb = new StringBuilder();

        String key = day.toString(); // –≤ Schedule –∫–ª—é—á–∏ –≤ –≤–∏–¥–µ "MONDAY"
        
        sb.append("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã: ");

        String groupName = sched.getGroupName();
        if (groupName != null) {
            sb.append(groupName);
        }

        sb.append("\n\n");

        List<bot.schedule.Lesson> lessons = getLessonsIgnoreCase(sched, key); // –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–Ω—è—Ç–∏–π –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É –∫–ª—é—á–∞ –¥–Ω—è

        if (lessons == null || lessons.isEmpty()) {
            sb.append("  ‚Äî –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –ø–∞—Ä –Ω–µ—Ç\n\n");

        } else {
            lessons.forEach(lesson -> {

                String start;
                if (lesson.getStartTime() == null) {
                    start = "";
                } else {
                    start = lesson.getStartTime().toString();
                }

                String end;
                if (lesson.getEndTime() == null) {
                    end = "";
                } else {
                    end = lesson.getEndTime().toString();
                }

                String subject;
                if (lesson.getSubject() == null) {
                    subject = "";
                } else {
                    subject = lesson.getSubject();
                }

                sb.append("\nüìñ")
                  .append(start)
                  .append(" - ")
                  .append(end)
                  .append(" | ")
                  .append(subject);

                if (lesson.getClassroom() != null && !lesson.getClassroom().isEmpty()) {
                    sb.append(" (").append(lesson.getClassroom()).append(")");
                }

                sb.append("\n");
            });

            sb.append("\n\n\n");
        }

        return sb.toString();
    }

    private String formatScheduleForUser(Schedule sched) {
        StringBuilder sb = new StringBuilder();

        sb.append("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã: ");

        String groupName = sched.getGroupName();
        if (groupName != null) {
            sb.append(groupName);
        }

        sb.append("\n\n");

        List<DayOfWeek> days = List.of(
                DayOfWeek.MONDAY, DayOfWeek.TUESDAY, DayOfWeek.WEDNESDAY,
                DayOfWeek.THURSDAY, DayOfWeek.FRIDAY, DayOfWeek.SATURDAY, DayOfWeek.SUNDAY
        );

        for (DayOfWeek day : days) {
            String key = day.toString(); // –≤ Schedule –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–ª—é—á–∏ –≤ –≤–∏–¥–µ "MONDAY"
            sb.append("üåÖ");
            sb.append(day.toString()).append(":\n"); // –∑–∞–≥–æ–ª–æ–≤–æ–∫ –¥–Ω—è

            List<bot.schedule.Lesson> lessons = getLessonsIgnoreCase(sched, key); // –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ –∑–∞–Ω—è—Ç–∏–π –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É –∫–ª—é—á–∞ –¥–Ω—è

            if (lessons == null || lessons.isEmpty()) {
                sb.append("  ‚Äî –≤ —ç—Ç–æ—Ç –¥–µ–Ω—å –ø–∞—Ä –Ω–µ—Ç\n\n");

            } else {
                lessons.forEach(lesson -> {

                    String start;
                    if (lesson.getStartTime() == null) {
                        start = "";
                    } else {
                        start = lesson.getStartTime().toString();
                    }

                    String end;
                    if (lesson.getEndTime() == null) {
                        end = "";
                    } else {
                        end = lesson.getEndTime().toString();
                    }

                    String subject;
                    if (lesson.getSubject() == null) {
                        subject = "";
                    } else {
                        subject = lesson.getSubject();
                    }
                    sb.append("\nüìñ")
                            .append(start)
                            .append(" - ")
                            .append(end)
                            .append(" | ")
                            .append(subject);

                    if (lesson.getClassroom() != null && !lesson.getClassroom().isEmpty()) {
                        sb.append(" (").append(lesson.getClassroom()).append(")");
                    }

                    sb.append("\n");
                });
                sb.append("\n\n\n");
            }
        }
        return sb.toString();
    }


    private List<bot.schedule.Lesson> getLessonsIgnoreCase(Schedule sched, String dayKey) { // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∑–∞–Ω—è—Ç–∏–π –¥–ª—è –∫–ª—é—á–∞ dayKey, –∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ä–µ–≥–∏—Å—Ç—Ä –∫–ª—é—á–µ–π
        if (sched == null || sched.getWeeklySchedule() == null) return List.of();

        Map<String, List<bot.schedule.Lesson>> map = sched.getWeeklySchedule();

        // –ü—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–π –ø–æ–∏—Å–∫
        if (map.containsKey(dayKey) && map.get(dayKey) != null) {
            return map.get(dayKey);
        }

        // –ò—â–µ–º –Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É
        for (String k : map.keySet()) {
            if (k != null && k.equalsIgnoreCase(dayKey)) {
                return map.get(k);
            }
        }

        return List.of();
    }
}package bot.commands;

import bot.user.User;
import bot.user.UserStorage;

import java.net.URLEncoder;
import java.nio.charset.StandardCharsets;
import java.util.Base64;

public class ShareGroupCommand implements Command {

    private final UserStorage userStorage;
    private final String botUsername;
    private final int expiryDays; // —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è —Å—Å—ã–ª–∫–∏ –≤ –¥–Ω—è—Ö

    public ShareGroupCommand(UserStorage userStorage, String botUsername, int expiryDays) {
        this.userStorage = userStorage;
        this.botUsername = botUsername;
        this.expiryDays = expiryDays;
    }

    @Override
    public String getName() { return "/sharegroup"; }

    @Override
    public String getInformation() { return "–°–æ–∑–¥–∞—Ç—å deep-link –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (–ø–æ–¥–µ–ª–∏—Ç—å—Å—è —Å–≤–æ–µ–π –≥—Ä—É–ø–ø–æ–π)"; }

    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: /sharegroup ‚Äî —Å–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ (–¥–µ–π—Å—Ç–≤—É–µ—Ç " + expiryDays + " –¥–Ω–µ–π)";
    }

    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∏–∑ Homeworkbot –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ /sharegroup
    public String start(long chatId) {
        User user = userStorage.getUser(chatId);
        if (user == null) return "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è.";
        String group = user.getGroup();
        if (group == null || group.trim().isEmpty()) return "‚ùå –£ –≤–∞—Å –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.";

        try {
            long inviter = chatId;
            // –§–æ—Ä–º–∏—Ä—É–µ–º JSON ‚Äî —Ç–æ–ª—å–∫–æ inviter.
            String json = String.format("{\"inviter\":%d}", inviter);

            // Base64 –≤ URLEncode
            String base64 = Base64.getEncoder().encodeToString(json.getBytes(StandardCharsets.UTF_8));
            String urlSafe = URLEncoder.encode(base64, StandardCharsets.UTF_8);

            String startParam = "invite_" + urlSafe;
            String link = "https://t.me/" + botUsername + "?start=" + startParam;

            return "‚úÖ –°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∞:\n" +
                    link +
                    "\n\n–ï—Å–ª–∏ –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –ø–æ —Å—Å—ã–ª–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, " +
                    "—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É —Å–æ–æ–±—â–µ–Ω–∏–µ:\n" +
                    "/start " + startParam;
        } catch (Exception e) {
            e.printStackTrace();
            return "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.";
        }
    }
}
package bot.commands;

import bot.schedule.*;
import bot.user.*;
import bot.fsm.DialogState;


import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardMarkup;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardButton;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.buttons.KeyboardRow;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardRemove;

import java.util.*; //—á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Map, List 

public class StartCommand implements Command {
    private final UserStorage userStorage; // –æ–±—ä—è–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –æ–±—ä–µ–∫—Ç, –∫–æ—Ç–æ—Ä—ã–π —Ä–µ–∞–ª–∏–∑—É–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

    private static final Map<String, List<String>> INSTITUTE_DEPARTMENTS = new HashMap<>();

    static {
        INSTITUTE_DEPARTMENTS.put("–ò–ï–ù–∏–ú", List.of("–®–ù", "–®–ë"));
        INSTITUTE_DEPARTMENTS.put("–ò–Ω–≠–£", List.of("–®–ì–£–ü", "–®–£–ú–ò", "–®–≠–ú (–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç)"));
        INSTITUTE_DEPARTMENTS.put("–ò–§–ö–°–∏–ú–ü", List.of());
        INSTITUTE_DEPARTMENTS.put("–£–ì–ò", List.of("–ò", "–§", "–ñ", "–ò–ö–∏–î", "–ü–∏–°", "–ü", "–ú–û", "–õ", "–®–ê–∏–ü–†"));
        INSTITUTE_DEPARTMENTS.put("–ò–†–ò–¢-–†—Ç–§", List.of("–®–ë", "–®–ü–∏–ê–û"));
        INSTITUTE_DEPARTMENTS.put("–ò–ù–ú–¢", List.of("–°–ú", "–ú–∏–ú", "–ú", "–ù–ú–∏–¢ (–∏–Ω—Å—Ç–∏—Ç—É—Ç)"));
        INSTITUTE_DEPARTMENTS.put("–£—Ä–∞–ª–≠–ù–ò–ù", List.of());
        INSTITUTE_DEPARTMENTS.put("–§–¢–ò", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–ò–°–ê", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–•–¢–ò", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–ò–¢–û–û", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–ü–û–¥–ò–£", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–ë–ü–£–†", List.of("-"));
        INSTITUTE_DEPARTMENTS.put("–£–ü–ò–®", List.of("-"));
    }

    public StartCommand(UserStorage userStorage) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–ª–∞—Å—Å–∞ 
        this.userStorage = userStorage;
    }

    
    @Override
    public String getName() {
        return "/start";
    }

    
    @Override
    public String getInformation() {
        return "–ù–∞—á–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ —Å–∏—Å—Ç–µ–º–µ";
    }

    
    @Override
    public String realization(String[] args) {
        return "–î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤–≤–µ–¥–∏—Ç–µ /start –≤ —á–∞—Ç–µ —Å –±–æ—Ç–æ–º";
    }

   
    public SendMessage processStart(long chatId) { // –º–µ—Ç–æ–¥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥
        try {
            User user = userStorage.getUser(chatId); // –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–¥
            
            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å –∏ —É –Ω–µ–≥–æ –±—ã–ª–æ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ
            ScheduleManager sm = new ScheduleManager(userStorage); // —Å–æ–∑–¥–∞–µ–º –º–µ–Ω–µ–¥–∂–µ—Ä —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
            if (sm.customScheduleExists(chatId)) { // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
                sm.resetToOriginalSchedule(chatId); // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º (—É–¥–∞–ª—è–µ–º –∫–∞—Å—Ç–æ–º –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ)
                System.out.println("–ö–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ /start –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + chatId);
            }
            sm.close(); // –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–∞–º–∏
            
            if (user == null) {
                user = new User(chatId);
                userStorage.saveUser(user);
                return createMessage(chatId, 
                    "–ü—Ä–∏–≤–µ—Ç-–ø—Ä–∏–≤–µ—Ç! ‚ú®\n –Ø —Ç–≤–æ–π –Ω–æ–≤—ã–π –¥—Ä—É–≥-–±–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–∂–µ—Ç –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –Ω–∏ –æ–¥–Ω–æ–π –ø–∞—Ä—ã –∏ –Ω–∏ –æ–¥–Ω–æ–≥–æ –¥–µ–¥–ª–∞–π–Ω–∞! \n\n" +
                    "üìã –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è: –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è");
            }
            
            if (user.getState() ==  DialogState.REGISTERED) { // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –æ–Ω –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
                String userInfo = "üéì –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!\n\n" +
                                 "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                                 "–ò–º—è: " + user.getName() + "\n" +
                                 "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                                 "–ò–Ω—Å—Ç–∏—Ç—É—Ç: " + user.getUniversity() + "\n" +
                                 "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                                 "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                                 "–•–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è?";
                
                user.setWaitingForButton(true);
                userStorage.updateUser(user);
                
                return createMessageWithDynamicButtons(chatId, userInfo, List.of("–î–ê", "–ù–ï–¢")); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏
            } else { // –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                return continueRegistration(chatId, user);
            }
            
        } catch (Exception e) {
            e.printStackTrace();
            return createMessage(chatId, "‚ùå‚ùå‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã");
        }
    }

 
    public SendMessage processButtonResponse(long chatId, String messageText) { // –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã –Ω–∞ –∫–Ω–æ–ø–∫–∏ –¥–∞ –Ω–µ—Ç
        try {
            User user = userStorage.getUser(chatId);

            user.setWaitingForButton(false); // —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
            
            if (messageText.equalsIgnoreCase("–î–ê")) {
                user.setState(DialogState.ASK_NAME);
                userStorage.updateUser(user); // –æ–±–Ω–æ–≤–∏–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                return createMessage(chatId, 
                    "–ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö!\n\n" +
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –Ω–æ–≤–æ–µ –∏–º—è:");
            } else if (messageText.equalsIgnoreCase("–ù–ï–¢")) {
                userStorage.updateUser(user); 
                return createMessage(chatId, 
                    "–û—Ç–ª–∏—á–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã.\n\n" +
                    "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞.\n" +
                    "–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∫–æ–º–∞–Ω–¥.");
            } 
            
            return processRegistration(chatId, messageText);
            
        } catch (Exception e) {
            e.printStackTrace();
            return createMessage(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ");
        }
    }

    
    private SendMessage continueRegistration(long chatId, User user) {  // –ú–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        switch (user.getState()) {
            case ASK_NAME:
                return createMessage(chatId, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
            case ASK_GROUP:
                return createMessage(chatId, 
                    "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–ï–ù-241001):");
            default:
                return createMessage(chatId, "‚ùå‚ùå‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ /start");
        }
    }


    public SendMessage processRegistration(long chatId, String messageText) { // –ú–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        try {
            User user = userStorage.getUser(chatId); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            
            switch (user.getState()) {
            case ASK_NAME:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
                }
                user.setName(messageText.trim()); 
                user.setState(DialogState.ASK_GROUP); 
                userStorage.updateUser(user); 
                return createMessage(chatId, 
                    "–û—Ç–ª–∏—á–Ω–æ, " + messageText.trim() + "!\n\n" +
                    "–¢–µ–ø–µ—Ä—å –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–ï–ù-241001):");
                
            case ASK_NAME_INVITE:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:");
                }
                user.setName(messageText.trim()); 
                user.setState(DialogState.REGISTERED); // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é —Å—Ä–∞–∑—É
                userStorage.updateUser(user);
                
                // –ü–æ–ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –ë–î
                try {
                    ScheduleFetcher fetcher = new ScheduleFetcher();
                    Schedule schedule = fetcher.fetchForUser(user);
                    if (schedule != null) {
                        ScheduleManager sm = new ScheduleManager(userStorage);
                        sm.saveCommonSchedule(schedule);
                        sm.close();
                        return createMessage(chatId,
                            "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                            "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                            "–ò–º—è: " + user.getName() + "\n" +
                            "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                            "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç: " + user.getUniversity() + "\n" +
                            "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                            "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                            "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n" +
                            "–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.");
                    }
                } catch (Exception e) {
                    e.printStackTrace();
                }

                return createMessage(chatId, 
                    "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                    "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                    "–ò–º—è: " + user.getName() + "\n" +
                    "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                    "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç: " + user.getUniversity() + "\n" +
                    "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                    "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                    "–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å!\n" +
                    "–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.");
                    
            case ASK_GROUP:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ì—Ä—É–ø–ø–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à—É –≥—Ä—É–ø–ø—É:");
                }
                user.setGroup(messageText.trim());
                user.setState(DialogState.ASK_UNIVERSITY);
                userStorage.updateUser(user);
                return createMessageWithDynamicButtons(chatId, // —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–∞–º–∏ 
                    "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∏–Ω—Å—Ç–∏—Ç—É—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:",
                    new ArrayList<>(INSTITUTE_DEPARTMENTS.keySet())); // keyset –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–∞–±–æ—Ä –∫–ª—é—á–µ–π (–≤—Å–µ –Ω–∞–∑–≤–∞–Ω–∏—è –∏–Ω—Å—Ç–∏—Ç—É—Ç–æ–≤)

            case ASK_UNIVERSITY:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞:");
                } 

                String universityInput = messageText.trim();
                user.setUniversity(universityInput);
                user.setState(DialogState.ASK_DEPARTMENT);
                userStorage.updateUser(user);

                if (INSTITUTE_DEPARTMENTS.containsKey(universityInput)) { // –≤—ã–≤–æ–¥–∏–º —Ç–æ–ª—å–∫–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã, –æ—Ç–Ω–æ—Å—è—â–∏–µ—Å—è –∫ –∏–Ω—Å—Ç–∏—Ç—É—Ç—É
                    List<String> deps = INSTITUTE_DEPARTMENTS.get(universityInput);
                    if (!deps.isEmpty()) {
                        return createMessageWithDynamicButtons(chatId,
                            "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:",
                            deps);
                    }
                }

                return createMessage(chatId, 
                    "–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∞—à–µ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞:");

            case ASK_DEPARTMENT:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç:");
                }
                
                user.setDepartment(messageText.trim());
                user.setState(DialogState.ASK_COURSE);
                userStorage.updateUser(user);
                
                List<String> courses = List.of("1", "2", "3", "4", "5", "6");
                
                return createMessageWithDynamicButtons(chatId, "–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é:", courses);

            case ASK_COURSE:
                if (messageText.trim().isEmpty()) {
                    return createMessage(chatId, "‚ùå‚ùå‚ùå –ö—É—Ä—Å –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º. –í–≤–µ–¥–∏—Ç–µ –∫—É—Ä—Å:");
                }

                user.setCourse(messageText.trim());
                userStorage.updateUser(user);

                try {
                    ScheduleFetcher fetcher = new ScheduleFetcher();
                    Schedule schedule = fetcher.fetchForUser(user);

                    if (schedule != null) {
                        ScheduleManager sm = new ScheduleManager(userStorage);
                        sm.saveCommonSchedule(schedule);
                        sm.close();

                        user.setState(DialogState.REGISTERED);
                        userStorage.updateUser(user);

                        return createMessage(chatId,
                            "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                            "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                            "–ò–º—è: " + user.getName() + "\n" +
                            "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                            "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç: " + user.getUniversity() + "\n" +
                            "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                            "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                            "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ!\n" +
                            "–í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥.");
                    } else {
                        user.setState(DialogState.REGISTERED);
                        userStorage.updateUser(user);

                        return createMessage(chatId,
                            "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                            "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.\n" +
                            "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –≤–≤–µ–¥—ë–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–≥—Ä—É–ø–ø–∞/–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç/–∫—É—Ä—Å).");
                    }

                } catch (bot.user.exception.ScheduleFetchException sfe) {

                    String errMsg = sfe.getMessage();
                    if (sfe.getMessage() == null) {
                        errMsg = "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ.";
                    } 
                    String lower = errMsg.toLowerCase();
                    String hint = "";

                    if (lower.contains("–≥—Ä—É–ø–ø–∞")) {
                        hint = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–ì—Ä—É–ø–ø–∞¬ª.";
                    } 
                    else if (lower.contains("–¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç")) {
                        hint = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç¬ª.";
                    } 
                    else if (lower.contains("–∫—É—Ä—Å")) {
                        hint = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–ö—É—Ä—Å¬ª.";
                    } 
                    else if (lower.contains("—É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç")) {
                        hint = "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ ¬´–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç¬ª.";
                    }

                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);

                    return createMessage(chatId,
                        "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                        "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:\n" +
                        "–ò–º—è: " + user.getName() + "\n" +
                        "–ì—Ä—É–ø–ø–∞: " + user.getGroup() + "\n" +
                        "–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç: " + user.getUniversity() + "\n" +
                        "–î–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç: " + user.getDepartment() + "\n" +
                        "–ö—É—Ä—Å: " + user.getCourse() + "\n\n" +
                        "‚ö†Ô∏è –û–¥–Ω–∞–∫–æ: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: " + errMsg + "\n" +
                        hint + " –ï—Å–ª–∏ –≤—ã —É–≤–µ—Ä–µ–Ω—ã –≤ –¥–∞–Ω–Ω—ã—Ö, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
                } catch (Exception e) {

                    e.printStackTrace();
                    user.setState(DialogState.REGISTERED);
                    userStorage.updateUser(user);

                    return createMessage(chatId,
                        "üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n\n" +
                        "–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –Ω–æ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.");
                }

                    
            default:
                return createMessage(chatId, "‚ùå‚ùå‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ. –í–≤–µ–¥–∏—Ç–µ /start");
            }
        } catch (Exception e) {
            e.printStackTrace();
            return createMessage(chatId, "‚ùå‚ùå‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ");
        }
    }


    // –º–µ—Ç–æ–¥ –¥–ª—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏—Ö –∫–Ω–æ–ø–æ–∫ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–Ω—Å—Ç–∏—Ç—É—Ç—ã –∏–ª–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç—ã)
    private SendMessage createMessageWithDynamicButtons(long chatId, String text, List<String> options) {
        SendMessage message = new SendMessage(String.valueOf(chatId), text);

        ReplyKeyboardMarkup keyboardMarkup = new ReplyKeyboardMarkup(); // ReplyKeyboardMarkup - –∫–ª–∞—Å—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–≤ tg api)
        keyboardMarkup.setResizeKeyboard(true); // —Ä–∞–∑–º–µ—Ä –∫–Ω–æ–ø–æ–∫ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –ø–æ–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        keyboardMarkup.setOneTimeKeyboard(true); // –°–∫—Ä—ã–≤–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –ø–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è

        List<KeyboardRow> keyboard = new ArrayList<>(); // –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å—Ç—Ä–æ–∫ –∫–Ω–æ–ø–æ–∫

        KeyboardRow currentRow = new KeyboardRow(); // KeyboardRow - –∫–ª–∞—Å—Å –¥–ª—è –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ 1 —Å—Ç—Ä–æ–∫–∏ –∫–Ω–æ–ø–æ–∫
        for (int i = 0; i < options.size(); i++) { // –ø—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∫–Ω–æ–ø–∫–∞–º–∏
            currentRow.add(new KeyboardButton(options.get(i))); // –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∫–Ω–æ–ø–∫–∞ –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ —Å—Ç—Ä–æ–∫—É

            if ((i + 1) % 2 == 0 || i == options.size() - 1) { // –ø–µ—Ä–≤–æ–µ —ç—Ç–æ —É—Å–ª–æ–≤–∏–µ, —á—Ç–æ –∫–∞–∂–¥—ã–µ 2 –∫–Ω–æ–ø–∫–∏ –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞, –∞ –≤—Ç–æ—Ä–æ–µ —ç—Ç–æ –µ—Å–ª–∏ –æ—Å—Ç–∞–ª–∞—Å—å 1 –∫–Ω–æ–ø–∫–∞
                keyboard.add(currentRow); // –¥–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ –∫–ª–∞–∏–≤–∏–∞—Ç—É—Ä—É
                currentRow = new KeyboardRow(); // –¥–µ–ª–∞–µ–º –Ω–æ–≤—É—é –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            }
        }

        keyboardMarkup.setKeyboard(keyboard); // keyboardMarkup –º–µ—Ç–æ–¥ –∫–ª–∞—Å—Å–∞ ReplyKeyboardMarkup - —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–Ω–æ–ø–æ–∫ (–∏—Ö –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ)
        message.setReplyMarkup(keyboardMarkup);
        return message;
    }

    private SendMessage createMessage(long chatId, String text) { // —Å–æ–∑–¥–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        SendMessage message = new SendMessage();
        message.setChatId(String.valueOf(chatId)); // –ø–µ—Ä–µ–≤–æ–¥–∏–º Id –≤ —á–∏—Å–ª–æ
        message.setText(text);
        
     // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ñ–∏–Ω–∞–ª—å–Ω—ã–º
        boolean isFinalMessage = 
            text.contains("‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ") ||
            text.contains("‚úÖ –ü–∞—Ä–∞ —É—Å–ø–µ—à–Ω–æ") ||
            text.contains("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞") ||
            text.contains("üéì –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞") ||
            text.contains("–û—Ç–ª–∏—á–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã") ||
            (text.contains("–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ:") && text.contains("–ò–º—è:") && text.contains("–ì—Ä—É–ø–ø–∞:"));
        
        if (isFinalMessage) {
            ReplyKeyboardRemove keyboardRemove = new ReplyKeyboardRemove();
            keyboardRemove.setRemoveKeyboard(true);
            message.setReplyMarkup(keyboardRemove);
        }
        
        return message;
    }


    public boolean isUserInRegistration(long chatId) { // –ø—Ä–æ–≤–µ—Ä–∫–∞, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        User user = userStorage.getUser(chatId);
        if (user == null) return false;
        DialogState s = user.getState();
        return s == DialogState.ASK_NAME  // –Ø–≤–Ω–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è:
            || s == DialogState.ASK_GROUP
            || s == DialogState.ASK_UNIVERSITY
            || s == DialogState.ASK_DEPARTMENT
            || s == DialogState.ASK_COURSE
            || s == DialogState.ASK_NAME_INVITE
            || s == DialogState.WAITING_BUTTON;
    }


    public boolean isWaitingForButtonResponse(long chatId) { // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –æ–∂–∏–¥–∞–µ—Ç –ª–∏ –±–æ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∏
        User user = userStorage.getUser(chatId);  
        if (user != null &&  user.getWaitingForButton()) {
            return true;
        } else {
            return false;
        }
    }
}package bot.commands;

import bot.user.User;
import bot.user.UserStorage;

public class SubscriptionCommand implements Command {
    
    private final UserStorage userStorage;
    
    public SubscriptionCommand(UserStorage userStorage) {
        this.userStorage = userStorage;
    }
    
    @Override
    public String getName() {
        return "/subscription";
    }
    
    @Override
    public String getInformation() {
        return "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π –Ω–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n" +
               "/subscription on - –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n" +
               "/subscription off - –≤—ã–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n" +
               "/subscription status - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏";
    }
    
    @Override
    public String realization(String[] args) {
        return "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:\n" +
               "/subscription on - –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n" +
               "/subscription off - –≤—ã–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n" +
               "/subscription status - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏";
    }
    
    public String realizationWithChatId(long chatId, String[] args) {
        User user = userStorage.getUser(chatId);
        if (user == null) {
            return "‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.";
        }
        
        if (args.length < 2) {
            return realization(args);
        }
        
        String action = args[1].toLowerCase();
        
        switch (action) {
            case "on":
            case "–≤–∫–ª":
            case "–≤–∫–ª—é—á–∏—Ç—å":
                user.setSubscriptionEnabled(true);
                userStorage.updateUser(user);
                return "‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã! –í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –î–ó.";
                
            case "off":
            case "–≤—ã–∫–ª":
            case "–≤—ã–∫–ª—é—á–∏—Ç—å":
                user.setSubscriptionEnabled(false);
                userStorage.updateUser(user);
                return "üîï –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã.\n –í—ã –±–æ–ª—å—à–µ –Ω–µ –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è.\n" +
                       "–ß—Ç–æ–±—ã –≤–∫–ª—é—á–∏—Ç—å —Å–Ω–æ–≤–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /subscription on";
                
            case "status":
            case "—Å—Ç–∞—Ç—É—Å":
                boolean isEnabled = user.getSubscriptionEnabled();
                return isEnabled ? 
                    "üì¢ –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: –í–ö–õ–Æ–ß–ï–ù–ê\n–í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –î–ó." :
                    "üîï –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: –í–´–ö–õ–Æ–ß–ï–ù–ê\n–í—ã –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç–µ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è.";
                    
            default:
                return "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:\n" +
                       "/subscription on - –≤–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n" +
                       "/subscription off - –≤—ã–∫–ª—é—á–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n" +
                       "/subscription status - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏";
        }
    }
}package bot.fsm;

public enum DialogState {

    ASK_NAME, // –∂–¥—ë–º –∏–º—è
    ASK_GROUP, // –∂–¥—ë–º –≥—Ä—É–ø–ø—É
    ASK_UNIVERSITY, // –∂–¥—ë–º —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç
    ASK_DEPARTMENT, // –∂–¥—ë–º —Ñ–∞–∫—É–ª—å—Ç–µ—Ç
    ASK_COURSE, // –∂–¥—ë–º –∫—É—Ä—Å
    WAITING_BUTTON, // –∂–¥—ë–º –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏
    REGISTERED,   // —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
    
    EDIT_DAY,// –≤—ã–±—Ä–∞–ª–∏ –¥–µ–Ω—å
    EDIT_CHOOSE_ACTION, // –æ–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç –Ω–∞ –∫–Ω–æ–ø–∫–∏ —É–¥–∞–ª–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å
    ASK_LESSON_INDEX, // –∂–¥–µ–º –Ω–æ–º–µ—Ä –ø–∞—Ä—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    ASK_SUBJECT, // –∂–¥–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
    ASK_ROOM, // —É–∑–Ω–∞–µ–º –Ω–æ–º–µ—Ä –∞—É–¥–∏—Ç–æ—Ä–∏–∏
    ASK_TIME_BEGIN, // —É–∑–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
    ASK_TIME_END, // —É–∑–Ω–∞–µ–º –≤—Ä–µ–º—è –∫–æ–Ω—Ü–∞
    
    ASK_NAME_INVITE,

    ASK_HW_SUBJECT,   // –æ–∂–∏–¥–∞–Ω–∏–µ: –≤–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–¥–º–µ—Ç (–∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–∞—Ä—ã)
    ASK_HW_TIME,      // –æ–∂–∏–¥–∞–Ω–∏–µ: –≤–≤–µ–¥–∏—Ç–µ –¥–∞—Ç—É YYYY-MM-DD –∏–ª–∏ –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ (MONDAY)
    ASK_HW_REMIND,
    ASK_HW_DESCRIPTION, // –∂–¥—ë–º –∏–º—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏–Ω–≤–∞–π—Ç–æ–º

}package bot.fsm;

import bot.commands.AddHomeworkCommand;
import bot.commands.StartCommand;
import bot.commands.EditScheduleCommand;
import bot.commands.InviteHandler; 
import bot.user.User;
import bot.user.UserStorage;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;

public class DialogStateMachine {

    private final UserStorage userStorage;
    private final StartCommand startCommand;
    private final EditScheduleCommand editScheduleCommand;
    private final InviteHandler inviteHandler;
    private final AddHomeworkCommand addHomeworkCommand;


    // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä 
    public DialogStateMachine(UserStorage userStorage, StartCommand startCommand,
                              EditScheduleCommand editScheduleCommand, InviteHandler inviteHandler, AddHomeworkCommand addHomeworkCommand) {
        this.userStorage = userStorage;
        this.startCommand = startCommand;
        this.editScheduleCommand = editScheduleCommand;
        this.inviteHandler = inviteHandler;
        this.addHomeworkCommand = addHomeworkCommand;
    }
    

    public SendMessage handleInput(long chatId, String messageText) {
        // --- –æ–±—Ä–∞–±–æ—Ç–∫–∞ deep-link (invite) –¥–ª—è –ª—é–±–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–æ–≤–æ–≥–æ –∏–ª–∏ —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ) ---
        if (messageText != null && messageText.startsWith("/start ")) {
            SendMessage reply = inviteHandler.tryProcessInvite(chatId, messageText);
            if (reply != null) {
                return reply; // –∏–Ω–≤–∞–π—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω ‚Äî –≤—ã—Ö–æ–¥–∏–º
            }
        }

        User user = userStorage.getUser(chatId);

        // –ö–æ–º–∞–Ω–¥–∞ /start –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–µ
        if (messageText != null && messageText.equalsIgnoreCase("/start")) {
            return startCommand.processStart(chatId);
        }


        if (user.getWaitingForButton() && messageText != null) {
            return startCommand.processButtonResponse(chatId, messageText);
        }
        
        
        if (user.getState() == bot.fsm.DialogState.ASK_NAME_INVITE) {
            return startCommand.processRegistration(chatId, messageText);
        }
        

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (state != REGISTERED) ‚Äî –Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ StartCommand.processRegistration
        if (startCommand.isUserInRegistration(chatId)) {
            return startCommand.processRegistration(chatId, messageText);
        }

        // –ö–æ–º–∞–Ω–¥–∞ /editschedule (–Ω–∞—á–∞–ª–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
        if (messageText != null && messageText.toLowerCase().startsWith("/editschedule")) {
            String[] args = messageText.split("\\s+");
            return editScheduleCommand.processChange(chatId, args);
        }

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è ‚Äî –Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –≤ EditScheduleCommand.processEdit
        switch (user.getState()) {
            case EDIT_CHOOSE_ACTION:
            case ASK_SUBJECT:
            case ASK_ROOM:
            case ASK_TIME_BEGIN:
            case ASK_TIME_END:
            case ASK_LESSON_INDEX:
                return editScheduleCommand.processEdit(chatId, messageText);

            case ASK_HW_SUBJECT:
            case ASK_HW_TIME:
            case ASK_HW_DESCRIPTION:
            case ASK_HW_REMIND: {
                // –î–æ–ø. –∑–∞—â–∏—Ç–∞: –Ω–µ –ø–æ–∑–≤–æ–ª—è–µ–º –Ω–µ–∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å (–Ω–∞ —Å–ª—É—á–∞–π —Ä–∞—Å—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏)
                if (user.getState() != DialogState.REGISTERED
                        && !(user.getState() == DialogState.ASK_HW_SUBJECT
                        || user.getState() == DialogState.ASK_HW_TIME
                        || user.getState() == DialogState.ASK_HW_DESCRIPTION
                        || user.getState() == DialogState.ASK_HW_REMIND)) {
                    return sendSimple(chatId, "‚ùå –î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è –≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start.");
                }
                SendMessage reply = addHomeworkCommand.handleStateMessage(chatId, messageText);
                return reply;
            }
            case REGISTERED:
            default:
                return sendSimple(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥");
        }
    }

    private SendMessage sendSimple(long chatId, String text) {
        return new SendMessage(String.valueOf(chatId), text);
    }
}
package bot.homework;

import java.time.LocalDate;

// –ö–ª–∞—Å—Å –æ–ø–∏—Å—ã–≤–∞–µ—Ç –æ–¥–Ω–æ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

public class HomeworkItem {
    
    private long id;  // –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏ –≤ –±–¥ (—á—Ç–æ–±—ã –Ω—É–º–µ—Ä–æ–≤–∞—Ç—å –¥–∑ –æ–¥–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –æ–¥–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É)
    private long chatId;
    private String subject; // –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
    private String description; // —Å–∞–º–æ –¥–∑
    private LocalDate dueDate; // –¥–∞—Ç–∞, –∫ –∫–æ—Ç–æ—Ä–æ–π –Ω—É–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å
    private boolean completed; // —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 
    private int remindBeforeDays; // –∑–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –¥–æ —Å–¥–∞—á–∏ –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–µ–¥–ª–∞–π–Ω–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–µ–Ω—å)


    public HomeworkItem(long id, long chatId, String subject, String description,
                        LocalDate dueDate, boolean completed, int remindBeforeDays) {
        this.id = id;
        this.chatId = chatId;
        this.subject = subject;
        this.description = description;
        this.dueDate = dueDate;
        this.completed = completed;
        this.remindBeforeDays = remindBeforeDays;
    }


    public long getId() {
    	return id; 
    	} 
    
    public long getChatId() { 
    	return chatId; 
    	} 
    
    public String getSubject() { 
    	return subject; 
    	} 
    
    public String getDescription() { 
    	return description;
    	} 
    
    public LocalDate getDueDate() { 
    	return dueDate; 
    	}
    public boolean isCompleted() { 
    	return completed;
    	} 
    public int getRemindBeforeDays() { 
    	return remindBeforeDays; 
    	} 

    public void setSubject(String subject) {
    	this.subject = subject;
    	} 
    
    public void setDescription(String description) { 
    	this.description = description; 
    	} 
    
    public void setDueDate(LocalDate dueDate) {
    	this.dueDate = dueDate;
    	} 
    public void setCompleted(boolean completed) {
    	this.completed = completed; 
    	}
    public void setRemindBeforeDays(int remindBeforeDays) { 
    	this.remindBeforeDays = remindBeforeDays;
    	} 


    @Override
    public String toString() {
        return String.format(
            "[%s] %s ‚Äî %s (–¥–æ %s)%s",
            subject, // –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
            description, // —Å–∞–º–æ –∑–∞–¥–∞–Ω–∏–µ
            completed ? "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ" : "‚è≥ –ù–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ", // —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
            dueDate, // –¥–∞—Ç–∞ –¥–µ–¥–ª–∞–π–Ω–∞
            remindBeforeDays > 0 ? " üîî –ù–∞–ø–æ–º–Ω–∏—Ç—å –∑–∞ " + remindBeforeDays + " –¥–Ω." : "" // –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ ‚Äî –≤—ã–≤–µ—Å—Ç–∏
        );
    }
}
package bot.homework;

import java.sql.*;
import java.time.LocalDate;

public class HomeworkLinkStorage { // —Ä–µ–∞–ª–∏–∑—É–µ—Ç —Å–≤—è–∑—å

    private static final String DB_URL = "jdbc:sqlite:homework.db";

    public HomeworkLinkStorage() {
        init();
    }

    private void init() {
        String sql = "CREATE TABLE IF NOT EXISTS homework_link (" +
                "homework_id INTEGER PRIMARY KEY, " +
                "schedule_day TEXT, " +
                "lesson_index INTEGER)";
        try (Connection c = DriverManager.getConnection(DB_URL); Statement st = c.createStatement()) {
            st.execute(sql);
        } catch (SQLException e) {
            throw new RuntimeException(e);
        }
    }

    public void linkLatestHomeworkByUserSubjectDate(long userId, String subject, LocalDate dueDate,
            String scheduleDay, Integer lessonIndex) throws SQLException {
    	String find = "SELECT id FROM homework WHERE chatId = ? AND subject = ? AND dueDate = ? ORDER BY id DESC LIMIT 1"; //–ø–æ–∏—Å–∫ –¥–∑
        try (Connection connection = DriverManager.getConnection(DB_URL);
             PreparedStatement ps = connection.prepareStatement(find)) { //–¥–µ–ª–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞—ë–º –∑–∞–ø—Ä–æ—Å
            ps.setLong(1, userId);
            ps.setString(2, subject);
            ps.setString(3, dueDate != null ? dueDate.toString() : null);
            try (ResultSet result = ps.executeQuery()) { //–æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ–º —Å–≤—è–∑—å –º–µ–∂–¥—É –¥–∑ –∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º, –∑–¥–µ—Å—å –ø–æ–ª—É—á–∞–µ–º –µ—ë ID
                if (result.next()) { //–µ—Å–ª–∏ –¥–∑ –±—ã–ª–æ —Å–æ–∑–¥–∞–Ω–æ
                    long hwId = result.getLong("id");
                    String upsert = "INSERT OR REPLACE INTO homework_link(homework_id, schedule_day, lesson_index) VALUES (?, ?, ?)"; //–≤—Å—Ç–∞–≤–∫–∞ –∏–ª–∏ –∑–∞–º–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü—ã
                    try (PreparedStatement ps2 = connection.prepareStatement(upsert)) { //–æ–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É
                        ps2.setLong(1, hwId);
                        ps2.setString(2, scheduleDay);
                        if (lessonIndex == null) ps2.setNull(3, Types.INTEGER);
                        else ps2.setInt(3, lessonIndex);
                        ps2.executeUpdate();
                    }
                }
            }
        }
    }
    public void unlinkHomework(long homeworkId) {
        String sql = "DELETE FROM homework_link WHERE homework_id = ?";
        try (Connection connection = DriverManager.getConnection(DB_URL);
             PreparedStatement ps = connection.prepareStatement(sql)) {
            ps.setLong(1, homeworkId);
            ps.executeUpdate();
        } catch (SQLException e) {
            throw new RuntimeException("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–≤—è–∑–∏ homework_link", e);
        }
    }

}
package bot.homework;

import java.sql.*;
import java.time.LocalDate;

public class HomeworkService { //–¥–æ–±–∞–≤–ª—è–µ—Ç –¥–∑ –≤ –ë–î –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è ID

    private static final String DB_URL = "jdbc:sqlite:homework.db";
    private final SQLiteHomeworkStorage delegate;

    public HomeworkService(SQLiteHomeworkStorage delegate) {
        this.delegate = delegate;
    }

    public long addHomeworkAndReturnId(long chatId, String subject, String description, LocalDate dueDate, int remindBeforeDays) throws SQLException {
        delegate.addHomework(chatId, subject, description, dueDate, remindBeforeDays);

        String sql = "SELECT id FROM homework WHERE chatId = ? AND subject = ? AND dueDate = ? ORDER BY id DESC LIMIT 1";
        try (Connection conn = DriverManager.getConnection(DB_URL);
             PreparedStatement ps = conn.prepareStatement(sql)) {
            ps.setLong(1, chatId);
            ps.setString(2, subject);
            ps.setString(3, dueDate != null ? dueDate.toString() : null);
            try (ResultSet rs = ps.executeQuery()) {
                if (rs.next()) {
                    return rs.getLong("id");
                } else {
                    return -1L;
                }
            }
        }
    }
}
package bot.homework;

import java.time.LocalDate;
import java.util.List;


public interface HomeworkStorage {

    void initialize();
	
    void addHomework(long chatId, String subject, String description, LocalDate dueDate, int remindBeforeDays); // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ

    List<HomeworkItem> getHomeworkByUser(long chatId); // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    List<HomeworkItem> getHomeworkBySubject(long chatId, String subject); // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É 

    void updateHomework(long id, String newSubject, String newDescription, LocalDate newDueDate); // –û–±–Ω–æ–≤–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –∑–∞–¥–∞–Ω–∏–µ (–æ–ø–∏—Å–∞–Ω–∏–µ, –¥–∞—Ç—É –∏ –ø—Ä–µ–¥–º–µ—Ç) 

    void markAsCompleted(long id, boolean completed); // –û—Ç–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ –∏–ª–∏ –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ 

    void deleteHomework(long id);  // –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –∑–∞–¥–∞–Ω–∏–µ –ø–æ ID 
 
    void deleteOldHomework(LocalDate date); // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Å—Ç–∞—Ä—ã–µ –∑–∞–¥–∞–Ω–∏—è (—Å –ø—Ä–æ—à–µ–¥—à–µ–π –¥–∞—Ç–æ–π –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è)

    void deleteAllHomeworkForUser(long chatId);  // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è 
    
    List<HomeworkItem> getActiveHomeworkBySubjects(long chatId, List<String> subjects); // –¥–ª—è –≤–µ—á–µ—Ä–Ω–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏ (—Å–æ–±–∏—Ä–∞–µ—Ç –¥–∑ –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å)
    
    List<HomeworkItem> getHomeworkWithCustomDeadline(long chatId, List<String> excludedSubjects, LocalDate date); // –¥–ª—è –≤–µ—á–µ—Ä–Ω–µ–π —Ä–∞—Å—Å—ã–ª–∫–∏ (—Å–æ–±–∏—Ä–∞–µ—Ç –¥–∑, –¥–µ–¥–∞–ª–π–Ω –∫–æ—Ç–æ—Ä–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º —É—Å—Ç–∞–Ω–æ–≤–∏–ª)

}
package bot.homework;

import java.sql.*;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import bot.user.exception.ScheduleStorageException; 

public class SQLiteHomeworkStorage implements HomeworkStorage {

	private final String dbUrl = "jdbc:sqlite:homework.db"; // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    private Connection connection;
    
    
    @Override
    public void initialize() {
        try {
            connection = DriverManager.getConnection(dbUrl);

            // SQL –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π
            String sql = "CREATE TABLE IF NOT EXISTS homework (" +
                         "id INTEGER PRIMARY KEY AUTOINCREMENT, " + // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏
                         "chatId INTEGER NOT NULL, " +  // id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (chatId)
                         "subject TEXT NOT NULL, " + // –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞
                         "description TEXT NOT NULL, " + // —Ç–µ–∫—Å—Ç –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
                         "dueDate TEXT NOT NULL, " +  // –¥–∞—Ç–∞ –¥–µ–¥–ª–∞–π–Ω–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD
                         "completed INTEGER DEFAULT 0, " +  // —Å—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è 
                         "remindBeforeDays INTEGER DEFAULT 1" + // –∑–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1)
                         ")";
            
            Statement statement = connection.createStatement();
            statement.execute(sql);
            statement.close();

        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π", e);
        }
    }


    @Override
    public void addHomework(long chatId, String subject, String description, LocalDate dueDate, int remindBeforeDays) {
        try {
            String sql = "INSERT INTO homework (chatId, subject, description, dueDate, completed, remindBeforeDays) " +
                         "VALUES (?, ?, ?, ?, 0, ?)";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setLong(1, chatId);
            pstatment.setString(2, subject);
            pstatment.setString(3, description);
            pstatment.setString(4, dueDate.toString());
            pstatment.setInt(5, remindBeforeDays);
            pstatment.executeUpdate();
            pstatment.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è", e);
        }
    }


    @Override
    public List<HomeworkItem> getHomeworkByUser(long chatId) {
        List<HomeworkItem> homeworkList = new ArrayList<>();
        try {
            String sql = "SELECT * FROM homework WHERE chatId = ? ORDER BY dueDate";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setLong(1, chatId);
            ResultSet result = pstatment.executeQuery();

            // –ø—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Å—Ç—Ä–æ–∫–∞–º
            while (result.next()) {
                homeworkList.add(mapToHomeworkItem(result)); // –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Å—Ç—Ä–æ–∫—É –ë–î –≤ –æ–±—ä–µ–∫—Ç HomeworkItem
            }

            result.close();
            pstatment.close();
            return homeworkList;
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }


    @Override
    public List<HomeworkItem> getHomeworkBySubject(long chatId, String subject) { // –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –ø—Ä–µ–¥–º–µ—Ç—É.
        List<HomeworkItem> homeworkList = new ArrayList<>();
        try {
            String sql = "SELECT * FROM homework WHERE chatId = ? AND subject = ? ORDER BY dueDate";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setLong(1, chatId);
            pstatment.setString(2, subject);
            ResultSet result = pstatment.executeQuery();

            while (result.next()) {
                homeworkList.add(mapToHomeworkItem(result));
            }

            result.close();
            pstatment.close();
            return homeworkList;
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É", e);
        }
    }

    
    @Override
    public List<HomeworkItem> getActiveHomeworkBySubjects(long chatId, List<String> subjects) {
        List<HomeworkItem> homeworkList = new ArrayList<>();
        if (subjects == null || subjects.isEmpty()) {
        	return homeworkList;
        }

        try {
            String placeholders = String.join(",", subjects.stream().map(s -> "?").toList());
            String sql = "SELECT * FROM homework WHERE chatId = ? AND subject IN (" + placeholders + ") " +
                         "AND completed = 0 AND dueDate >= ?";

            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setLong(1, chatId);

            int index = 2;
            for (String subj : subjects) {
            	pstatement.setString(index++, subj);
            }

            pstatement.setString(index, LocalDate.now().toString());

            ResultSet result = pstatement.executeQuery();
            while (result.next()) {
                homeworkList.add(mapToHomeworkItem(result));
            }

            result.close();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º", e);
        }

        return homeworkList;
    }
    
    
    @Override
    public List<HomeworkItem> getHomeworkWithCustomDeadline(long chatId, List<String> excludedSubjects, LocalDate date) {
    	// excludedSubjects ‚Äî —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ –∏—Å–∫–ª—é—á–∏—Ç—å (—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –Ω–∞ –∑–∞–≤—Ç—Ä–∞)
        List<HomeworkItem> homeworkList = new ArrayList<>();

        try {
            StringBuilder sql = new StringBuilder("SELECT * FROM homework WHERE chatId = ? AND completed = 0 AND dueDate = ?");
            
            if (excludedSubjects != null && !excludedSubjects.isEmpty()) {
            	// s -> "?" ‚Äî —ç—Ç–æ –ª—è–º–±–¥–∞-–≤—ã—Ä–∞–∂–µ–Ω–∏–µ, –¥–ª—è –∫–∞–∂–¥–æ–≥–æ s –≤–µ—Ä–Ω—É—Ç—å –≤–æ–ø—Ä–æ—Å–∏–∫
                String placeholders = String.join(",", excludedSubjects.stream().map(s -> "?").toList()); // –°–æ–∑–¥–∞—ë–º —Å—Ç—Ä–æ–∫—É –≤–∏–¥–∞ "?, ?, ?, ?" ‚Äî –ø–æ —á–∏—Å–ª—É –ø—Ä–µ–¥–º–µ—Ç–æ–≤
                sql.append(" AND subject NOT IN (").append(placeholders).append(")"); // –î–æ–±–∞–≤–ª—è–µ–º –≤ SQL —É—Å–ª–æ–≤–∏–µ: AND subject NOT IN (?, ?, ?)
            }

            PreparedStatement pstatement = connection.prepareStatement(sql.toString());
            pstatement.setLong(1, chatId);
            pstatement.setString(2, date.toString());

            int index = 3;
            if (excludedSubjects != null && !excludedSubjects.isEmpty()) {
                for (String subj : excludedSubjects) {
                	pstatement.setString(index++, subj);
                }
            }

            ResultSet result = pstatement.executeQuery();
            while (result.next()) {
                homeworkList.add(mapToHomeworkItem(result));
            }

            result.close();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –¥–µ–¥–ª–∞–π–Ω–æ–≤", e);
        }

        return homeworkList;
    }



    @Override
    public void updateHomework(long id, String newSubject, String newDescription, LocalDate newDueDate) { // –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –¥–∑
        try {
            String sql = "UPDATE homework SET subject = ?, description = ?, dueDate = ? WHERE id = ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setString(1, newSubject);
            pstatement.setString(2, newDescription);
            pstatement.setString(3, newDueDate.toString());
            pstatement.setLong(4, id);
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è", e);
        }
    }


    
    @Override
    public void markAsCompleted(long id, boolean completed) { // –ø–æ–º–µ—Ç–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ, –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ (–∏ –Ω–∞–æ–±–æ—Ä–æ—Ç —Ç–æ–∂–µ –º–æ–∂–Ω–æ)
        try {
            String sql = "UPDATE homework SET completed = ? WHERE id = ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setInt(1, completed ? 1 : 0); // –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ —Ç—Ä—É, –∑–∞–ø–∏—Å–∞–ª–∏ 1, –µ—Å–ª–∏ —Ñ–æ–ª—Å, –∑–∞–ø–∏—Å–∞–ª–∏ 0
            pstatement.setLong(2, id);
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –æ—Ç–º–µ—Ç–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –î–ó", e);
        }
    }



    @Override
    public void deleteHomework(long id) { // —É–¥–∞–ª–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å –¥–∑ 
        try {
            String sql = "DELETE FROM homework WHERE id = ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setLong(1, id);
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è", e);
        }
    }


    @Override
    public void deleteOldHomework(LocalDate date) { // —É–¥–∞–ª–∏—Ç—å –¥–∑, —É –∫–æ—Ç–æ—Ä—ã—Ö –¥–µ–¥–ª–∞–π–Ω –ø—Ä–æ—à–µ–ª
        try {
            String sql = "DELETE FROM homework WHERE dueDate < ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setString(1, date.toString());
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π", e);
        }
    }


    @Override
    public void deleteAllHomeworkForUser(long chatId) { // —É–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∑ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try {
            String sql = "DELETE FROM homework WHERE chatId = ?";
            PreparedStatement pstatement = connection.prepareStatement(sql);
            pstatement.setLong(1, chatId);
            pstatement.executeUpdate();
            pstatement.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }


    public void close() {
        try {
            if (connection != null) connection.close();
        } catch (SQLException ignored) {}
    }


    private HomeworkItem mapToHomeworkItem(ResultSet rs) throws SQLException { // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫–∏ –∏–∑ ResultSet –≤ –æ–±—ä–µ–∫—Ç HomeworkItem
        return new HomeworkItem(
            rs.getLong("id"), // —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä –∑–∞–¥–∞–Ω–∏—è
            rs.getLong("chatId"), // id –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            rs.getString("subject"), // –ø—Ä–µ–¥–º–µ—Ç
            rs.getString("description"), // —Ç–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è
            LocalDate.parse(rs.getString("dueDate")), // –¥–µ–¥–ª–∞–π–Ω (–ø—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –∏–∑ —Å—Ç—Ä–æ–∫–∏ –≤ LocalDate)
            rs.getInt("completed") == 1, // —Å—Ç–∞—Ç—É—Å (1 ‚Äî true, 0 ‚Äî false)
            rs.getInt("remindBeforeDays") // –∑–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –Ω–∞–ø–æ–º–∏–Ω–∞—Ç—å
        );
    }
}
package bot.schedule;

import java.time.LocalTime;

public class Lesson {
    private String subject; // –ø—Ä–µ–¥–º–µ—Ç
    private LocalTime startTime; // –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
    private LocalTime endTime; // –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
    private String classroom; // –∞—É–¥–∏—Ç–æ—Ä–∏—è

    public Lesson(String subject, LocalTime startTime, LocalTime endTime, String classroom) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä
        this.subject = subject;
        this.startTime = startTime;
        this.endTime = endTime;
        this.classroom = classroom;
    }

    public String getSubject() { 
    	return subject; 
    	}
    
    public LocalTime getStartTime() { 
    	return startTime; 
    	}
    
    public LocalTime getEndTime() {
    	return endTime;
    	}
    
    public String getClassroom() {
    	return classroom; 
    	}


    public void setSubject(String subject) { 
    	this.subject = subject; 
    	}
   
    public void setStartTime(LocalTime startTime) { 
    	this.startTime = startTime; 
    	}
    
    public void setEndTime(LocalTime endTime) { 
    	this.endTime = endTime; 
    	}
    
    public void setClassroom(String classroom) { 
    	this.classroom = classroom; 
    	}
}





package bot.schedule;

import java.util.*;

public class Schedule {
    private String groupId; // –∞–π–¥–∏ –≥—Ä—É–ø–ø—ã
    private String groupName;
    private Map<String, List<Lesson>> weeklySchedule; // –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ -> —Å–ø–∏—Å–æ–∫ –ø–∞—Ä

    public Schedule(String groupId, String groupName) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä (–¥–µ–ª–∞–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å –ø—É—Å—Ç–æ–π –º–∞–ø–æ–π)
        this.groupId = groupId;
        this.groupName = groupName;
        this.weeklySchedule = new HashMap<>();
    }

    public void addLesson(String dayOfWeek, Lesson lesson) {
        if (!weeklySchedule.containsKey(dayOfWeek)) { // –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —Å–ø–∏—Å–∫–∞ –µ—â–µ –Ω–µ—Ç
            List<Lesson> lessonsForDay = new ArrayList<>(); // —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫ –¥–ª—è —ç—Ç–æ–≥–æ –¥–Ω—è
            weeklySchedule.put(dayOfWeek, lessonsForDay); // –¥–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä—É –∫–ª—é—á –∑–Ω–∞—á–µ–Ω–∏–µ
        }
        
        List<Lesson> lessonsForDay = weeklySchedule.get(dayOfWeek);
        
        lessonsForDay.add(lesson); // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –ø–∞—Ä—É –≤ —ç—Ç–æ—Ç —Å–ø–∏—Å–æ–∫
    }

    public List<Lesson> getLessonsForDay(String dayOfWeek) { // –ø–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Ä –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–µ–Ω—å
        return weeklySchedule.getOrDefault(dayOfWeek, new ArrayList<>());
    }


    public String getGroupId() { 
    	return groupId; 
    	}
    
    public String getGroupName() { 
    	return groupName;
    	}
    
    public Map<String, List<Lesson>> getWeeklySchedule() { 
    	return weeklySchedule; 
    	}


    public void setGroupId(String groupId) { 
    	this.groupId = groupId; 
    	}
    
    public void setGroupName(String groupName) { 
    	this.groupName = groupName;
    	}
    
    public void setWeeklySchedule(Map<String, List<Lesson>> weeklySchedule) { 
    	this.weeklySchedule = weeklySchedule; 
    	}
    
    
    
    
    
}package bot.schedule;

import bot.user.exception.ScheduleFetchException;
import bot.user.User;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;

import java.time.DayOfWeek;
import java.time.LocalDate; // –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –¥–∞—Ç—ã
import java.time.LocalTime;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;


public class ScheduleFetcher {

    private static final String DIVISIONS_URL = "https://urfu.ru/api/v2/schedule/divisions"; // –∞–¥—Ä–µ—Å –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
    private static final DateTimeFormatter DATE_FORMAT = DateTimeFormatter.ISO_LOCAL_DATE; // –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ –¥–∞—Ç

    private final UrfuApiClient httpClient;
    private final ObjectMapper jsonMapper; // Jackson-–æ–±—ä–µ–∫—Ç –¥–ª—è —á—Ç–µ–Ω–∏—è JSON

    public ScheduleFetcher() { // –∫–æ–Ω—Å—Ç—Ä—É—Ç–æ—Ä 
        this.httpClient = new UrfuApiClient(); // –∫–ª–∏–µ–Ω—Ç –¥–ª—è http –∑–∞–ø—Ä–æ—Å–æ–≤
        this.jsonMapper = new ObjectMapper(); // –ø–∞—Ä—Å–µ—Ä json
    }

    
    
    public Schedule fetchForUser(User user) throws ScheduleFetchException { // –ó–∞–≥—Ä—É–∂–∞–µ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        try {
            String instituteName = nullSafeTrim(user.getUniversity());
            String departmentName = nullSafeTrim(user.getDepartment());
            String groupName = nullSafeTrim(user.getGroup());
            int courseNumber = parseCourse(user.getCourse());
            
            // 1) –¥–µ–ª–∞–µ–º –º–∞—Å—Å–∏–≤ json –æ–±—ä–µ–∫—Ç–æ–≤
            String divisionsJson = httpClient.get(DIVISIONS_URL); // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É - —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ http –∑–∞–ø—Ä–æ—Å
            JsonNode divisionsArray = jsonMapper.readTree(divisionsJson); // –¥–∂–µ–∫—Å–æ–Ω –ø–∞—Ä—Å–∏—Ç –≤ json –æ–±—ä–µ–∫—Ç—ã –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–π

            // 2) –ù–∞—Ö–æ–¥–∏–º –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç
            long departmentId = findDepartmentId(divisionsArray, instituteName, departmentName);
            if (departmentId == -1L) {
                long instituteId = findInstituteId(divisionsArray, instituteName);
                if (instituteId != -1L) {
                    // –µ—Å–ª–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∞–º –∏–Ω—Å—Ç–∏—Ç—É—Ç
                    departmentId = instituteId;
                } else {
                    throw new ScheduleFetchException("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –∏–ª–∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç.");
                }
            }

            // 3) –ü–æ–ª—É—á–∞–µ–º –≥—Ä—É–ø–ø—ã –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
            String groupsUrl = String.format("https://urfu.ru/api/v2/schedule/divisions/%d/groups?course=%d", departmentId, courseNumber);
            String groupsJson = httpClient.get(groupsUrl);
            JsonNode groupsArray = jsonMapper.readTree(groupsJson);

            long groupId = findGroupId(groupsArray, groupName);
            if (groupId == -1L) {
                throw new ScheduleFetchException("–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É.");
            }

            // 4) –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â—É—é –Ω–µ–¥–µ–ª—é
            LocalDate today = LocalDate.now(ZoneId.of("Asia/Yekaterinburg"));
            LocalDate monday = today.with(DayOfWeek.MONDAY); // –Ω–∞—Ö–æ–¥–∏–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ —Ç–µ–∫—É—â–µ–π –Ω–µ–¥–µ–ª–∏
            LocalDate sunday = monday.plusDays(6); // –¥–æ–±–∞–≤–ª—è–µ–º 6 –¥–Ω–µ–π, –ø–æ–ª—É—á–∞–µ—Ç—Å—è –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ

            // 5) –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
            String scheduleUrl = String.format(
                    "https://urfu.ru/api/v2/schedule/groups/%d/schedule?date_gte=%s&date_lte=%s",
                    groupId,
                    monday.format(DATE_FORMAT),
                    sunday.format(DATE_FORMAT)
            );

            String scheduleJson = httpClient.get(scheduleUrl);
            JsonNode scheduleRoot = jsonMapper.readTree(scheduleJson);
            
            JsonNode eventsNode;
            if (scheduleRoot.has("events")) { // –µ—Å–ª–∏ –≤ JSON –µ—Å—Ç—å –ø–æ–ª–µ events ‚Äî –±–µ—Ä—ë–º –∏–º–µ–Ω–Ω–æ –µ–≥–æ
                eventsNode = scheduleRoot.get("events");
            } else {
                eventsNode = scheduleRoot; // –µ—Å–ª–∏ –ø–æ–ª—è events –Ω–µ—Ç ‚Äî –∑–Ω–∞—á–∏—Ç, —Å–∞–º –∫–æ—Ä–µ–Ω—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º –∑–∞–Ω—è—Ç–∏–π
            }
            
            
            if (eventsNode == null || !eventsNode.isArray()) {
                throw new ScheduleFetchException("–û—à–∏–±–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –¥–∞–Ω–Ω—ã—Ö —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.");
            }

            // 6) –§–æ—Ä–º–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
            Schedule resultSchedule = new Schedule(String.valueOf(groupId), groupName);

            for (JsonNode eventNode : eventsNode) {
                String dateText = firstNonNullText(eventNode, "date", "lesson_date", "lessonDate");
                String timeBeginText = firstNonNullText(eventNode, "timeBegin", "time_begin", "timeStart", "time_start");
                String timeEndText = firstNonNullText(eventNode, "timeEnd", "time_end");
                String subjectText = firstNonNullText(eventNode, "title", "discipline", "name");
                String classroomText = firstNonNullText(eventNode, "auditoryTitle", "auditoryLocation", "auditorium");

                if (dateText == null || subjectText == null) { // –µ—Å–ª–∏ –Ω–µ—Ç –¥–∞—Ç—ã –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–µ–¥–º–µ—Ç–∞ - —Å–∫–∏–ø
                	continue;
                }

                LocalTime startTime = parseTimeOrNull(timeBeginText);
                LocalTime endTime = parseTimeOrNull(timeEndText);
                LocalDate lessonDate = LocalDate.parse(dateText, DATE_FORMAT);

                if (classroomText == null) {
                    classroomText = "";
                }
                
                Lesson lesson = new Lesson(subjectText, startTime, endTime, classroomText);
                resultSchedule.addLesson(lessonDate.getDayOfWeek().toString(), lesson);
            }

            return resultSchedule;

        } catch (ScheduleFetchException e) {
            throw e;
        } catch (Exception e) {
            throw new ScheduleFetchException("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.");
        }
    }

    
    private long findInstituteId(JsonNode divisionsArray, String instituteName) {
        if (instituteName == null || instituteName.isEmpty()) {
            return -1L;
        }

        String normalizedInstitute = normalize(instituteName);

        // –ø–æ –ø—Ä—è–º–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é
        for (JsonNode node : divisionsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && title.toLowerCase().contains(instituteName.toLowerCase())) {
                return node.path("id").asLong(-1);
            }
        }

        // –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
        for (JsonNode node : divisionsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && normalize(title).contains(normalizedInstitute)) {
                return node.path("id").asLong(-1);
            }
        }

        return -1L;
    }

    

    private long findDepartmentId(JsonNode divisionsArray, String instituteName, String departmentName) {
        String normalizedInstitute = normalize(instituteName); // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Å—Ç—Ä–æ–∫–∏ 
        String normalizedDepartment = normalize(departmentName);

        Long instituteId = null;
        if (instituteName != null && !instituteName.isEmpty()) { // —á—Ç–æ–±—ã –Ω–µ –∏—Å–∫–∞—Ç—å –ø–æ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–µ
            for (JsonNode node : divisionsArray) {
                String title = firstNonNullText(node, "title", "name");
                if (title != null && title.toLowerCase().contains(instituteName.toLowerCase())) {
                    instituteId = node.path("id").asLong(-1);
                    break;
                }
            }
            // –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ ‚Äî –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–º—É –Ω–∞–∑–≤–∞–Ω–∏—é, –µ—Å–ª–∏ –ø—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
            if (instituteId == null || instituteId == -1) {
                for (JsonNode node : divisionsArray) {
                    String title = firstNonNullText(node, "title", "name");
                    if (title != null && normalize(title).contains(normalizedInstitute)) {
                        instituteId = node.path("id").asLong(-1);
                        break;
                    }
                }
            }
        }

        List<JsonNode> searchArea = new ArrayList<>(); // —Å–ø–∏—Å–æ–∫ –∏–∑ json node –≤ –∫–æ—Ç–æ—Ä—ã—Ö –∏—Å–∫–∞—Ç—å –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç –±—É–¥–µ–º
        if (instituteId != null && instituteId != -1) {
            for (JsonNode node : divisionsArray) {
                if (node.path("parentId").asLong(-1) == instituteId) { // –±–µ—Ä–µ–º —É–∑–ª—ã, –≥–¥–µ parentId —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –∞–π–¥–∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞
                    searchArea.add(node);
                }
            }
        } else {
            // –ï—Å–ª–∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –∏—â–µ–º —Å—Ä–µ–¥–∏ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –º–∞—Å—Å–∏–≤–∞
            for (JsonNode node : divisionsArray) { 
                searchArea.add(node);
            }
        }

        // –ï—Å–ª–∏ departmentName –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –Ω–µ –∏—Å–∫–∞—Ç—å –ø–æ –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–µ (–∏–Ω–∞—á–µ —Å–æ–≤–ø–∞–¥–µ—Ç —Å –ª—é–±—ã–º title)
        if (departmentName == null || departmentName.isEmpty()) {
            return -1L;
        }

        // –°–Ω–∞—á–∞–ª–∞ –∏—â–µ–º –ø–æ –ø—Ä—è–º–æ–º—É –≤—Ö–æ–∂–¥–µ–Ω–∏—é
        for (JsonNode node : searchArea) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && title.toLowerCase().contains(departmentName.toLowerCase())) {
                return node.path("id").asLong(-1); // –≤–µ—Ä–Ω–µ–º –∞–π–¥–∏ –Ω—É–∂–Ω–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
            }
        }

        // –ü–æ—Ç–æ–º –ø–æ –Ω–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–π —Ñ–æ—Ä–º–µ
        for (JsonNode node : searchArea) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && normalize(title).contains(normalizedDepartment)) {
                return node.path("id").asLong(-1); // –≤–µ—Ä–Ω–µ–º –∞–π–¥–∏ –Ω—É–∂–Ω–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
            }
        }

        return -1L;
    }


    
    private long findGroupId(JsonNode groupsArray, String groupName) {
        if (groupName == null || groupName.isEmpty()) {
        	return -1L;
        }
        String normalizedGroup = normalize(groupName);
        for (JsonNode node : groupsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && title.toLowerCase().contains(groupName.toLowerCase())) {
                return node.path("id").asLong(-1);
            }
        }
        for (JsonNode node : groupsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && normalize(title).contains(normalizedGroup)) {
                return node.path("id").asLong(-1);
            }
        }

        String groupWithoutHyphen = groupName.replace("-", "").toLowerCase();
        for (JsonNode node : groupsArray) {
            String title = firstNonNullText(node, "title", "name");
            if (title != null && title.toLowerCase().replace("-", "").contains(groupWithoutHyphen)) {
                return node.path("id").asLong(-1);
            }
        }
        return -1L;
    }


    
    private static String firstNonNullText(JsonNode node, String... keys) { // –ø—Ä–∏–Ω–∏–º–∞–µ—Ç json node –∏ —Å–ø–∏—Å–æ–∫ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –∫–ª—é—á–µ–π
        if (node == null) {
        	return null;
        }
        for (String key : keys) {
            if (node.has(key) && !node.get(key).isNull()) { // –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤ json node –µ—Å—Ç—å –ø–æ–ª–µ —Å –¥–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º –∏ –æ–Ω–æ –Ω–µ –ø—É—Å—Ç–æ–µ
                return node.get(key).asText(); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ (asText –ø—Ä–µ–≤—Ä–∞—â–∞–µ–º –µ–≥–æ –≤ —Å—Ç—Ä–æ–∫—É)
            }
        }
        return null;
    }

    
    private static LocalTime parseTimeOrNull(String text) {
        if (text == null || text.isEmpty()) { // –Ω–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ –∏–ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
        	return null;
        }
        try {
            return LocalTime.parse(text.trim()); // –º–µ—Ç–æ–¥ –∏–∑ –ø–∞–∫–µ—Ç–∞ java.time, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ –æ–±—ä–µ–∫—Ç –≤—Ä–µ–º–µ–Ω–∏
        } catch (Exception e) {
            return null;
        }
    }

    
    private static int parseCourse(String courseText) { // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–º–µ—Ä –∫—É—Ä—Å–∞ –≤ –≤–∏–¥–µ –∏–Ω—Ç 
        if (courseText == null) {
        	return 0;
        }
        try {
            return Integer.parseInt(courseText.trim());
        } catch (Exception e) {
            return 0;
        }
    }

    
    private static String nullSafeTrim(String s) { // —É–±–∏—Ä–∞–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã –∏–∑ —Å—Ç—Ä–æ–∫–∏
        if (s == null) {
        	return null;
        }
        String trimmed = s.trim();
        
        if (trimmed.isEmpty()) { // –µ—Å–ª–∏ –±–µ–∑ –ø—Ä–æ–±–µ–ª–æ–≤ —Å—Ç—Ä–æ–∫–∞ –ø—É—Å—Ç–∞—è
        	return null ;
        } else {
        	return trimmed;
        }
        
    }

    
    private static String normalize(String s) { // –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–æ–∫ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
        if (s == null) {
        	return "";
        }
        return s.toLowerCase() // –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É
                .replaceAll("[^\\p{Alnum}\\s]", " ") // –∑–∞–º–µ–Ω—è–µ—Ç –≤—Å—ë, —á—Ç–æ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –±—É–∫–≤–∞–º–∏, —Ü–∏—Ñ—Ä–∞–º–∏ –∏–ª–∏ –ø—Ä–æ–±–µ–ª–æ–º, –Ω–∞ –ø—Ä–æ–±–µ–ª
                .replaceAll("\\s+", " ") // —Å–∂–∏–º–∞–µ—Ç –≤—Å–µ –∏–¥—É—â–∏–µ –ø–æ–¥—Ä—è–¥ –ø—Ä–æ–±–µ–ª—ã –≤ –æ–¥–∏–Ω
                .trim(); // —É–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã —Å –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏
    }
    
    
    private static String removeSpaces(String s) { // –º–µ—Ç–æ–¥ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—É—Å—Ç–æ–≥–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞
        if (s == null) {
            return null;
        }
        String trimmed = s.trim();

        // –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤—ë–ª "-" –∏–ª–∏ "‚Äî" –∏–ª–∏ "–Ω–µ—Ç", —Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ –Ω–µ—Ç
        if (trimmed.isEmpty() || trimmed.equals("-") || trimmed.equals("‚Äî") || trimmed.equalsIgnoreCase("–Ω–µ—Ç")) {
            return null;
        }

        return trimmed;
    }

}


package bot.schedule;

import bot.user.exception.UserNotFoundException;
import bot.user.User;
import bot.user.UserStorage;

import java.util.Map;
import java.util.List;

public class ScheduleManager {
    private final ScheduleStorage commonStorage;    // –¥–ª—è schedules.db 
    private final ScheduleStorage customStorage;    // –¥–ª—è custom_schedules.db 
    private final UserStorage userStorage;

    public ScheduleManager(UserStorage userStorage) { // –∫–æ–Ω—Å—Ç—Ä—É—Ç–æ—Ä (–¥–µ–ª–∞–µ–º –¥–≤–µ –±–¥ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—Ü–µ–º –∏—Ö)
        this.commonStorage = new SQLiteScheduleStorage("schedules.db");
        this.customStorage = new SQLiteScheduleStorage("custom_schedules.db");
        this.userStorage = userStorage;

        this.commonStorage.initialize();
        this.customStorage.initialize();

        this.commonStorage.technicalMaintenance(200);
    }


    public Schedule getScheduleForUser(long userId) { // –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        User user = userStorage.getUser(userId);
        if (user == null) {
            throw new UserNotFoundException(userId);
        }

        String customGroupId = String.valueOf(userId);

        // –µ—Å–ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ customStorage ‚Äî –æ—Ç–¥–∞—ë–º –µ–≥–æ.
        if (customStorage.scheduleExists(customGroupId)) {
            return customStorage.getScheduleByGroupId(customGroupId);
        }

        // –∏–Ω–∞—á–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –æ–±—â–µ–µ –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã 
        return commonStorage.getScheduleByGroupName(user.getGroup());
    }


    public void saveCustomSchedule(long userId, Schedule schedule) { // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        User user = userStorage.getUser(userId);
        if (user == null) {
            throw new UserNotFoundException(userId);
        }

        schedule.setGroupId(String.valueOf(userId));


        if (customStorage.scheduleExists(String.valueOf(userId))) {
            customStorage.updateSchedule(schedule);
        } else {
            customStorage.saveSchedule(schedule);
        }

        // –ü–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–±—ä–µ–∫—Ç user –≤ –ø–∞–º—è—Ç–∏ —É—Å—Ç–∞—Ä–µ–ª)
        User fresh = userStorage.getUser(userId);
        if (fresh != null) {
            fresh.setHasCustomSchedule(true);
            userStorage.updateUser(fresh);
        } 
    }


    public void resetToOriginalSchedule(long userId) { // —Å–±—Ä–æ—Å–∏—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–±—â–µ–º—É (–¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞–¥–æ –±—É–¥–µ—Ç)
        User user = userStorage.getUser(userId);
        if (user == null) {
            throw new UserNotFoundException(userId);
        }

        customStorage.deleteSchedule(String.valueOf(userId)); // —É–¥–∞–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

        user.setHasCustomSchedule(false); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥
        userStorage.updateUser(user);
    }


    public void copyCommonToCustom(long userId) { // —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –æ–±—â–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤ –∫–∞—Å—Ç–æ–º–Ω–æ–µ
        User user = userStorage.getUser(userId);

        if (user == null) {
            throw new UserNotFoundException(userId);
        }

        // –ü–æ–ª—É—á–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–µ (–æ–±—â–µ–µ) —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
        Schedule original = commonStorage.getScheduleByGroupName(user.getGroup());
        if (original == null) {
            // –ï—Å–ª–∏ –æ–±—â–µ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –Ω–µ—Ç ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º 
            throw new IllegalStateException("–û–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã '" + user.getGroup() + "' –Ω–µ –Ω–∞–π–¥–µ–Ω–æ");
        }

        // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Schedule –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –ë–î (–Ω–µ –º—É—Ç–∏—Ä—É–µ–º original)
        Schedule copy = new Schedule(String.valueOf(userId), original.getGroupName());
        // –ö–æ–ø–∏—Ä—É–µ–º –ø–∞—Ä—ã 
        for (Map.Entry<String, List<Lesson>> entry : original.getWeeklySchedule().entrySet()) {
            String day = entry.getKey(); // —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏
            for (Lesson l : entry.getValue()) { // –ø–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ —É—Ä–æ–∫–∏
                // –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç Lesson, —á—Ç–æ–±—ã –Ω–µ —Å—Å—ã–ª–∞—Ç—å—Å—è –Ω–∞ —Ç–µ –∂–µ –æ–±—ä–µ–∫—Ç—ã
                Lesson lessonCopy = new Lesson(l.getSubject(), l.getStartTime(), l.getEndTime(), l.getClassroom());
                copy.addLesson(day, lessonCopy);
            }
        }

        String uniqueGroupNameForStorage = original.getGroupName() + "_user_" + userId;
        copy.setGroupName(uniqueGroupNameForStorage);

        String customGroupId = String.valueOf(userId);
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–ª–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤ customStorage 
        if (customStorage.scheduleExists(customGroupId)) {
            customStorage.updateSchedule(copy);
        } else {
            customStorage.saveSchedule(copy);
        }
        

        // –û–±–Ω–æ–≤–ª—è–µ–º —Ñ–ª–∞–≥ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–ø–µ—Ä–µ—á–∏—Ç—ã–≤–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
        User fresh = userStorage.getUser(userId);
        if (fresh != null) {
            fresh.setHasCustomSchedule(true);
            userStorage.updateUser(fresh);
        }
    }


    public void saveCommonSchedule(Schedule schedule) { // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ–±—â–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        if (commonStorage.scheduleExists(schedule.getGroupId())) {
            commonStorage.updateSchedule(schedule);
        } else {
            commonStorage.saveSchedule(schedule);
        }
    }
    
    public boolean customScheduleExists(long userId) { // –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ –∫–∞—Å—Ç–æ–º–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        return customStorage.scheduleExists(String.valueOf(userId));
    }

    public void close() {
        commonStorage.close();
        customStorage.close();
    }
}package bot.schedule;

public interface ScheduleStorage {
    
    void initialize();
	
    Schedule getScheduleByGroupId(String groupId); // –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    
    Schedule getScheduleByGroupName(String groupName); // –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
    
    void saveSchedule(Schedule schedule); // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ 
    
    void updateSchedule(Schedule schedule); // –æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
    
    void deleteSchedule(String groupId); // —É–¥–∞–ª–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ –≥—Ä—É–ø–ø–µ
    
    boolean scheduleExists(String groupId); // –ø—Ä–æ–≤–µ—Ä–∫–∞ –µ—Å—Ç—å –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ 
    
    void close();
    
    
    
    String getGroupIdByName(String groupName); // –≤–µ—Ä–Ω—É—Ç—å –∞–π–¥–∏ –≥—Ä—É–ø–ø—ã –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã
    
    void saveGroupMapping(String groupName, String groupId); // —Å–æ—Ö—Ä–≤–Ω–∏—Ç—å –≥—Ä—É–ø–ø—É –≤ —Ç–∞–±–ª–∏—Ü—É
    
    boolean groupMappingExists(String groupName); // –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—Å—Ç—å –ª–∏ –≥—Ä—É–ø–ø–∞ –≤ —Ç–∞–±–ª–∏—Ü–µ 
     
    void updateMappingTimestamp(String groupName);
    
    void technicalMaintenance(int daysOld);
}package bot.schedule;

import java.sql.*;
import java.time.LocalTime;
import java.util.*;

import bot.user.exception.ScheduleStorageException;

public class SQLiteScheduleStorage implements ScheduleStorage {
    private final String dbUrl;
    private Connection connection;

    public SQLiteScheduleStorage(String dbFileName) { // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Å –ø—É—Ç–µ–º –∫ –ë–î (–ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–∞–º –Ω—É–∂–Ω–æ 2 –±–¥)
        this.dbUrl = "jdbc:sqlite:" + dbFileName;
    }

    
    @Override
    public void initialize() {
        try {
            connection = DriverManager.getConnection(dbUrl); // —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å –±–¥
            
            // –¢–∞–±–ª–∏—Ü–∞ mapping (–≥—Ä—É–ø–ø–∞ -> groupId)
            String mappingSql = "CREATE TABLE IF NOT EXISTS group_mapping (" +
                               "groupName TEXT PRIMARY KEY," +
                               "groupId TEXT NOT NULL," +
                               "lastUpdated TIMESTAMP DEFAULT CURRENT_TIMESTAMP" +
                               ")";
            
            // –¢–∞–±–ª–∏—Ü–∞ –≥—Ä—É–ø–ø
            String groupsSql = "CREATE TABLE IF NOT EXISTS groups (" +
                              "groupId TEXT PRIMARY KEY," +
                              "groupName TEXT UNIQUE NOT NULL" +
                              ")";
            
            // –¢–∞–±–ª–∏—Ü–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
            String scheduleSql = "CREATE TABLE IF NOT EXISTS schedule_lessons (" +
                                "id INTEGER PRIMARY KEY AUTOINCREMENT," +
                                "groupId TEXT," +
                                "dayOfWeek TEXT NOT NULL," +
                                "subject TEXT NOT NULL," +
                                "startTime TEXT NOT NULL," +
                                "endTime TEXT NOT NULL," +
                                "classroom TEXT," +
                                "FOREIGN KEY (groupId) REFERENCES groups(groupId)" +
                                ")";
            
            Statement statement = connection.createStatement(); // —Å–æ–∑–¥–∞–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ 
            statement.execute(mappingSql); // –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å (—Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—É)
            statement.execute(groupsSql);
            statement.execute(scheduleSql);
            statement.close();
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ë–î —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è: ", e);
        }
    }

    
    @Override
    public String getGroupIdByName(String groupName) {
        try {
            String sql = "SELECT groupId FROM group_mapping WHERE groupName = ?";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupName);
            
            ResultSet result =  pstatment.executeQuery(); // –æ–Ω–æ –≤–µ—Ä–Ω–µ—Ç –∫—É—Ä—Å–æ—Ä –Ω–∞ –Ω–∞—á–∞–ª–æ —Å—Ç—Ä–æ–∫–∏
            if (result.next()) { // –µ—Å–ª–∏ –Ω–∞—à–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç 
                String groupId = result.getString("groupId");
                result.close();
                pstatment.close();
                
                updateMappingTimestamp(groupName);
                
                return groupId;
            }
            result.close();
            pstatment.close();
            return null;
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è groupId –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã: ", e);
        }
    }
    
    
    @Override
    public void saveGroupMapping(String groupName, String groupId) {
        try {
            String sql = "INSERT OR REPLACE INTO group_mapping (groupName, groupId) VALUES (?, ?)";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupName);
            pstatment.setString(2, groupId);
            pstatment.executeUpdate();
            pstatment.close();
            
            updateMappingTimestamp(groupName);
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è mapping –≥—Ä—É–ø–ø—ã: ", e);
        }
    }

    
    @Override
    public boolean groupMappingExists(String groupName) {
        try {
            String sql = "SELECT 1 FROM group_mapping WHERE groupName = ?"; // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º –≥—Ä—É–ø–ø—ã –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–¥
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupName);
            
            ResultSet result = pstatment.executeQuery();
            boolean exists = result.next();
            
            result.close();
            pstatment.close();
            return exists;
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ mapping –≥—Ä—É–ø–ø—ã: ", e);
        }
    }
    
    
    @Override
    public void updateMappingTimestamp(String groupName) {
        try {
            String sql = "UPDATE group_mapping SET lastUpdated = CURRENT_TIMESTAMP WHERE groupName = ?";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupName);
            pstatment.executeUpdate();
            pstatment.close();
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ mapping", e);
        }
    }
    
    
    @Override
    public void technicalMaintenance(int daysOld) {
        try {
            String sql = "DELETE FROM group_mapping WHERE lastUpdated < datetime('now', ?)";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, "-" + daysOld + " days");
            
            int deletedCount = pstatment.executeUpdate();
            pstatment.close();
            
            System.out.println("–£–¥–∞–ª–µ–Ω–æ —É—Å—Ç–∞—Ä–µ–≤—à–∏—Ö mapping: " + deletedCount);
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö mapping", e);
        }
    }


    @Override
    public Schedule getScheduleByGroupId(String groupId) {
        try {
            String groupSql = "SELECT groupName FROM groups WHERE groupId = ?"; // –≤–µ—Ä–Ω–µ—Ç –∏–º—è –≥—Ä—É–ø–ø—ã, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∞–π–¥–∏
            PreparedStatement pstatment = connection.prepareStatement(groupSql);
            pstatment.setString(1, groupId);
            
            ResultSet result = pstatment.executeQuery();
            if (!result.next()) { // –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            	result.close();
            	pstatment.close();
                return null;
            }
            
            String groupName = result.getString("groupName");
            result.close();
            pstatment.close();

            String lessonsSql = "SELECT dayOfWeek, subject, startTime, endTime, classroom " +
                               "FROM schedule_lessons WHERE groupId = ? ORDER BY dayOfWeek, startTime"; // ORDER BY dayOfWeek, startTime —Å–æ—Ä—Ç–∏—Ä—É–µ—Ç –ø–æ –¥–Ω—é –Ω–µ–¥–µ–ª–∏ –∏ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞—á–∞–ª–∞
            
            PreparedStatement lessonsStmt = connection.prepareStatement(lessonsSql);
            lessonsStmt.setString(1, groupId);
            
            ResultSet lessonsResult = lessonsStmt.executeQuery();
            
            Schedule schedule = new Schedule(groupId, groupName);
            
            while (lessonsResult.next()) {
                String dayOfWeek = lessonsResult.getString("dayOfWeek");
                String subject = lessonsResult.getString("subject");
                LocalTime startTime = LocalTime.parse(lessonsResult.getString("startTime")); // –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–∞–∫ —Å—Ç—Ä–æ–∫—É –∏ –ø–∞—Ä—Å–∏–º –≤ LocalTime –æ–±—ä–µ–∫—Ç
                LocalTime endTime = LocalTime.parse(lessonsResult.getString("endTime"));
                String classroom = lessonsResult.getString("classroom");
                
                Lesson lesson = new Lesson(subject, startTime, endTime, classroom);
                schedule.addLesson(dayOfWeek, lesson); // –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–∞—Ä—É –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–¥ –Ω—É–∂–Ω—ã–º –¥–Ω–µ–º
            }
            
            lessonsResult.close();
            lessonsStmt.close();
            return schedule;
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ ID –≥—Ä—É–ø–ø—ã: ", e);
        }
    }

    
    @Override
    public Schedule getScheduleByGroupName(String groupName) {
        try {
            String groupId = getGroupIdByName(groupName); // –ù–∞—Ö–æ–¥–∏–º groupId —á–µ—Ä–µ–∑ mapping
            if (groupId == null) {
                return null;  // –µ—Å–ª–∏ –≥—Ä—É–ø–ø–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
            }
            
            return getScheduleByGroupId(groupId);
            
        } catch (Exception e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –ø–æ –∏–º–µ–Ω–∏ –≥—Ä—É–ø–ø—ã: ", e);
        }
    }

    @Override
    public void saveSchedule(Schedule schedule) {
        if (scheduleExists(schedule.getGroupId())) {
            throw new ScheduleStorageException("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        
        try {
            if (!groupMappingExists(schedule.getGroupName())) { // –°–æ—Ö—Ä–∞–Ω—è–µ–º mapping (–µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç)
                saveGroupMapping(schedule.getGroupName(), schedule.getGroupId());
            } else {
                updateMappingTimestamp(schedule.getGroupName()); // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –µ—Å–ª–∏ mapping —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            }

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –≥—Ä—É–ø—Å
            String groupSql = "INSERT INTO groups (groupId, groupName) VALUES (?, ?)";
            PreparedStatement groupStmt = connection.prepareStatement(groupSql);
            groupStmt.setString(1, schedule.getGroupId());
            groupStmt.setString(2, schedule.getGroupName());
            groupStmt.executeUpdate();
            groupStmt.close();

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ä—ã
            String lessonSql = "INSERT INTO schedule_lessons (groupId, dayOfWeek, subject, startTime, endTime, classroom) VALUES (?, ?, ?, ?, ?, ?)";
            PreparedStatement lessonStmt = connection.prepareStatement(lessonSql);
            
            for (Map.Entry<String, List<Lesson>> entry : schedule.getWeeklySchedule().entrySet()) {
                String day = entry.getKey();
                for (Lesson lesson : entry.getValue()) {
                    lessonStmt.setString(1, schedule.getGroupId());
                    lessonStmt.setString(2, day);
                    lessonStmt.setString(3, lesson.getSubject());
                    lessonStmt.setString(4, lesson.getStartTime().toString());
                    lessonStmt.setString(5, lesson.getEndTime().toString());
                    lessonStmt.setString(6, lesson.getClassroom());
                    lessonStmt.addBatch(); // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ø–∞—á–∫—É, –Ω–æ –ø–æ–∫–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–µ–º
                }
            }
            lessonStmt.executeBatch(); // –≤—ã–ø–æ–ª–Ω—è–µ–º –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∑–∞ —Ä–∞–∑
            lessonStmt.close();
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã", e);
        }
    }

    @Override
    public void updateSchedule(Schedule schedule) {
        if (!scheduleExists(schedule.getGroupId())) {
            throw new ScheduleStorageException("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        
        deleteSchedule(schedule.getGroupId());
        
        saveSchedule(schedule);
    }
    
    
    @Override
    public void deleteSchedule(String groupId) {
        try {
            // –£–¥–∞–ª—è–µ–º –ø–∞—Ä—ã
            String lessonsSql = "DELETE FROM schedule_lessons WHERE groupId = ?";
            PreparedStatement lessonsStmt = connection.prepareStatement(lessonsSql);
            lessonsStmt.setString(1, groupId);
            lessonsStmt.executeUpdate();
            lessonsStmt.close();

            // –£–¥–∞–ª—è–µ–º –≥—Ä—É–ø–ø—É
            String groupSql = "DELETE FROM groups WHERE groupId = ?";
            PreparedStatement groupStmt = connection.prepareStatement(groupSql);
            groupStmt.setString(1, groupId);
            groupStmt.executeUpdate();
            groupStmt.close();
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã: ", e);
        }
    }
    

    @Override
    public boolean scheduleExists(String groupId) {
        try {
            String sql = "SELECT 1 FROM groups WHERE groupId = ?";
            PreparedStatement pstatment = connection.prepareStatement(sql);
            pstatment.setString(1, groupId);
            
            ResultSet result = pstatment.executeQuery();
            boolean exists = result.next();
            
            result.close();
            pstatment.close();
            
            return exists;
            
        } catch (SQLException e) {
            throw new ScheduleStorageException("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –≥—Ä—É–ø–ø—ã: ", e);
        }
    }
    
    
    @Override
    public void close() {
        try {
            if (connection != null) {
                connection.close();
            }
        } catch (SQLException e) {
        }
    }
}package bot.schedule;

import okhttp3.OkHttpClient; // –∏–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ OkHttp –¥–ª—è HTTP –∑–∞–ø—Ä–æ—Å–æ–≤
import okhttp3.Request;
import okhttp3.Response;
import java.io.IOException;
import java.time.Duration; // –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞–º–∏

public class UrfuApiClient {
	
    private final OkHttpClient client; // –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–æ–ª—è - –∫–ª–∏–µ–Ω—Ç 

    public UrfuApiClient() { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä 
        client = new OkHttpClient.Builder() 
                .connectTimeout(Duration.ofSeconds(20)) // —Ç–∞–π–º–∞—É—Ç –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ—Ç 20 —Å–µ–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è - —Ç–æ –±—Ä–æ—Å–∞–µ–º –∏—Å–∫–ª—é—á–µ–Ω–∏–µ)
                .readTimeout(Duration.ofSeconds(30)) // –≤—Ä–µ–º—è –Ω–∞ —á—Ç–µ–Ω–∏–µ
                .callTimeout(Duration.ofSeconds(60)) // –æ–±—â–∏–π —Ç–∞–π–º–µ—Ä –Ω–∞ –∑–∞–ø—Ä–æ—Å
                .build(); // –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
    }

    
    public String get(String url) throws IOException {
        Request req = new Request.Builder() // –±–∏–ª–¥–µ—Ä –¥–ª—è http –∑–∞–ø—Ä–æ—Å–∞
                .url(url)
                .header("Accept", "application/json") // –∑–∞–≥–æ–ª–æ–≤–æ–∫ (–≥–æ–≤–æ—Ä–∏—Ç —Å–µ—Ä–≤–µ—Ä—É, —á—Ç–æ –º—ã –∂–¥–µ–º json –≤ –æ—Ç–≤–µ—Ç)
                .build();
        
        // —Å–æ–∑–¥–∞–µ—Ç –≤—ã–∑–æ–≤ –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å (response —Å–∞–º –∑–∞–∫—Ä–æ–µ—Ç—Å—è, —Ç–∫ try-with-resources)
        // newCall —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç Call –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞
        try (Response resp = client.newCall(req).execute()) { 
            if (!resp.isSuccessful()) { // –ø—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –æ—Ç–≤–µ—Ç–∞
                throw new IOException();
            }
            
            if(resp.body() == null) {
            	return "";
            	
            } else {
            	return resp.body().string(); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ–ª–æ –æ—Ç–≤–µ—Ç–∞ –∫–∞–∫ —Å—Ç—Ä–æ–∫—É
            }
        }
    }
}
package bot.scheduler;

import bot.homework.HomeworkItem;
import bot.homework.SQLiteHomeworkStorage;
import bot.schedule.Lesson;
import bot.schedule.Schedule;
import bot.schedule.ScheduleManager;
import bot.start.Homeworkbot;
import bot.user.User;
import bot.user.SQLiteUserStorage;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

import java.time.*;
import java.time.format.DateTimeFormatter;
import java.util.*;
import java.util.concurrent.*;


/**
 * DailyNotifier ‚Äî –∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –µ–∂–µ–¥–Ω–µ–≤–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
 * –≤–µ—á–µ—Ä–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–µ–¥–º–µ—Ç–∞—Ö —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è –∏ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏—è—Ö.
 *
 * –ö–∞–∫ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç (–≤–∫—Ä–∞—Ç—Ü–µ):
 *  - –ü—Ä–∏ —Å—Ç–∞—Ä—Ç–µ (startAll()) –±–µ—Ä—ë—Ç –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ SQLiteUserStorage.
 *  - –î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–ª–∞–Ω–∏—Ä—É–µ—Ç –∑–∞–¥–∞—á—É –æ—Ç–ø—Ä–∞–≤–∫–∏:
 *      - –≤—ã—á–∏—Å–ª—è–µ—Ç –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–∞—Ä—ã –Ω–∞ —Ç–µ–∫—É—â–∏–π –¥–µ–Ω—å (–µ—Å–ª–∏ –µ—Å—Ç—å) –∏ —Å—Ç–∞–≤–∏—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ +1.5 —á–∞—Å–∞,
 *      - –∏–ª–∏ (–µ—Å–ª–∏ –ø–∞—Ä –Ω–µ—Ç) —Å—Ç–∞–≤–∏—Ç –æ—Ç–ø—Ä–∞–≤–∫—É –Ω–∞ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è (20:00) —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è.
 *  - –í –º–æ–º–µ–Ω—Ç –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ:
 *      - —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å (—á–µ—Ä–µ–∑ ScheduleManager),
 *      - –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
 *        (SQLiteHomeworkStorage.getActiveHomeworkBySubjects),
 *      - –∑–∞–¥–∞–Ω–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å (getHomeworkWithCustomDeadline),
 *      - —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Homeworkbot.execute(SendMessage).
 *
 */
public class DailyNotifier {

    private final Homeworkbot bot; // —ç–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ ‚Äî –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    private final SQLiteUserStorage userStorage;
    private final SQLiteHomeworkStorage hwStorage;
    private final ScheduleManager scheduleManager;
    private final ScheduledExecutorService scheduler; // –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–¥–∞—á (–ü–æ–∑–≤–æ–ª—è–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å –∑–∞–¥–∞—á–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π)
    private final ZoneId zone; // –≤—Ä–µ–º–µ–Ω–Ω–∞—è –∑–æ–Ω–∞ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏–π (—Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å ScheduleFetcher)


    private final long retryDelaySeconds = 60; // –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ (—Å–µ–∫—É–Ω–¥—ã)


    public DailyNotifier(Homeworkbot bot,
                         SQLiteUserStorage userStorage,
                         SQLiteHomeworkStorage hwStorage) {
        this.bot = bot;
        this.userStorage = userStorage;
        this.hwStorage = hwStorage;
        this.scheduleManager = new ScheduleManager(userStorage);
        this.scheduler = Executors.newScheduledThreadPool(4); // –ø—É–ª –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
        this.zone = ZoneId.of("Asia/Yekaterinburg");
    }


    public void startAll() { // –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        List<User> users;
        try {
            users = userStorage.getRegisteredUsers(); // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ state = REGISTERED
        } catch (Exception e) {
            System.out.println("DailyNotifier: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: " + e.getMessage());
            return;
        }

        for (User u : users) {
            scheduleForUser(u);
        }
    }


    public void scheduleForUser(User user) { // –ü–ª–∞–Ω–∏—Ä—É–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        LocalDate today = LocalDate.now(zone);

        LocalDateTime now = LocalDateTime.now(zone);  // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è

        // –í—ã—á–∏—Å–ª—è–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–∞—Ä—ã —Å–µ–≥–æ–¥–Ω—è (–µ—Å–ª–∏ –µ—Å—Ç—å)
        Optional<LocalDateTime> lastEnd = getLastLessonEndForUserOn(user, today);
        // Optional<T> ‚Äî —ç—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ª–∏–±–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –∑–Ω–∞—á–µ–Ω–∏–µ —Ç–∏–ø–∞ T, –ª–∏–±–æ –ø—É—Å—Ç

        LocalDateTime sendAt;
        if (lastEnd.isPresent()) { // –µ—Å–ª–∏ optional –Ω–µ –ø—É—Å—Ç–æ–π
            sendAt = lastEnd.get().plusMinutes(60); // +1 —á–∞—Å
        } else {
            sendAt = LocalDateTime.of(today, LocalTime.of(15, 00)); // —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ 15:00
        }

        if (sendAt.isBefore(now)) { // –µ—Å–ª–∏ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–∂–µ –ø—Ä–æ—à–ª–æ

            long minutesLate = Duration.between(sendAt, now).toMinutes(); // —Å—á–∏—Ç–∞–µ–º, –Ω–∞—Å–∫–æ–ª—å–∫–æ –æ–Ω–æ –ø—Ä–æ—à–ª–æ

            if (minutesLate <= 5) {
                // –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:
                // –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è —á—É—Ç—å –ø–æ–∑–∂–µ / retry / –ª–∞–≥–∏
                // –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –°–†–ê–ó–£
                sendAt = now.plusSeconds(5);
            } else {
                // –î–µ–Ω—å —Ä–µ–∞–ª—å–Ω–æ –ø—Ä–æ—à–µ–ª —Ç–æ —Å—á–∏—Ç–∞–µ–º —Å–ª–µ–¥ –¥–µ–Ω—å
                LocalDate nextDay = today.plusDays(1);

                Optional<LocalDateTime> nextLastEnd =
                        getLastLessonEndForUserOn(user, nextDay);

                if (nextLastEnd.isPresent()) {
                    sendAt = nextLastEnd.get().plusMinutes(60);
                } else {
                    sendAt = LocalDateTime.of(nextDay, LocalTime.of(15, 0));
                }
            }
        }

        long delayMillis = Duration.between(now, sendAt).toMillis(); // –±–µ—Ä–µ–º —Ä–∞–∑–Ω–∏—Ü—É –≤–æ –≤—Ä–µ–º–µ–Ω–∏ (—Å–µ–π—á–∞—Å - –∫–æ–≥–¥–∞ –¥–æ–ª–∂–Ω—ã  –æ—Ç–ø—Ä–∞–≤–∏—Ç—å) –≤ –º–∏–ª–∏—Å–µ–∫

        if (delayMillis < 0) delayMillis = 0;

        scheduler.schedule(() -> runSendForUser(user), delayMillis, TimeUnit.MILLISECONDS); // –ª—è–º–±–¥–∞ —Ñ—É–Ω—Ü–∏—è, –∫–æ—Ç–æ—Ä–∞—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç runSendForUser —á–µ—Ä–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é –∑–∞–¥–µ—Ä–∂–∫—É
    }


    /**
     * –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –ª–æ–≥–∏–∫–∞ ‚Äî —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
     * –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É —á–µ—Ä–µ–∑ retryDelaySeconds.
     * –ü–æ—Å–ª–µ –ø–æ–ø—ã—Ç–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–µ—Ä–µ–ø–ª–∞–Ω–∏—Ä—É–µ—Ç —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ 24 —á–∞—Å–∞.
     */
    private void runSendForUser(User user) {

        try {

            if (!user.getSubscriptionEnabled()) {
                System.out.println("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å " + user.getChatId() + " –æ—Ç–∫–ª—é—á–∏–ª —Ä–∞—Å—Å—ã–ª–∫—É - –ø—Ä–æ–ø—É—Å–∫–∞–µ–º");
                scheduleForUser(user);
                return;
            }

            try { // –ø–µ—Ä–µ–¥ —Ä–∞—Å—Å—ã–ª–∫–æ–π —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∑
                hwStorage.deleteOldHomework(LocalDate.now(zone));
            } catch (Exception e) {
                System.out.println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å—Ç–∞—Ä—ã—Ö –î–ó: " + e.getMessage());
            }

            LocalDate today = LocalDate.now(zone);
            LocalDate nextDay = today.plusDays(1);

            // –ü–æ–ª—É—á–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–∂–µ—Ç –±—ã—Ç—å null)
            Schedule schedule = null;
            try {
                schedule = scheduleManager.getScheduleForUser(user.getChatId());
            } catch (Exception e) {
                System.out.println("DailyNotifier: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è " + user.getChatId() + ": " + e.getMessage());
            } // –ª–æ–≥–∏—Ä—É–µ–º, –Ω–æ –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º


            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å (—Å —É—á—ë—Ç–æ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞ –∫–ª—é—á–µ–π)
            List<Lesson> lessonsNextDay;
            if (schedule != null) {
                lessonsNextDay = getLessonsIgnoreCase(schedule, nextDay.getDayOfWeek().name());
            } else {
                lessonsNextDay = Collections.emptyList();
            }


            // –°–æ–±–∏—Ä–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–∞–∑–≤–∞–Ω–∏–π –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π
            List<String> subjectNames = new ArrayList<>();
            for (Lesson l : lessonsNextDay) {
                if (l != null && l.getSubject() != null && !l.getSubject().trim().isEmpty()) {
                    subjectNames.add(l.getSubject().trim());
                }
            }


            // 1) –î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–Ω—è
            List<HomeworkItem> hwForNextDay = Collections.emptyList();
            try {
                hwForNextDay = hwStorage.getActiveHomeworkBySubjects(user.getChatId(), subjectNames);
            } catch (Exception e) {
                System.out.println("DailyNotifier: –æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è hwForNextDay for user " + user.getChatId() + ": " + e.getMessage());
            }

            // 2) –ó–∞–¥–∞–Ω–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ nextDay (–∏—Å–∫–ª—é—á–∞—è –ø—Ä–µ–¥–º–µ—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ —É–∂–µ —É—á—Ç–µ–Ω—ã)
            List<HomeworkItem> hwCustom = Collections.emptyList();
            try {
                hwCustom = hwStorage.getHomeworkWithCustomDeadline(user.getChatId(), subjectNames, nextDay);
            } catch (Exception e) {
                System.out.println("DailyNotifier: –æ—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è hwCustom for user " + user.getChatId() + ": " + e.getMessage());
            }

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
            String message = buildMessage(user, nextDay, lessonsNextDay, hwForNextDay, hwCustom);

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –±–æ—Ç
            SendMessage sm = new SendMessage(String.valueOf(user.getChatId()), message);
            try {
                bot.execute(sm);
                scheduleForUser(user);
            } catch (TelegramApiException e) {
                System.out.println("DailyNotifier: –æ—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é " + user.getChatId() + ": " + e.getMessage());
                // –ü–æ–≤—Ç–æ—Ä–∏–º –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ
                scheduler.schedule(() -> runSendForUser(user), retryDelaySeconds, TimeUnit.SECONDS);
                return;
            }

        } catch (Exception e) {
            e.printStackTrace();
        }
    }



    private String buildMessage(User user,
                                LocalDate date,
                                List<Lesson> lessonsNextDay,
                                List<HomeworkItem> hwForNextDay,
                                List<HomeworkItem> hwCustom) {

        DateTimeFormatter df = DateTimeFormatter.ofPattern("dd.MM.yyyy"); // —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤—â–∏–∫ –¥–∞—Ç –∏–∑ Java Time API
        StringBuilder sb = new StringBuilder();
        sb.append("–ü—Ä–∏–≤–µ—Ç");
        if (user.getName() != null && !user.getName().isEmpty()) {
            sb.append(", ").append(user.getName());
        }
        sb.append("!\n\n");
        sb.append("–ü–ª–∞–Ω –Ω–∞ ").append(date.format(df)).append(":\n\n");

        if (lessonsNextDay == null || lessonsNextDay.isEmpty()) {
            sb.append("‚Äî –ó–∞–≤—Ç—Ä–∞ –Ω–µ—Ç –ø–∞—Ä, –º–æ–∂–Ω–æ –æ—Ç–¥–æ—Ö–Ω—É—Ç—å!.\n\n");
        } else {
            sb.append("–ü—Ä–µ–¥–º–µ—Ç—ã:\n");
            for (Lesson l : lessonsNextDay) {
                sb.append("- ").append(l.getSubject() == null ? "-" : l.getSubject());
                if (l.getStartTime() != null && l.getEndTime() != null) {
                    sb.append(" (").append(l.getStartTime()).append(" - ").append(l.getEndTime()).append(")");
                }
                if (l.getClassroom() != null && !l.getClassroom().isEmpty()) {
                    sb.append(" ").append(l.getClassroom());
                }
                sb.append("\n");
            }
            sb.append("\n");
        }

        sb.append("–î–æ–º–∞—à–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –∑–∞–≤—Ç—Ä–∞:\n");
        if (hwForNextDay == null || hwForNextDay.isEmpty()) {
            sb.append("‚Äî –Ω–µ—Ç\n\n");
        } else {
            for (HomeworkItem h : hwForNextDay) {
                sb.append(formatHomeworkItem(h)).append("\n");
            }
            sb.append("\n");
        }

        sb.append("–ó–∞–¥–∞–Ω–∏—è —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º –¥–µ–¥–ª–∞–π–Ω–æ–º –Ω–∞ ").append(date.format(df)).append(":\n");
        if (hwCustom == null || hwCustom.isEmpty()) {
            sb.append("‚Äî –Ω–µ—Ç\n");
        } else {
            for (HomeworkItem h : hwCustom) {
                sb.append(formatHomeworkItem(h)).append("\n");
            }
        }

        sb.append("\n–î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /homework –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ /addhw.");
        return sb.toString();
    }


    private String formatHomeworkItem(HomeworkItem h) { // —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä –¥–ª—è –æ–¥–Ω–æ–≥–æ –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è
        StringBuilder sb = new StringBuilder();
        sb.append("ID: ").append(h.getId()).append(" | ");
        sb.append(h.getSubject() == null ? "-" : h.getSubject()).append(" ‚Äî ");
        sb.append(h.getDescription() == null || h.getDescription().isEmpty() ? "-" : h.getDescription());
        sb.append(" (–¥–æ ").append(h.getDueDate()).append(") ");
        sb.append(h.isCompleted() ? "‚úÖ" : "‚è≥");
        return sb.toString();
    }

    // –ù–∞—Ö–æ–¥–∏—Ç –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø–∞—Ä—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É
    private Optional<LocalDateTime> getLastLessonEndForUserOn(User user, LocalDate date) {
        try {
            Schedule schedule = scheduleManager.getScheduleForUser(user.getChatId());
            if (schedule == null) {
                return Optional.empty();
            }

            List<Lesson> lessons = getLessonsIgnoreCase(schedule, date.getDayOfWeek().name());
            LocalTime latest = null;
            for (Lesson l : lessons) {
                if (l != null && l.getEndTime() != null) {
                    if (latest == null || l.getEndTime().isAfter(latest)) {
                        // isAfter(latest) –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç true –µ—Å–ª–∏ —É —Ç–µ–∫—É—â–µ–π –ø–∞—Ä—ã –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–∑–∂–µ —á–µ–º latest
                        latest = l.getEndTime();
                    }
                }
            }
            if (latest == null) {
                return Optional.empty();
            }
            return Optional.of(LocalDateTime.of(date, latest));
        } catch (Exception e) {
            // –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ - –≤–æ–∑–≤—Ä–∞—â–∞–µ–º empty
            return Optional.empty();
        }
    }


    private List<Lesson> getLessonsIgnoreCase(Schedule sched, String dayKey) { // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤ –∏–∑ Schedule –ø–æ –∫–ª—é—á—É –¥–Ω—è
        if (sched == null || sched.getWeeklySchedule() == null) {
            return Collections.emptyList();
        }

        Map<String, List<Lesson>> map = sched.getWeeklySchedule();

        if (map.containsKey(dayKey) && map.get(dayKey) != null) {
            return map.get(dayKey);
        }

        for (String k : map.keySet()) {
            if (k != null && k.equalsIgnoreCase(dayKey)) {
                return map.get(k);
            }
        }
        return Collections.emptyList();
    }


    public void stop() { // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏ –∑–∞–∫—Ä—ã—Ç—å —Ä–µ—Å—É—Ä—Å—ã
        try {
            scheduler.shutdownNow();
        } finally {
            try {
                scheduleManager.close();
            } catch (Exception ignored) {}
            try {
                hwStorage.close();
            } catch (Exception ignored) {}
        }
    }
}package bot.session;

import java.util.concurrent.ConcurrentHashMap; // –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å (–ø–æ—Ç–æ—á–Ω–æ-–±–µ–∑–æ–ø–∞—Å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è map)
import java.util.Map;

public class EditSessionManager {
    private static final Map<Long, Session> sessions = new ConcurrentHashMap<>();

    public static Session getSession(long chatId) {
    	Session session = sessions.get(chatId);
    	if (session == null) {
    	    session = new Session();
    	    sessions.put(chatId, session);
    	}
    	return session;
    }

    public static void clearSession(long chatId) {
        sessions.remove(chatId);
    }
}
package bot.session;

public class Session {
    private String day;
    private Integer lessonIndex;
    private String subject;
    private String room;
    private String timeBegin;
    private String timeEnd;

    // –≥–µ—Ç—Ç–µ—Ä—ã –∏ —Å–µ—Ç—Ç–µ—Ä—ã
    public String getDay() { 
    	return day;
    	}
    
    public void setDay(String day) { 
    	this.day = day;
    	}

    public Integer getLessonIndex() {
    	return lessonIndex;
    	}
    
    public void setLessonIndex(Integer lessonIndex) { 
    	this.lessonIndex = lessonIndex;
    	}

    public String getSubject() {
    	return subject;
    	}
    
    public void setSubject(String subject) { 
    	this.subject = subject;
    	}

    public String getRoom() {
    	return room;
    	}
    
    public void setRoom(String room) {
    	this.room = room;
    	}

    public String getTimeBegin() { 
    	return timeBegin;
    	}
    
    public void setTimeBegin(String timeBegin) { 
    	this.timeBegin = timeBegin;
    	}

    public String getTimeEnd() { 
    	return timeEnd;
    	}
    
    public void setTimeEnd(String timeEnd) { 
    	this.timeEnd = timeEnd;
    	}
    
}package bot.start;

import bot.commands.*;
import bot.user.*;
import bot.fsm.*;
import bot.schedule.ScheduleManager;
import bot.homework.*;
import bot.scheduler.*;

import org.telegram.telegrambots.bots.TelegramLongPollingBot;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.Update;
import org.telegram.telegrambots.meta.exceptions.TelegramApiException;

import java.util.Map;
import java.util.TreeMap; // —Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ª–æ–≤–∞—Ä—å

public class Homeworkbot extends TelegramLongPollingBot {

    private final Map<String, Command> commands = new TreeMap<>();

    private final UserStorage userStorage;
    private final StartCommand startCommand;
    private final EditScheduleCommand editScheduleCommand; 
    private final DialogStateMachine stateMachine;
    private final ShareGroupCommand shareGroupCommand;

    private final String envToken = System.getenv("BOT_TOKEN");
    
    private DailyNotifier notifier;                    
    private SQLiteHomeworkStorage hwStorageForNotifier; 

    public Homeworkbot() {
        userStorage = new SQLiteUserStorage();
        userStorage.initialize();
        startCommand = new StartCommand(userStorage);
        editScheduleCommand = new EditScheduleCommand(userStorage, new ScheduleManager(userStorage));
        shareGroupCommand = new ShareGroupCommand(userStorage, getBotUsername(), 1); // —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è 1 –¥–µ–Ω—å
        AddHomeworkCommand addHomeworkCommand = new AddHomeworkCommand(userStorage);
        
        commands.put("/start", startCommand);
        commands.put("/about", new AboutCommand());
        commands.put("/authors", new AuthorsCommand());
        commands.put("/help", new HelpCommand(commands));
        commands.put("/schedule", new ScheduleCommand(userStorage)); 
        commands.put("/editschedule", editScheduleCommand); 
        commands.put("/sharegroup", shareGroupCommand);
        commands.put("/addhw", addHomeworkCommand);
        commands.put("/deletehw", new DeleteHomeworkCommand());
        commands.put("/homework", new PrintHomeworkCommand());
        commands.put("/markhw", new MarkHomeworkCommand(true));
        commands.put("/unmarkhw", new MarkHomeworkCommand(false));
        commands.put("/subscription", new SubscriptionCommand(userStorage));
        
        InviteHandler inviteHandler = new InviteHandler(userStorage); // —Å–æ–∑–¥–∞–µ–º invitehandler

        stateMachine = new DialogStateMachine(userStorage, startCommand, editScheduleCommand, inviteHandler, addHomeworkCommand);
        
        initNotifier();

    }
    
    
    public void initNotifier() {
        SQLiteHomeworkStorage hw = new SQLiteHomeworkStorage(); // 1) –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º hw storage
        hw.initialize();

        // 2) –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ userStorage ‚Äî —ç—Ç–æ SQLiteUserStorage, –ø—Ä–µ–∂–¥–µ —á–µ–º –∫–∞—Å—Ç–∏—Ç—å
        if (!(userStorage instanceof SQLiteUserStorage)) {
            System.out.println("UserStorage isn't SQLiteUserStorage ‚Äî notifier requires SQLiteUserStorage. Not starting notifier.");
            try { hw.close(); } catch (Exception ignored) {} // –ó–∞–∫—Ä—ã–≤–∞–µ–º hw, —Ç–∞–∫ –∫–∞–∫ notifier –Ω–µ –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è
            return;
        }

        // 3) –°–æ–∑–¥–∞—ë–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º DailyNotifier 
        try {
            DailyNotifier localNotifier = new DailyNotifier(this, (SQLiteUserStorage) userStorage, hw); 
            localNotifier.startAll(); // –ø–ª–∞–Ω–∏—Ä—É–µ–º —Ä–∞—Å—Å—ã–ª–∫–∏
            this.notifier = localNotifier;
            this.hwStorageForNotifier = hw; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ hw –≤ –ø–æ–ª–Ω–µ –∫–ª–∞—Å—Å–∞, —á—Ç–æ–±—ã –ø–æ—Ç–æ–º –∑–∞–∫—Ä—ã—Ç—å

            // 4) –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º shutdown hook ( –ø–æ—Ç–æ–∫, –∫–æ—Ç–æ—Ä—ã–π JVM –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç –ø—Ä–∏ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ JVM)
            Runtime.getRuntime().addShutdownHook(new Thread(() -> {
                System.out.println("Shutdown hook: –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º DailyNotifier...");
                try {
                    if (notifier != null) notifier.stop();
                } catch (Exception ignored) {}
                try {
                    if (hwStorageForNotifier != null) {
                    	hwStorageForNotifier.close();
                    }
                } catch (Exception ignored) {}
            }));

        } catch (Exception e) {
            System.out.println("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ DailyNotifier: " + e.getMessage());
            e.printStackTrace();
            try { hw.close(); } catch (Exception ignored) {}
        }
    }

    @Override
    public void onUpdateReceived(Update update) {  // –æ–±—ä–µ–∫—Ç update - —ç—Ç–æ –≤—Å—ë, —á—Ç–æ –ø—Ä–∏—à–ª–æ –æ—Ç –¢–ì
        if (update.hasMessage() && update.getMessage().hasText()) {
            String text = update.getMessage().getText().trim(); // trim —É–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–±–µ–ª—ã —Å –∫–æ–Ω—Ü–∞ –∏ –Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∏
            long chatId = update.getMessage().getChatId(); // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä —á–∞—Ç–∞
            
            if (text != null && text.startsWith("/start invite_")) {
                try {
                    SendMessage response = stateMachine.handleInput(chatId, text);
                    if (response != null) {
                        execute(response);
                        return; // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É, —Ç–∞–∫ –∫–∞–∫ –∏–Ω–≤–∞–π—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω
                    }
                } catch (Exception e) {
                    System.out.println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∏–Ω–≤–∞–π—Ç–∞: " + e.getMessage());
                    sendText(chatId, "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è.");
                    return;
                }
            }

            String[] parts = text.split("\\s+", 2); // —Ä–µ–≥—É–ª—è—Ä–∫–∞: 1 –∏–ª–∏ –±–æ–ª–µ–µ –ø—Ä–æ–±–µ–ª–æ–≤
            String commandName = parts[0].toLowerCase(); // toLowerCase —á—Ç–æ–±—ã —Ä–µ–≥–∏—Å—Ç—Ä –Ω–µ –º–µ—à–∞–ª

            try {
                if (text.startsWith("/")) {  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥–æ–π
                    Command cmd = commands.get(commandName); // –∏—â–µ–º –∫–æ–º–∞–Ω–¥—É –≤ –º–∞–ø–µ
                    if (cmd != null) {
                    	
                        if (cmd instanceof StartCommand) {
                            execute(startCommand.processStart(chatId));  // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ + –∫–Ω–æ–ø–∫–∏

                        } else if (cmd instanceof ScheduleCommand) {
                            String response = ((ScheduleCommand) cmd).realizationWithChatId(chatId, parts);
                            sendText(chatId, response);

                        } else if (cmd instanceof EditScheduleCommand) {
                            execute(((EditScheduleCommand) cmd).processChange(chatId, parts));

                        } else if (cmd instanceof ShareGroupCommand) {
                            String link = shareGroupCommand.start(chatId);
                            sendText(chatId, link);

                        } else if (cmd instanceof AddHomeworkCommand) {
                            AddHomeworkCommand ahref = (AddHomeworkCommand) cmd;
                            SendMessage response = ahref.start(chatId);
                            execute(response); 

                        } else if (cmd instanceof PrintHomeworkCommand) {
                            String response = ((PrintHomeworkCommand) cmd).realizationWithChatId(chatId, parts);
                            sendText(chatId, response);

                        }
                        else if (cmd instanceof DeleteHomeworkCommand) {
                            String response = ((DeleteHomeworkCommand) cmd).realizationWithChatId(chatId, parts);
                            sendText(chatId, response);
                        }

                        else if (cmd instanceof MarkHomeworkCommand) {
                            String response = ((MarkHomeworkCommand) cmd).realizationWithChatId(chatId, parts);
                            sendText(chatId, response);
                            
                        } else if (cmd instanceof SubscriptionCommand) {
                            String response = ((SubscriptionCommand) cmd).realizationWithChatId(chatId, parts);
                            sendText(chatId, response);  

                        } else {
                            sendText(chatId, cmd.realization(parts));
                        }

                    } else {
                        User user = userStorage.getUser(chatId);

                        if (user != null && user.getState() != DialogState.REGISTERED) {
                            // –ø–µ—Ä–µ–¥–∞—ë–º –∫–æ–º–∞–Ω–¥—É –≤ FSM ‚Äî —Ç–∞–º –æ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç—Å—è –∫–∞–∫ /skip
                            SendMessage resp = stateMachine.handleInput(chatId, text);
                            if (resp != null) {
                                execute(resp);
                                return;
                            }
                        }

                        // –µ—Å–ª–∏ –Ω–µ –≤ –¥–∏–∞–ª–æ–≥–µ ‚Äî –≤—ã–≤–æ–¥–∏–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                        sendText(chatId, "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞. –í–≤–µ–¥–∏—Ç–µ /help –¥–ª—è —Å–ø–∏—Å–∫–∞ –∫–æ–º–∞–Ω–¥.");
                    }

                } else {
                    // –æ–±—ã—á–Ω—ã–π –≤–≤–æ–¥ (FSM)
                    SendMessage response = stateMachine.handleInput(chatId, text);
                    execute(response);
                }

            } catch (Exception e) {
                System.out.println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Å–æ–æ–±—â–µ–Ω–∏—è: " + e.getMessage());
                sendText(chatId, "‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.");
            }
        }
    }

    private void sendText(long chatId, String text) {
        SendMessage msg = new SendMessage(String.valueOf(chatId), text);
        try {
            execute(msg);
        } catch (TelegramApiException e) {
            e.printStackTrace();
        }
    }

    @Override
    public String getBotUsername() {
        return "HomeworkHelperUrfu_bot";
    }

    @Override
    public String getBotToken() {
        return envToken;
    }
}package bot.start;

import org.telegram.telegrambots.meta.TelegramBotsApi; // –∫–ª–∞—Å—Å –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –±–æ—Ç–∞ –∏ –∑–∞–ø—É—Å–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å Telegram.
import org.telegram.telegrambots.updatesreceivers.DefaultBotSession; // c–ø–æ—Å–æ–± —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º Telegram —á–µ—Ä–µ–∑ –æ–ø—Ä–æ—Å

public class Main {
    public static void main(String[] args) {
        try {
            TelegramBotsApi botsApi = new TelegramBotsApi(DefaultBotSession.class);
            botsApi.registerBot(new Homeworkbot());
            System.out.println("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω!");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
package bot.user;
import bot.user.exception.UserStorageException;


import java.sql.*;
import bot.fsm.DialogState;

import java.util.List;
import java.util.ArrayList;

public class SQLiteUserStorage implements UserStorage {
    private final String DB_URL = "jdbc:sqlite:users.db"; // –ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    private Connection connection;

    
    @Override
    public void initialize() { // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (—Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç)
        try {
        	
        	// –ø—Ä–æ–≤–µ—Ä—è–µ–º, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –ª–∏ —É–∂–µ connection
            if (this.connection != null && !this.connection.isClosed()) {
                return; // –£–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ
            }
            
            connection = DriverManager.getConnection(DB_URL); // –æ–∫—Ç—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–¥ –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∞–¥—Ä–µ—Å—É
            String sql = "CREATE TABLE IF NOT EXISTS users (" + // —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ sql –∑–∞–ø—Ä–æ—Å–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã
                         "chatId INTEGER PRIMARY KEY," +
                         "name TEXT," +
                         "groupName TEXT," +
                         "university TEXT," +       
                         "department TEXT," +       
                         "course TEXT," +  
                         "state TEXT," +
                         "waitingForButton INTEGER," +
                         "hasCustomSchedule INTEGER DEFAULT 0," +
                         "subscriptionEnabled INTEGER DEFAULT 1" +
                         ")";
            
            // –≤—ã–∑—ã–≤–∞–µ–º —É –æ–±—ä–µ–∫—Ç–∞ connection –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞: –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∑–∞–ø—Ä–æ—Å–æ–≤
            Statement statment = connection.createStatement(); 
            statment.execute(sql); // –≤—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ execute (–æ–±—ä–µ–∫—Ç–∞ statment), –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∑–∞–ø—Ä–æ—Å
            statment.close(); // –∑–∞–∫—Ä—ã–≤–∞–µ–º statment (–∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏, –æ–Ω –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–µ–Ω)
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö", e); 
            // –Ω–µ–ø—Ä–æ–≤–µ—Ä—è–µ–º–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (—á—Ç–æ–±—ã –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        }
    }

    
    @Override 
    public User getUser(long chatId) { // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ chatId (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç —Ç–∏–ø–∞ —é–∑–µ—Ä)
        try {
            String sql = "SELECT * FROM users WHERE chatId = ?"; // "–≤—ã–±—Ä–∞—Ç—å –≤—Å–µ –ø–æ–ª—è –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –∑–∞–¥–∞–Ω–Ω–æ–µ id
            // PreparedStatment - —Ç–∏–ø –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            PreparedStatement pstatment = connection.prepareStatement(sql); // —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä–æ–∫–∏ sql 
            pstatment.setLong(1, chatId);  // –≤ –ø–µ—Ä–≤—ã–π ? –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å chatId
            
            ResultSet result = pstatment.executeQuery(); // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è sql –∑–∞–ø—Ä–æ—Å–∞ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç ResultSet, —Ç.–µ. –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ)
            
            if (result.next()) { // –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –∫—É—Ä—Å–æ—Ä –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∑–∞–ø—Ä–æ—Å–∞
                String name = result.getString("name");
                String group = result.getString("groupName");
                String university = result.getString("university");   
                String department = result.getString("department");   
                String course = result.getString("course");   
                
                String stateStr = result.getString("state");
                DialogState state = DialogState.valueOf(stateStr); // valueOf –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –ø–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è
                
                boolean waitingForButton = result.getInt("waitingForButton") == 1; // –µ—Å–ª–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫–µ —Å–æ–≤–ø–∞–ª–æ —Å 1, —Ç–æ –≤–µ—Ä–Ω–µ—Ç true, –∏–Ω–∞—á–µ false
                boolean hasCustomSchedule = result.getInt("hasCustomSchedule") == 1;
                boolean subscriptionEnabled = result.getInt("subscriptionEnabled") == 1;
                
                		
                
                result.close();
                pstatment.close();
                
                User user = new User(chatId, name, group, university, department, course, state);
                user.setWaitingForButton(waitingForButton); 
                user.setHasCustomSchedule(hasCustomSchedule);
                user.setSubscriptionEnabled(subscriptionEnabled);
                return user;
            }
            result.close();
            pstatment.close();
            return null;
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—â–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ id", e);
        }
    }

    
    @Override
    public void saveUser(User user) { // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (userExists(user.getChatId())) { // –ø—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ
            throw new UserStorageException("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç");
        }
        try {
        	 String sql = "INSERT INTO users (chatId, name, groupName, university, department, course, state, waitingForButton, hasCustomSchedule, subscriptionEnabled) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";
            PreparedStatement pstatment = connection.prepareStatement(sql); // —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç—Ä–æ–∫–∏ sql
            
            pstatment.setLong(1, user.getChatId());
            pstatment.setString(2, user.getName());
            pstatment.setString(3, user.getGroup());
            pstatment.setString(4, user.getUniversity());
            pstatment.setString(5, user.getDepartment()); 
            pstatment.setString(6, user.getCourse());   
            pstatment.setString(7, user.getState().name());
            pstatment.setInt(8, user.getWaitingForButton() ? 1 : 0);
            pstatment.setInt(9, user.getHasCustomSchedule() ? 1 : 0);
            pstatment.setInt(10, user.getSubscriptionEnabled() ? 1 : 0);
            
            pstatment.executeUpdate(); // –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π –∏–∑–º–µ–Ω—è–µ—Ç –¥–∞–Ω–Ω—ã–µ
            
            pstatment.close();
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }

   
    @Override
    public void updateUser(User user) { // –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!userExists(user.getChatId())) { // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞–µ—Ç–ª—è
            throw new UserStorageException("–ü–æ–ª—å–∑–æ–≤–∞–µ—Ç–ª—è —Å —Ç–∞–∫–∏–º ID –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö");
        }
        try {
        	// –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º ID
        	String sql = "UPDATE users SET name = ?, groupName = ?, university = ?, department = ?, course = ?, state = ?, waitingForButton = ?, hasCustomSchedule = ?, subscriptionEnabled = ? WHERE chatId = ?";  
            PreparedStatement pstatment = connection.prepareStatement(sql);
            
            pstatment.setString(1, user.getName());
            pstatment.setString(2, user.getGroup());
            pstatment.setString(3, user.getUniversity()); 
            pstatment.setString(4, user.getDepartment()); 
            pstatment.setString(5, user.getCourse());   
            pstatment.setString(6, user.getState().name());
            pstatment.setInt(7, user.getWaitingForButton() ? 1 : 0);
            pstatment.setInt(8, user.getHasCustomSchedule() ? 1 : 0);
            pstatment.setInt(9, user.getSubscriptionEnabled() ? 1 : 0);
            pstatment.setLong(10, user.getChatId());
            
            pstatment.executeUpdate();
            
            pstatment.close();
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }

   
    @Override
    public void deleteUser(long chatId) { // –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try {
            String sql = "DELETE FROM users WHERE chatId = ?"; // —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É —Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–º Id –∏–∑ 
            PreparedStatement pstatment = connection.prepareStatement(sql);
            
            pstatment.setLong(1, chatId);
            
            pstatment.executeUpdate();
            
            pstatment.close();
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }

    
    @Override
    public boolean userExists(long chatId) { // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        try {
            String sql = "SELECT 1 FROM users WHERE chatId = ?"; // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 1, –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ —Å –∑–∞–¥–∞–Ω–Ω—ã–º ID –Ω–∞–π–¥–µ–Ω–∞ –≤ –±–¥
            PreparedStatement pstatment = connection.prepareStatement(sql);
            
            pstatment.setLong(1, chatId);
            
            ResultSet result = pstatment.executeQuery(); // —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è sql –∑–∞–ø—Ä–æ—Å–∞ (–≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–±—ä–µ–∫—Ç ResultSet, —Ç.–µ. –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ)
            boolean exists = result.next(); // –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç –∫—É—Ä—Å–æ—Ä –∫ —Å–ª–µ–¥—É—é—â–µ–π —Å—Ç—Ä–æ–∫–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –∑–∞–ø—Ä–æ—Å–∞
            
            result.close();
            pstatment.close();
            
            return exists;
            
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è", e);
        }
    }
    
    
    public void close() {
        try {
            if (connection != null) {
            	connection.close();
            }
        } catch (SQLException e) {
            // ignore
        }
    }
    
    
    @Override
    public List<User> getAllUsers() { // –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        List<User> resultList = new ArrayList<>();
        try {
            String sql = "SELECT * FROM users";
            PreparedStatement pstat = connection.prepareStatement(sql);
            ResultSet rs = pstat.executeQuery();
            while (rs.next()) {
                long chatId = rs.getLong("chatId");
                String name = rs.getString("name");
                String group = rs.getString("groupName");
                String university = rs.getString("university");
                String department = rs.getString("department");
                String course = rs.getString("course");
                String stateStr = rs.getString("state");
                DialogState state = null;
                try {
                    state = DialogState.valueOf(stateStr);
                } catch (Exception ignored) {}
                User user = new User(chatId, name, group, university, department, course, state);
                user.setWaitingForButton(rs.getInt("waitingForButton") == 1);
                user.setHasCustomSchedule(rs.getInt("hasCustomSchedule") == 1);
                user.setSubscriptionEnabled(rs.getInt("subscriptionEnabled") == 1);
                
                resultList.add(user);
            }
            rs.close();
            pstat.close();
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", e);
        }
        return resultList;
    }
    
    
    public List<User> getRegisteredUsers() { // –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        List<User> resultList = new ArrayList<>();
        String sql = "SELECT * FROM users WHERE state = ?";

        try (PreparedStatement pstat = connection.prepareStatement(sql)) { // try with resourse
            pstat.setString(1, DialogState.REGISTERED.name());
            try (ResultSet result = pstat.executeQuery()) {
                while (result.next()) {
                    long chatId = result.getLong("chatId");
                    String name = result.getString("name");
                    String group = result.getString("groupName");
                    String university = result.getString("university");
                    String department = result.getString("department");
                    String course = result.getString("course");
                    // —Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç —Å —è–≤–Ω–æ REGISTERED —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
                    User user = new User(chatId, name, group, university, department, course, DialogState.REGISTERED);
                    user.setWaitingForButton(result.getInt("waitingForButton") == 1); // –µ—Å–ª–∏ –≤ –±–∞–∑–µ 1 - —Ç–æ try 
                    user.setHasCustomSchedule(result.getInt("hasCustomSchedule") == 1);
                    user.setSubscriptionEnabled(result.getInt("subscriptionEnabled") == 1);
                    
                    resultList.add(user);
                }
            }
        } catch (SQLException e) {
            throw new UserStorageException("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π", e);
        }
        return resultList;
    }
}package bot.user;
import bot.fsm.DialogState;

public class User {
    private Long chatId;
    private String name;
    private String group;
    private String university; 
    private String department; 
    private String course;
   
    private DialogState state; // –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    private boolean waitingForButton;
    private boolean hasCustomSchedule; 
    private boolean subscriptionEnabled = true;
    
    
    public User(Long chatId) { // –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        this.chatId = chatId;
        this.university = "";
        this.department = "";
        this.course = "";
        this.state = DialogState.ASK_NAME; // –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∏–Ω–∞–µ—Ç —Å —ç—Ç–∞–ø–∞ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏
        this.waitingForButton = false; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false
        this.hasCustomSchedule = false; // —Ñ–ª–∞–≥ –∏–∑–º–µ–Ω—è–ª –ª–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
        this.subscriptionEnabled = true; // –ø–æ–¥–ø–∏—Å–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–∞
        
    }
    // –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    public User(Long chatId, String name, String group, String university, String department, String course, DialogState state) { 
        this.chatId = chatId;
        this.name = name;
        this.group = group;
        this.university = university;
        this.department = department;
        this.course = course;
        this.state = state; // —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        this.waitingForButton = false; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é false
        this.hasCustomSchedule = false;
        this.subscriptionEnabled = true; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤–∫–ª—é—á–µ–Ω–æ
    }

    
    public Long getChatId() {  // Id —á–∞—Ç–∞ –ø–æ–º–µ–Ω—è—Ç—å –Ω–µ –º–æ–∂–µ–º, –º–æ–∂–µ–º —Ç–æ–ª—å–∫–æ –≤–µ—Ä–Ω—É—Ç—å
        return chatId; 
    }
    
    public String getName() { 
        return name; 
    }
    
    public void setName(String name) { 
        this.name = name; 
    }
    
    public String getGroup() { 
        return group; 
    }
    
    public void setGroup(String group) { 
        this.group = group; 
    }
    
    public String getUniversity() {
        return university;
    }

    public void setUniversity(String university) {
        this.university = university;
    }

    public String getDepartment() {
        return department;
    }

    public void setDepartment(String department) {
        this.department = department;
    }

    public String getCourse() {
        return course;
    }

    public void setCourse(String course) {
        this.course = course;
    }
    
    public DialogState getState() { 
        return state; 
    }
    
    public void setState(DialogState state) { 
        this.state = state; 
    }
    
    public boolean getWaitingForButton() {
        return waitingForButton;
    }
    
    public void setWaitingForButton(boolean waitingForButton) {
        this.waitingForButton = waitingForButton;
    }
    
    public boolean getHasCustomSchedule() { 
    	return hasCustomSchedule; 
    	}
    
    public void setHasCustomSchedule(boolean hasCustomSchedule) { 
        this.hasCustomSchedule = hasCustomSchedule; 
    }
    
    public boolean getSubscriptionEnabled() {
        return subscriptionEnabled;
    }
    
    public void setSubscriptionEnabled(boolean subscriptionEnabled) {
        this.subscriptionEnabled = subscriptionEnabled;
    }


    @Override
    public String toString() { // –°—Ç—Ä–æ–∫–æ–≤–æ–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–µ 
        return "User{" +
                "chatId=" + chatId +
                ", name='" + name + '\'' +
                ", group='" + group + '\'' +
                ", university='" + university + '\'' +   
                ", department='" + department + '\'' +   
                ", course='" + course + '\'' +          
                ", state=" + state +
                '}';
    }
}package bot.user;

import java.util.List;

public interface UserStorage {
    
    User getUser(long chatId); // –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É —á–∞—Ç–∞.
    
    void saveUser(User user); // –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    
    void updateUser(User user); // –û–±–Ω–æ–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    void deleteUser(long chatId); // –£–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞.
    
    boolean userExists(long chatId); // –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.
    
    void initialize(); // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (—Å–æ–∑–¥–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—ã, –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –ë–î –∏ —Ç.–¥.)
    
    List<User> getAllUsers(); // –≤–µ—Ä–Ω—É—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    
}package bot.user.exception;

public class ScheduleFetchException extends Exception {
    public ScheduleFetchException(String message) {
        super(message);
    }
}
package bot.user.exception;
// —á—Ç–æ–±—ã –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –Ω–µ –∑–Ω–∞–ª–∞ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏—è—Ö, –∞ –∑–Ω–∞–ª–∞ —Ç–æ–ª—å–∫–æ —Ç–æ, —á—Ç–æ –∏—Å–∫–ª—é—á–µ–µ–Ω–∏–µ –º–æ–∂–µ—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å
public class ScheduleStorageException extends RuntimeException {
    public ScheduleStorageException(String message) { // –°–æ–∑–¥–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å —Ç–µ–∫—Å—Ç–æ–≤—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
        super(message); // –ü–µ—Ä–µ–¥–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä RuntimeException
    }
    
    public ScheduleStorageException(String message, Throwable cause) { // –°–æ–∑–¥–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º –ò –ø—Ä–∏—á–∏–Ω–æ–π
        super(message, cause);
    }
}package bot.user.exception;

public class UserNotFoundException extends RuntimeException {
    public UserNotFoundException(long userId) {
        super("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: " + userId);
    }
    
    public UserNotFoundException(String message) {
        super(message);
    }
}
package bot.user.exception;

public class UserStorageException extends RuntimeException {
    public UserStorageException(String message) {
        super(message);
    }
    
    public UserStorageException(String message, Throwable cause) {
        super(message, cause);
    }
}
package bot.commands;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;

import static org.junit.jupiter.api.Assertions.*;

public class AboutCommandTest {

    @Test // –ø–æ–º–µ—á–∞–µ–º –º–µ—Ç–æ–¥ –∫–∞–∫ —Ç–µ—Å—Ç
    void aboutBasics() {
        AboutCommand cmd = new AboutCommand();

        // –æ–∂–∏–¥–∞–µ–º —Å—Ç—Ä–æ–≥–æ–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–º–µ–Ω–∏ "/about"
        assertEquals("/about", cmd.getName());

        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–∞–Ω–¥–µ –Ω–µ null –∏ –Ω–µ –ø—É—Å—Ç–∞—è
        String info = cmd.getInformation();
        assertNotNull(info, "getInformation() –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å null");
        assertEquals("–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞", info);

        // –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é: –ø–µ—Ä–µ–¥–∞—ë–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –º–∞—Å—Å–∏–≤ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ (–∫–æ–º–∞–Ω–¥–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤)
        String result = cmd.realization(new String[]{"/about"});
        assertNotNull(result, "realization –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å null");
        assertEquals("üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É—á–µ–±–µ \r\n"
        		+ "\r\n"
        		+ "–Ø –±—É–¥—É:\r\n"
        		+ "‚Ä¢ üìÖ –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –ø–∞—Ä\r\n"
        		+ "‚Ä¢ üìö –ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏—è—Ö  \r\n"
        		+ "‚Ä¢ ‚è∞ –ü—Ä–∏—Å—ã–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è\r\n"
        		+ "‚Ä¢ üí´ –ü–æ–º–æ–≥–∞—Ç—å —É—á–∏—Ç—å—Å—è –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞\r\n"
        		+ "\r\n"
        		+ "–í–º–µ—Å—Ç–µ –º—ã —Å–¥–µ–ª–∞–µ–º —É—á–µ–±—É –ø—Ä–æ—â–µ! ‚ú®", result);
    }    
    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ª–∏—â–Ω–∏–µ —Å–ª–æ–≤–∞ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
    void aboutWithExtraWord() {
        AboutCommand cmd = new AboutCommand();
        
        String result = cmd.realization(new String[]{"/about", "extra", "word"});
        assertNotNull(result);
        assertEquals("üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É—á–µ–±–µ \r\n"
        		+ "\r\n"
        		+ "–Ø –±—É–¥—É:\r\n"
        		+ "‚Ä¢ üìÖ –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –ø–∞—Ä\r\n"
        		+ "‚Ä¢ üìö –ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏—è—Ö  \r\n"
        		+ "‚Ä¢ ‚è∞ –ü—Ä–∏—Å—ã–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è\r\n"
        		+ "‚Ä¢ üí´ –ü–æ–º–æ–≥–∞—Ç—å —É—á–∏—Ç—å—Å—è –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞\r\n"
        		+ "\r\n"
        		+ "–í–º–µ—Å—Ç–µ –º—ã —Å–¥–µ–ª–∞–µ–º —É—á–µ–±—É –ø—Ä–æ—â–µ! ‚ú®", result);
    }
    
    
    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä, —Ç–∞–±—É–ª—è—Ü–∏—é –∏ –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–º–∞–Ω–¥–µ
    @ParameterizedTest 
    @ValueSource(strings = { "/about", "/ABOUT", "/About", "/aBoUt", "  /about  ", "/about\t", "   /ABOUT   " })
    void aboutWithTab(String commandName) {
        AboutCommand cmd = new AboutCommand();
        
        String result = cmd.realization(new String[]{commandName});
        assertNotNull(result);
        assertEquals("üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –≤ —É—á–µ–±–µ \r\n"
        		+ "\r\n"
        		+ "–Ø –±—É–¥—É:\r\n"
        		+ "‚Ä¢ üìÖ –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –ø–∞—Ä\r\n"
        		+ "‚Ä¢ üìö –ù–∞–ø–æ–º–∏–Ω–∞—Ç—å –æ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏—è—Ö  \r\n"
        		+ "‚Ä¢ ‚è∞ –ü—Ä–∏—Å—ã–ª–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ —É–¥–æ–±–Ω–æ–µ –≤—Ä–µ–º—è\r\n"
        		+ "‚Ä¢ üí´ –ü–æ–º–æ–≥–∞—Ç—å —É—á–∏—Ç—å—Å—è –±–µ–∑ –ª–∏—à–Ω–µ–≥–æ —Å—Ç—Ä–µ—Å—Å–∞\r\n"
        		+ "\r\n"
        		+ "–í–º–µ—Å—Ç–µ –º—ã —Å–¥–µ–ª–∞–µ–º —É—á–µ–±—É –ø—Ä–æ—â–µ! ‚ú®", result);
    }   
}
package bot.commands;

import bot.fsm.DialogState;
import bot.homework.HomeworkLinkStorage;
import bot.homework.SQLiteHomeworkStorage;
import bot.schedule.Lesson;
import bot.schedule.Schedule;
import bot.schedule.ScheduleManager;
import bot.user.User;
import bot.user.UserStorage;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;

import java.lang.reflect.Field;
import java.lang.reflect.Modifier;
import java.time.LocalDate;
import java.time.LocalTime;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class AddHomeworkCommandTest {

    private UserStorage mockUserStorage;
    private SQLiteHomeworkStorage mockStorage;
    private ScheduleManager mockScheduleManager;
    private HomeworkLinkStorage mockLinkStorage;
    private AddHomeworkCommand cmd;

    @BeforeEach
    public void setup() throws Exception {
        mockUserStorage = mock(UserStorage.class);
        mockStorage = mock(SQLiteHomeworkStorage.class);
        mockScheduleManager = mock(ScheduleManager.class);
        mockLinkStorage = mock(HomeworkLinkStorage.class);

        // –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç UserStorage
        cmd = new AddHomeworkCommand(mockUserStorage);

        // –ø–æ–¥–º–µ–Ω–∞ –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–æ–ª–µ–π: storage, scheduleManager, linkStorage
        Field fStorage = AddHomeworkCommand.class.getDeclaredField("storage");
        Field fSched = AddHomeworkCommand.class.getDeclaredField("scheduleManager");
        Field fLink = AddHomeworkCommand.class.getDeclaredField("linkStorage");

        fStorage.setAccessible(true);
        fSched.setAccessible(true);
        fLink.setAccessible(true);

        // –ø–æ–ø—ã—Ç–∞—Ç—å—Å—è —Å–Ω—è—Ç—å final
        try {
            Field modifiers = Field.class.getDeclaredField("modifiers");
            modifiers.setAccessible(true);
            modifiers.setInt(fStorage, fStorage.getModifiers() & ~Modifier.FINAL);
            modifiers.setInt(fSched, fSched.getModifiers() & ~Modifier.FINAL);
            modifiers.setInt(fLink, fLink.getModifiers() & ~Modifier.FINAL);
        } catch (NoSuchFieldException ignored) {}

        fStorage.set(cmd, mockStorage);
        fSched.set(cmd, mockScheduleManager);
        fLink.set(cmd, mockLinkStorage);
    }

    @Test
    public void start_userNotFound_returnsErrorMessage() {
        long chatId = 900L;
        when(mockUserStorage.getUser(chatId)).thenReturn(null);

        SendMessage resp = cmd.start(chatId);
        assertNotNull(resp);
        assertTrue(resp.getText().contains("‚ùå") && resp.getText().toLowerCase().contains("–ø—Ä–æ—Ñ–∏–ª—å"),
                "–û–∂–∏–¥–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–æ—Ñ–∏–ª—è: " + resp.getText());
        assertEquals(String.valueOf(chatId), resp.getChatId());
    }

    @Test
    public void start_withSchedule_offersSubjectButtons() {
        long chatId = 901L;
        User user = new User(chatId);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        Schedule schedule = new Schedule("g", "group");
        Lesson lesson = new Lesson("Math", LocalTime.of(9, 0), LocalTime.of(10, 30), "101");
        schedule.addLesson("MONDAY", lesson);

        SendMessage resp = cmd.start(chatId);
        assertNotNull(resp);
        assertTrue(resp.getText().toLowerCase().contains("—à–∞–≥ 1/4"));
    }

    @Test
    public void handleStateMessage_subjectNotFound_returnsError() {
        long chatId = 902L;
        User user = new User(chatId);
        user.setState(DialogState.ASK_HW_SUBJECT);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        // schedule —Å –¥—Ä—É–≥–∏–º –ø—Ä–µ–¥–º–µ—Ç–æ–º ‚Äî –∫–æ–º–∞–Ω–¥–∞ –¥–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
        Schedule schedule = new Schedule("g", "group");
        schedule.addLesson("MONDAY", new Lesson("Physics", LocalTime.of(9,0), LocalTime.of(10,0), ""));
        when(mockScheduleManager.getScheduleForUser(chatId)).thenReturn(schedule);


        SendMessage resp = cmd.handleStateMessage(chatId, "Math");
        assertNotNull(resp);
        assertTrue(resp.getText().toLowerCase().contains("–ø—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω"),
                "–û–∂–∏–¥–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ '–ø—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', –ø–æ–ª—É—á–∏–ª–∏: " + resp.getText());
    }

    /**
     * –ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –≤–≤–æ–¥ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ —á–∏—Å–ª–∞ –¥–ª—è remind-days.
     * –ü–æ–¥—Ö–æ–¥: –ø—Ä–æ—Ö–æ–¥–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏—è subject -> date -> description, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥–∞ —Å–∞–º–∞ —Å–æ–∑–¥–∞–ª–∞ Draft,
     * –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ remind.
     */
    @Test
    public void handleStateMessage_remindInvalidNumber_returnsError() {
        long chatId = 903L;
        User user = new User(chatId);
        // —Å—Ç–∞–≤–∏–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ‚Äî –∫–æ–º–∞–Ω–¥–∞ –Ω–∞—á–Ω—ë—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –≤–≤–æ–¥ –ø—Ä–µ–¥–º–µ—Ç–∞
        user.setState(DialogState.ASK_HW_SUBJECT);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        // 1) Subject (–∫–æ–º–∞–Ω–¥–∞ —Å–æ–∑–¥–∞—Å—Ç Draft –∏ –ø–µ—Ä–µ–≤–µ–¥—ë—Ç —é–∑–µ—Ä–∞ –≤ ASK_HW_DATE)
        SendMessage s1 = cmd.handleStateMessage(chatId, "Math");
        assertNotNull(s1);
        assertTrue(user.getState() == DialogState.ASK_HW_TIME || s1.getText().toLowerCase().contains("—à–∞–≥ 2"),
                "–û–∂–∏–¥–∞–ª–∏ —à–∞–≥ 2/4 –ø–æ—Å–ª–µ –ø—Ä–µ–¥–º–µ—Ç–∞");

        // 2) Date (–≤–≤–æ–¥–∏–º —è–≤–Ω—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ YYYY-MM-DD)
        String dateStr = LocalDate.now().plusDays(3).toString();
        SendMessage s2 = cmd.handleStateMessage(chatId, dateStr);
        assertNotNull(s2);
        assertTrue(user.getState() == DialogState.ASK_HW_DESCRIPTION || s2.getText().toLowerCase().contains("—à–∞–≥ 3"),
                "–û–∂–∏–¥–∞–ª–∏ —à–∞–≥ 3/4 –ø–æ—Å–ª–µ –¥–∞—Ç—ã");

        // 3) Description (–ø–µ—Ä–µ–≤–µ–¥—ë—Ç –≤ ASK_HW_REMIND)
        SendMessage s3 = cmd.handleStateMessage(chatId, "Desc");
        assertNotNull(s3);
        assertTrue(user.getState() == DialogState.ASK_HW_REMIND || s3.getText().toLowerCase().contains("—à–∞–≥ 4"),
                "–û–∂–∏–¥–∞–ª–∏ —à–∞–≥ 4/4 –ø–æ—Å–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è");

        // 4) –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π remind
        SendMessage resp = cmd.handleStateMessage(chatId, "-5");
        assertNotNull(resp);
        assertTrue(resp.getText().toLowerCase().contains("—Ü–µ–ª–æ–µ —á–∏—Å–ª–æ") || resp.getText().toLowerCase().contains("—É–∫–∞–∂–∏—Ç–µ"),
                "–û–∂–∏–¥–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞. –ü–æ–ª—É—á–µ–Ω–æ: " + resp.getText());
    }

    /**
     * –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π remind -> –≤—ã–∑–≤–∞—Ç—å storage.addHomework
     */
    @Test
    public void handleStateMessage_remindValid_callsStorageAndCompletes() {
        long chatId = 904L;
        User user = new User(chatId);
        user.setState(DialogState.ASK_HW_SUBJECT);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        // 1) Subject
        SendMessage s1 = cmd.handleStateMessage(chatId, "Math");
        assertNotNull(s1);

        // 2) Date
        String dateStr = LocalDate.now().plusDays(2).toString();
        SendMessage s2 = cmd.handleStateMessage(chatId, dateStr);
        assertNotNull(s2);

        // 3) Description
        SendMessage s3 = cmd.handleStateMessage(chatId, "Solve problems");
        assertNotNull(s3);

        // Prepare storage stub: addHomework –Ω–µ –≤—ã–±—Ä–æ—Å–∏—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–µ
        doNothing().when(mockStorage).addHomework(eq(chatId), anyString(), anyString(), any(LocalDate.class), anyInt());

        // 4) –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π remind
        SendMessage resp = cmd.handleStateMessage(chatId, "2");
        assertNotNull(resp);
        assertTrue(resp.getText().toLowerCase().contains("–¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ") && resp.getText().contains("‚úÖ"),
                "–û–∂–∏–¥–∞–ª–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è. –ü–æ–ª—É—á–µ–Ω–æ: " + resp.getText());

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ storage.addHomework –≤—ã–∑–≤–∞–Ω–æ
        verify(mockStorage, times(1)).addHomework(eq(chatId), eq("Math"), eq("Solve problems"), any(LocalDate.class), eq(2));
    }
}
package bot.commands;

import org.junit.jupiter.api.Test;
import static org.junit.jupiter.api.Assertions.*;
import org.junit.jupiter.params.ParameterizedTest;  // –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
import org.junit.jupiter.params.provider.ValueSource; // –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –º–∞—Å—Å–∏–≤ –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è —Ç–µ—Å—Ç–∞

public class AuthorsCommandTest {

    @Test
    void authorsBasics() {
        AuthorsCommand cmd = new AuthorsCommand();

        assertEquals("/authors", cmd.getName(), "–ò–º—è –∫–æ–º–∞–Ω–¥—ã –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å /authors");

        String info = cmd.getInformation();
        assertNotNull(info, "getInformation() –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å null");
        assertEquals("–†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –±–æ—Ç–∞", info);

        String result = cmd.realization(new String[]{"/authors"});
        assertNotNull(result, "realization –Ω–µ –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å null");
        assertEquals("üëã –ü—Ä–∏–≤–µ—Ç! –ú—ã - –í–∏–∫—Ç–æ—Ä–∏—è –ù–µ—Å—Ç–µ—Ä–æ–≤–∞ –∏ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –í–æ—Ä–æ–±—å—ë–≤\n\n"
        		+ "üìñ –°—Ç—É–¥–µ–Ω—Ç—ã –≥—Ä—É–ø–ø—ã –ú–ï–ù-241001 (–ö–ë-202)\r\n"
        		+ "\r\n"
        		+ "–°–æ–∑–¥–∞–ª–∏ —ç—Ç–æ–≥–æ –±–æ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–∞–∫–∏–º –∂–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º, –∫–∞–∫ –º—ã! ‚ù§Ô∏è", result);
    }
    
    
    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ª–∏—â–Ω–∏–µ —Å–ª–æ–≤–∞ –ø–æ—Å–ª–µ –∫–æ–º–∞–Ω–¥—ã
    void authorsWithExtraWord() {
        AuthorsCommand cmd = new AuthorsCommand();
        
        String result = cmd.realization(new String[]{"/authors", "extra", "word"});
        assertNotNull(result);
        assertEquals("üëã –ü—Ä–∏–≤–µ—Ç! –ú—ã - –í–∏–∫—Ç–æ—Ä–∏—è –ù–µ—Å—Ç–µ—Ä–æ–≤–∞ –∏ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –í–æ—Ä–æ–±—å—ë–≤\n\n"
        		+ "üìñ –°—Ç—É–¥–µ–Ω—Ç—ã –≥—Ä—É–ø–ø—ã –ú–ï–ù-241001 (–ö–ë-202)\r\n"
        		+ "\r\n"
        		+ "–°–æ–∑–¥–∞–ª–∏ —ç—Ç–æ–≥–æ –±–æ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–∞–∫–∏–º –∂–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º, –∫–∞–∫ –º—ã! ‚ù§Ô∏è", result);
    }
    
    
    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä, —Ç–∞–±—É–ª—è—Ü–∏—é –∏ –ø—Ä–æ–±–µ–ª—ã –≤ –∫–æ–º–∞–Ω–¥–µ
    @ParameterizedTest 
    @ValueSource(strings = { "/authors", "/AUTHORS", "/Authors", "/aUtHoRs", "  /authors  ", "/authors\t", "   /AUTHORS   " })
    void authorsWithTab(String commandName) {
        AuthorsCommand cmd = new AuthorsCommand();
        
        String result = cmd.realization(new String[]{commandName});
        assertNotNull(result);
        assertEquals("üëã –ü—Ä–∏–≤–µ—Ç! –ú—ã - –í–∏–∫—Ç–æ—Ä–∏—è –ù–µ—Å—Ç–µ—Ä–æ–≤–∞ –∏ –ê–ª–µ–∫—Å–∞–Ω–¥—Ä –í–æ—Ä–æ–±—å—ë–≤\n\n"
        		+ "üìñ –°—Ç—É–¥–µ–Ω—Ç—ã –≥—Ä—É–ø–ø—ã –ú–ï–ù-241001 (–ö–ë-202)\r\n"
        		+ "\r\n"
        		+ "–°–æ–∑–¥–∞–ª–∏ —ç—Ç–æ–≥–æ –±–æ—Ç–∞, —á—Ç–æ–±—ã –ø–æ–º–æ—á—å —Ç–∞–∫–∏–º –∂–µ —Å—Ç—É–¥–µ–Ω—Ç–∞–º, –∫–∞–∫ –º—ã! ‚ù§Ô∏è", result);
    }      
}

package bot.commands;

import bot.scheduler.DailyNotifier;
import bot.homework.SQLiteHomeworkStorage;
import bot.schedule.Lesson;
import bot.schedule.Schedule;
import bot.schedule.ScheduleManager;
import bot.start.Homeworkbot;
import bot.user.SQLiteUserStorage;
import bot.user.User;
import org.junit.jupiter.api.Test;
import org.telegram.telegrambots.meta.api.methods.send.SendMessage;

import java.lang.reflect.Field;
import java.lang.reflect.InvocationHandler;
import java.lang.reflect.Proxy;
import java.time.LocalDate;
import java.time.LocalTime;
import java.time.ZoneId;
import java.util.*;
import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicLong;
import java.util.concurrent.atomic.AtomicReference;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class DailyNotifierTest {

    // ----------------------------------------------
    // –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –¥–ª—è TimeSource-–ª–æ–≥–∏–∫–∏
    // ----------------------------------------------

    public interface TimeSource {
        long milliseconds();
        long nanoseconds();
        void sleep(long millis) throws InterruptedException;
    }

    private static class ScheduledTask {
        final Runnable r;
        final long scheduledAtMs;
        volatile boolean executed = false;

        ScheduledTask(Runnable r, long scheduledAtMs) {
            this.r = r;
            this.scheduledAtMs = scheduledAtMs;
        }
    }

    private static class TestTimeSourceImpl implements TimeSource {
        private final AtomicLong now;
        private final List<ScheduledTask> shared;

        TestTimeSourceImpl(long startMs, List<ScheduledTask> shared) {
            this.now = new AtomicLong(startMs);
            this.shared = shared;
        }

        @Override public long milliseconds() { return now.get(); }
        @Override public long nanoseconds() { return now.get() * 1_000_000L; }

        @Override
        public void sleep(long millis) {
            long newTime = now.addAndGet(millis);

            synchronized (shared) {
                for (ScheduledTask t : shared) {
                    if (!t.executed && t.scheduledAtMs <= newTime) {
                        try { t.r.run(); } catch (Throwable ignored) {}
                        t.executed = true;
                    }
                }
            }
        }
    }

    private static class TestScheduledExecutor implements ScheduledExecutorService {
        private final List<ScheduledTask> shared;
        private final TimeSource ts;

        TestScheduledExecutor(List<ScheduledTask> shared, TimeSource ts) {
            this.shared = shared;
            this.ts = ts;
        }

        @Override
        public ScheduledFuture<?> schedule(Runnable command, long delay, TimeUnit unit) {
            long at = ts.milliseconds() + unit.toMillis(delay);
            shared.add(new ScheduledTask(command, at));
            return mock(ScheduledFuture.class);
        }

        // –ó–∞–≥–ª—É—à–∫–∏
        @Override public <V> ScheduledFuture<V> schedule(Callable<V> c, long d, TimeUnit u) { throw new UnsupportedOperationException(); }
        @Override public ScheduledFuture<?> scheduleAtFixedRate(Runnable r, long i, long p, TimeUnit u) { throw new UnsupportedOperationException(); }
        @Override public ScheduledFuture<?> scheduleWithFixedDelay(Runnable r, long i, long d, TimeUnit u) { throw new UnsupportedOperationException(); }
        @Override public void shutdown() {}
        @Override public List<Runnable> shutdownNow() { return Collections.emptyList(); }
        @Override public boolean isShutdown() { return false; }
        @Override public boolean isTerminated() { return false; }
        @Override public boolean awaitTermination(long timeout, TimeUnit u) { return true; }
        @Override public <T> Future<T> submit(Callable<T> task) { throw new UnsupportedOperationException(); }
        @Override public <T> Future<T> submit(Runnable task, T result) { throw new UnsupportedOperationException(); }
        @Override public Future<?> submit(Runnable task) { throw new UnsupportedOperationException(); }
        @Override public <T> List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks) { throw new UnsupportedOperationException(); }
        @Override public <T> List<Future<T>> invokeAll(Collection<? extends Callable<T>> tasks, long timeout, TimeUnit unit) { throw new UnsupportedOperationException(); }
        @Override public <T> T invokeAny(Collection<? extends Callable<T>> tasks) { throw new UnsupportedOperationException(); }
        @Override public <T> T invokeAny(Collection<? extends Callable<T>> tasks, long timeout, TimeUnit unit) { throw new UnsupportedOperationException(); }
        @Override public void execute(Runnable command) { command.run(); }
    }

    // ----------------------------------------------
    // –£—Ç–∏–ª–∏—Ç—ã
    // ----------------------------------------------

    private static boolean setFieldIfPresent(Object target, String fieldName, Object value) {
        try {
            Field f = target.getClass().getDeclaredField(fieldName);
            f.setAccessible(true);
            f.set(target, value);
            return true;
        } catch (Exception ignored) {
            return false;
        }
    }

    private static Field findTimeSourceField(Object target) {
        for (Field f : target.getClass().getDeclaredFields()) {
            Class<?> t = f.getType();
            if (!t.isInterface()) continue;

            try {
                t.getMethod("milliseconds");
                t.getMethod("sleep", long.class);
                return f;
            } catch (Exception ignored) {}
        }
        return null;
    }

    // ----------------------------------------------
    // –°–∞–º —Ç–µ—Å—Ç
    // ----------------------------------------------

    @Test
    public void notifier_executes_with_or_without_TimeSource() throws Exception {

        Homeworkbot mockBot = mock(Homeworkbot.class);
        SQLiteUserStorage mockUserStorage = mock(SQLiteUserStorage.class);
        SQLiteHomeworkStorage mockHw = mock(SQLiteHomeworkStorage.class);
        ScheduleManager mockScheduleManager = mock(ScheduleManager.class);

        DailyNotifier notifier = new DailyNotifier(mockBot, mockUserStorage, mockHw);

        setFieldIfPresent(notifier, "scheduleManager", mockScheduleManager);

        // –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ
        User u = new User(555L);
        when(mockUserStorage.getRegisteredUsers()).thenReturn(List.of(u));

        ZoneId zone = ZoneId.systemDefault();
        LocalDate today = LocalDate.now(zone);

        LocalTime lastEnd = LocalTime.now(zone).plusMinutes(1);
        Lesson lesson = new Lesson("S", LocalTime.of(1,0), lastEnd, "A");
        Schedule schedule = new Schedule("g", "group");
        schedule.addLesson(today.getDayOfWeek().name(), lesson);

        when(mockScheduleManager.getScheduleForUser(u.getChatId())).thenReturn(schedule);

        // --- –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ timeSource ---
        Field tsField = findTimeSourceField(notifier);

        if (tsField != null) {
            // ---------------------- —Ä–µ–∂–∏–º TIME SOURCE ------------------------

            List<ScheduledTask> shared = Collections.synchronizedList(new ArrayList<>());
            TestTimeSourceImpl ts = new TestTimeSourceImpl(System.currentTimeMillis(), shared);

            tsField.setAccessible(true);

            // –µ—Å–ª–∏ —Ç–∏–ø —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —Å—Ç–∞–≤–∏–º –Ω–∞–ø—Ä—è–º—É—é
            if (tsField.getType().isAssignableFrom(TestTimeSourceImpl.class)) {
                tsField.set(notifier, ts);
            } else {
                // –∏–Ω–∞—á–µ —Å–æ–∑–¥–∞—ë–º proxy –ø–æ–¥ —Ç–∏–ø –ø–æ–ª—è
                Class<?> iface = tsField.getType();
                InvocationHandler handler = (proxy, method, args) -> {
                    switch (method.getName()) {
                        case "milliseconds": return ts.milliseconds();
                        case "nanoseconds": return ts.nanoseconds();
                        case "sleep": ts.sleep((Long) args[0]); return null;
                    }
                    return null;
                };
                Object proxy = Proxy.newProxyInstance(iface.getClassLoader(), new Class[]{iface}, handler);
                tsField.set(notifier, proxy);
            }

            TestScheduledExecutor executor = new TestScheduledExecutor(shared, ts);
            setFieldIfPresent(notifier, "scheduler", executor);

            notifier.startAll();

            assertFalse(shared.isEmpty(), "–û–∂–∏–¥–∞–ª–∏, —á—Ç–æ –∑–∞–¥–∞—á–∞ –±—É–¥–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞");

            ScheduledTask task = shared.get(0);
            long now = ts.milliseconds();
            long scheduledAt = task.scheduledAtMs;

            long delta = scheduledAt - now + 50;
            ts.sleep(delta);

            assertTrue(task.executed, "–ó–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç—å—Å—è –ø–æ—Å–ª–µ –ø–µ—Ä–µ–º–æ—Ç–∫–∏ –≤—Ä–µ–º–µ–Ω–∏");

            verify(mockHw, atLeastOnce()).deleteOldHomework(any(LocalDate.class));
            verify(mockBot, atLeastOnce()).execute(any(SendMessage.class));

        } else {
            // ---------------------- FALLBACK —Ä–µ–∂–∏–º ---------------------------

            ScheduledExecutorService mockScheduler = mock(ScheduledExecutorService.class);

            AtomicReference<Runnable> captured = new AtomicReference<>();

            when(mockScheduler.schedule(any(Runnable.class), anyLong(), any(TimeUnit.class)))
                    .thenAnswer(inv -> {
                        captured.set(inv.getArgument(0));
                        return mock(ScheduledFuture.class);
                    });

            setFieldIfPresent(notifier, "scheduler", mockScheduler);

            notifier.startAll();

            assertNotNull(captured.get(), "–ó–∞–¥–∞—á–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞");

            captured.get().run();

            verify(mockHw, atLeastOnce()).deleteOldHomework(any(LocalDate.class));
            verify(mockBot, atLeastOnce()).execute(any(SendMessage.class));
        }
    }
}
package bot.commands;

import bot.homework.HomeworkItem;
import bot.homework.HomeworkLinkStorage;
import bot.homework.SQLiteHomeworkStorage;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.lang.reflect.Field;
import java.lang.reflect.Modifier;
import java.time.LocalDate;
import java.util.Collections;
import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class DeleteHomeworkCommandTest {

    private SQLiteHomeworkStorage mockStorage;
    private HomeworkLinkStorage mockLink;
    private DeleteHomeworkCommand cmd;

    @BeforeEach
    public void setup() throws Exception {
        mockStorage = mock(SQLiteHomeworkStorage.class);
        mockLink = mock(HomeworkLinkStorage.class);

        cmd = new DeleteHomeworkCommand();

        // –ø–æ–¥–º–µ–Ω—è–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –ø–æ–ª—è
        Field fStorage = DeleteHomeworkCommand.class.getDeclaredField("storage");
        Field fLink = DeleteHomeworkCommand.class.getDeclaredField("linkStorage");
        fStorage.setAccessible(true);
        fLink.setAccessible(true);

        try {
            Field modifiers = Field.class.getDeclaredField("modifiers");
            modifiers.setAccessible(true);
            modifiers.setInt(fStorage, fStorage.getModifiers() & ~Modifier.FINAL);
            modifiers.setInt(fLink, fLink.getModifiers() & ~Modifier.FINAL);
        } catch (NoSuchFieldException ignored) {}

        fStorage.set(cmd, mockStorage);
        fLink.set(cmd, mockLink);
    }

    @Test
    public void realizationWithChatId_noArgs_noHomework_showsEmptyMessage() {
        long chatId = 1200L;
        when(mockStorage.getHomeworkByUser(chatId)).thenReturn(Collections.emptyList());

        String out = cmd.realizationWithChatId(chatId, new String[]{"/deletehw"});
        assertNotNull(out);
        assertTrue(out.toLowerCase().contains("–Ω–µ—Ç –¥–æ–º–∞—à–Ω–µ–≥–æ –∑–∞–¥–∞–Ω–∏—è"));
    }

    @Test
    public void realizationWithChatId_invalidIdFormat_returnsError() {
        long chatId = 1201L;
        when(mockStorage.getHomeworkByUser(chatId)).thenReturn(Collections.emptyList());

        String out = cmd.realizationWithChatId(chatId, new String[]{"/deletehw", "abc"});
        assertNotNull(out);
        assertTrue(out.contains("‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π ID"));
    }

    @Test
    public void realizationWithChatId_idNotFound_returnsNotFoundMessage() {
        long chatId = 1202L;
        HomeworkItem existing = new HomeworkItem(10, chatId, "Math", "D", LocalDate.now(), false, 1);
        when(mockStorage.getHomeworkByUser(chatId)).thenReturn(List.of(existing));

        String out = cmd.realizationWithChatId(chatId, new String[]{"/deletehw", "99"});
        assertNotNull(out);
        assertTrue(out.contains("‚ùå –ó–∞–¥–∞–Ω–∏–µ —Å —Ç–∞–∫–∏–º ID –Ω–µ –Ω–∞–π–¥–µ–Ω–æ —É –≤–∞—Å"));
    }

    @Test
    public void realizationWithChatId_deleteExisting_callsStorageAndLink() {
        long chatId = 1203L;
        HomeworkItem existing = new HomeworkItem(55, chatId, "Math", "D", LocalDate.now(), false, 1);
        when(mockStorage.getHomeworkByUser(chatId)).thenReturn(List.of(existing));

        String out = cmd.realizationWithChatId(chatId, new String[]{"/deletehw", "55"});
        assertNotNull(out);
        assertTrue(out.contains("‚úÖ –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ —Å ID 55 —É–¥–∞–ª–µ–Ω–æ.") || out.toLowerCase().contains("—É–¥–∞–ª–µ–Ω–æ"));

        // verify unlink and delete calls
        verify(mockLink, times(1)).unlinkHomework(55);
        verify(mockStorage, times(1)).deleteHomework(55);
    }
}
package bot.commands;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.params.ParameterizedTest;
import org.junit.jupiter.params.provider.ValueSource;
import static org.junit.jupiter.api.Assertions.*;

import java.util.HashMap;
import java.util.Map;

public class HelpCommandTest {

    private Map<String, Command> getTestCommands() {
        Map<String, Command> commands = new HashMap<>();
        commands.put("/about", new AboutCommand());
        commands.put("/authors", new AuthorsCommand());
        commands.put("/help", new HelpCommand(commands)); // —Å–∞–º —Å–µ–±—è
        return commands;
    }

    @Test
    void helpListsAllCommands() {
        HelpCommand helpCmd = new HelpCommand(getTestCommands());
        String result = helpCmd.realization(new String[]{"/help"});
        assertNotNull(result);
        assertTrue(result.contains("/about"));
        assertTrue(result.contains("/authors"));
        assertTrue(result.contains("/help"));
    }

    @Test
    void helpInfoForAbout() {
        HelpCommand helpCmd = new HelpCommand(getTestCommands());
        String result = helpCmd.realization(new String[]{"/help", "/about"});
        assertEquals("/about ‚Äî –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞", result);
    }
    
    @Test
    void helpInfoForAuthors() {
        HelpCommand helpCmd = new HelpCommand(getTestCommands());
        String result = helpCmd.realization(new String[]{"/help", "/authors"});
        assertEquals("/authors ‚Äî –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –±–æ—Ç–∞", result);
    }

    @Test
    void helpunknownCommand() {
        HelpCommand helpCmd = new HelpCommand(getTestCommands());
        String result = helpCmd.realization(new String[]{"/help", "/unknown"});
        assertEquals("–ö–æ–º–∞–Ω–¥–∞ /unknown –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", result);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞–ø–∏—Å–∞–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã (—Ä–µ–≥–∏—Å—Ç—Ä, –ø—Ä–æ–±–µ–ª—ã, —Ç–∞–±—É–ª—è—Ü–∏—è)
    @ParameterizedTest
    @ValueSource(strings = { "/help", "/HELP", "/Help", "/hElP", "   /help   ", "/help\t", "   /HELP   " })
    void helpWithTab(String inputCommand) {
        HelpCommand helpCmd = new HelpCommand(getTestCommands());
        String result = helpCmd.realization(new String[]{inputCommand});
        assertNotNull(result);
        assertTrue(result.contains("/about"));
        assertTrue(result.contains("/authors"));
        assertTrue(result.contains("/help"));
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã–¥–∞—á–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–º–∞–Ω–¥–µ —Å –ª–∏—à–Ω–∏–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏ –∏ —Ä–∞–∑–Ω—ã–º —Ä–µ–≥–∏—Å—Ç—Ä–æ–º
    @ParameterizedTest
    @ValueSource(strings = { "/about", "/ABOUT", "   /about   ", "/about\t", "/aBoUt" })
    void helpWithTabAbout(String commandName) {
        HelpCommand helpCmd = new HelpCommand(getTestCommands());
        String result = helpCmd.realization(new String[]{"/help", commandName});
        assertNotNull(result);
        assertTrue(result.startsWith("/about"));
        assertTrue(result.contains("–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞"));
    }
    
    @ParameterizedTest
    @ValueSource(strings = { "/authors", "/AUTHORS", "   /authors   ", "/authors\t", "/aUtHoRs" })
    void helpWithTabAuthors(String commandName) {
        HelpCommand helpCmd = new HelpCommand(getTestCommands());
        String result = helpCmd.realization(new String[]{"/help", commandName});
        assertNotNull(result);
        assertTrue(result.startsWith("/authors"));
        assertTrue(result.contains("–†–∞—Å—Å–∫–∞–∑—ã–≤–∞–µ—Ç –æ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö –±–æ—Ç–∞"));
    }
}package bot.commands;

import bot.homework.HomeworkItem;
import bot.homework.SQLiteHomeworkStorage;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.lang.reflect.Field;
import java.lang.reflect.Modifier;
import java.time.LocalDate;
import java.util.Collections;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class MarkHomeworkCommandTest {

    private SQLiteHomeworkStorage mockStorage;
    private MarkHomeworkCommand markCmd;
    private MarkHomeworkCommand unmarkCmd;

    @BeforeEach
    public void setup() throws Exception { // —Å–æ–∑–¥–∞—ë–º –º–æ–∫ –∏ –∫–æ–º–∞–Ω–¥—ã –∏ –ø–æ–¥–º–µ–Ω—è–µ–º storage
        mockStorage = mock(SQLiteHomeworkStorage.class);
        markCmd = new MarkHomeworkCommand(true);
        unmarkCmd = new MarkHomeworkCommand(false);

        Field f1 = MarkHomeworkCommand.class.getDeclaredField("storage"); // –ø–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ –ø–æ–ª–µ storage
        f1.setAccessible(true); // –ø–æ–∑–≤–æ–ª—è–µ–º –º–µ–Ω—è—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ –ø–æ–ª–µ
        try { // –±–ª–æ–∫ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã –æ–±–º–∞–Ω—É—Ç—å jvm (—Å–∫–∞–∑–∞—Ç—å, —á—Ç–æ –ø–æ–ª–µ –±–æ–ª—å—à–µ –Ω–µ final)
            Field modifiersField = Field.class.getDeclaredField("modifiers"); // –ø–æ–ª—É—á–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ –ø–æ–ª–µ modifiers
            modifiersField.setAccessible(true);
            modifiersField.setInt(f1, f1.getModifiers() & ~Modifier.FINAL);
        } catch (NoSuchFieldException ignored) {
        }
        f1.set(markCmd, mockStorage); // –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –º–æ–∫–Ω—É—Ç—ã–π storage
        f1.set(unmarkCmd, mockStorage); // –∑–∞–º–µ–Ω—è–µ–º –Ω–∞ –º–æ–∫–Ω—É—Ç—ã–π storage
    }

    @Test
    public void realizationWithChatId_invalidArg_showsUsage() {
        String result = markCmd.realizationWithChatId(400L, new String[]{"/markhw"});
        assertTrue(result.toLowerCase().contains("–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"));
    }

    @Test
    public void realizationWithChatId_nonNumericId_showsError() {
        String r = markCmd.realizationWithChatId(400L, new String[]{"/markhw", "abc"});
        assertTrue(r.toLowerCase().contains("–Ω–µ–≤–µ—Ä–Ω—ã–π id"));
    }

    @Test
    public void realizationWithChatId_markExisting_callsStorage() {
        long chatId = 401L;
        HomeworkItem it = new HomeworkItem(77, chatId, "X", "Y", LocalDate.now(), false, 1);
        when(mockStorage.getHomeworkByUser(chatId)).thenReturn(Collections.singletonList(it));

        String r = markCmd.realizationWithChatId(chatId, new String[]{"/markhw", "77"});
        assertNotNull(r);
        assertTrue(r.toLowerCase().contains("‚úÖ –∑–∞–¥–∞–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ."));
        verify(mockStorage, times(1)).markAsCompleted(77, true);
    }

    @Test
    public void realizationWithChatId_unmarkExisting_callsStorage() {
        long chatId = 402L;
        HomeworkItem it = new HomeworkItem(88, chatId, "X", "Y", LocalDate.now(), true, 1);
        when(mockStorage.getHomeworkByUser(chatId)).thenReturn(Collections.singletonList(it));

        String r = unmarkCmd.realizationWithChatId(chatId, new String[]{"/unmarkhw", "88"});
        assertNotNull(r);
        assertTrue(r.toLowerCase().contains("‚úÖ –ø–æ–º–µ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–Ω—è—Ç–∞."));
        verify(mockStorage, times(1)).markAsCompleted(88, false);
    }
}
package bot.commands;

import bot.homework.HomeworkItem;
import bot.homework.SQLiteHomeworkStorage;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import java.lang.reflect.Field;
import java.lang.reflect.Modifier;
import java.time.LocalDate;
import java.util.Arrays;
import java.util.Collections;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class PrintHomeworkCommandTest {

    private SQLiteHomeworkStorage mockStorage;
    private PrintHomeworkCommand cmd;

    @BeforeEach
    public void setup() throws Exception { // –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Å –º–∞—Ä–∫ –∫–æ–º–∞–Ω–¥ –¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ –ø–æ–ª–µ –ø–æ–¥–º–µ–Ω–∏–ª–æ—Å—å
        mockStorage = mock(SQLiteHomeworkStorage.class);
        cmd = new PrintHomeworkCommand();

        Field f = PrintHomeworkCommand.class.getDeclaredField("storage");
        f.setAccessible(true);

        try {
            Field modifiersField = Field.class.getDeclaredField("modifiers");
            modifiersField.setAccessible(true);
            modifiersField.setInt(f, f.getModifiers() & ~Modifier.FINAL);
        } catch (NoSuchFieldException ignored) {
        }

        f.set(cmd, mockStorage);
    }

    @Test
    public void realizationWithChatId_noArgs_returnsAll() { // –±–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
        long chatId = 300L;
        HomeworkItem a = new HomeworkItem(1, chatId, "Math", "Desc", LocalDate.of(2025,11,20), false, 1);
        HomeworkItem b = new HomeworkItem(2, chatId, "Phys", "Desc2", LocalDate.of(2025,11,21), true, 1);
        when(mockStorage.getHomeworkByUser(chatId)).thenReturn(Arrays.asList(a,b));

        String out = cmd.realizationWithChatId(chatId, new String[]{"/homework"});
        assertNotNull(out);
        assertTrue(out.toLowerCase().contains("–≤—Å–µ –¥–æ–º–∞—à–Ω–∏–µ") && out.contains("ID: 1") && out.contains("ID: 2"));
    }

    @Test
    public void realizationWithChatId_filterByDay_returnsFiltered() { // –Ω–∞ –¥–µ–Ω—å
        long chatId = 301L;
        HomeworkItem a = new HomeworkItem(1, chatId, "Math", "Desc", LocalDate.of(2025,11,24), false, 1);
        when(mockStorage.getHomeworkByUser(chatId)).thenReturn(Arrays.asList(a));

        String out = cmd.realizationWithChatId(chatId, new String[]{"/homework", "MONDAY"});
        assertNotNull(out);
        assertTrue(out.toLowerCase().contains("–¥–∑") || out.contains("ID: 1"));
    }

    @Test
    public void realizationWithChatId_filterBySubject_usesStorageMethod() { // —á–µ—Ä–µ–∑ –ø—Ä–µ–¥–º–µ—Ç
        long chatId = 302L;
        HomeworkItem a = new HomeworkItem(10, chatId, "Chemistry", "Lab", LocalDate.of(2025,12,1), false, 1);
        when(mockStorage.getHomeworkBySubject(chatId, "Chemistry")).thenReturn(Collections.singletonList(a));

        String out = cmd.realizationWithChatId(chatId, new String[]{"/homework", "Chemistry"});
        assertNotNull(out);
        assertTrue(out.toLowerCase().contains("–¥–∑ –ø–æ –ø—Ä–µ–¥–º–µ—Ç—É") || out.contains("Chemistry"));
    }
}
package bot.commands;

import bot.schedule.*;
import bot.user.User;
import bot.user.UserStorage;
import org.junit.jupiter.api.*;
import org.mockito.Mockito;
import bot.user.exception.ScheduleStorageException;

import java.io.File;
import java.lang.reflect.Field;
import java.time.LocalTime;
import java.util.List;
import java.util.Map;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class ScheduleCommandTest {

    private UserStorage userStorage;
    private final long CHAT_ID = 99999L;

    @BeforeEach
    public void setUp() {
        userStorage = mock(UserStorage.class);
    }

    @Test
    public void testScheduleFetcher_serializationDeserialization_parsesJsonToSchedule() throws Exception {
        // –¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç: –ø—Ä–∏ –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–µ JSON (mock –∫–ª–∏–µ–Ω—Ç–∞) ScheduleFetcher –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç –¥–∞–Ω–Ω—ã–µ –≤ Java-–æ–±—ä–µ–∫—Ç—ã

        ScheduleFetcher fetcher = new ScheduleFetcher();
        // —Å–æ–∑–¥–∞—ë–º —Ä–µ–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä fetcher ‚Äî –Ω–æ –ø–æ–¥–º–µ–Ω–∏–º —É –Ω–µ–≥–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π HTTP-–∫–ª–∏–µ–Ω—Ç

        UrfuApiClient mockClient = mock(UrfuApiClient.class);
        // –º–æ–∫, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–¥–∞–≤–∞—Ç—å –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–µ JSON-—Å—Ç—Ä–æ–∫–∏

        String divisionsJson = "[{\"id\":1,\"title\":\"–ò–Ω—Å—Ç–∏—Ç—É—Ç —Ç–µ—Å—Ç–æ–≤—ã–π\"},{\"id\":2,\"title\":\"–ò–ï–ù–∏–ú\"}]";
        String groupsJson = "[{\"id\":100,\"title\":\"–ú–ï–ù-241001\"}]";
        String scheduleJson = "[" +
                "{\"date\":\"2025-11-03\",\"timeBegin\":\"09:00\",\"timeEnd\":\"10:30\",\"title\":\"–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞\",\"auditoryTitle\":\"101\"}" +
                "]";

        // –ú–æ–∫–∞–µ–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ HTTP-–∫–ª–∏–µ–Ω—Ç–∞: –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –Ω–∞ divisions -> –≤–æ–∑–≤—Ä–∞—â–∞–µ–º divisionsJson
        when(mockClient.get("https://urfu.ru/api/v2/schedule/divisions")).thenReturn(divisionsJson);
        // –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö –¥–ª—è –≥—Ä—É–ø–ø –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω—Å—Ç–∏—Ç—É—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, divisions/2/groups?course=2) -> –≤–æ–∑–≤—Ä–∞—â–∞–µ–º groupsJson
        when(mockClient.get("https://urfu.ru/api/v2/schedule/divisions/2/groups?course=2")).thenReturn(groupsJson);
        // –∞ –ø—Ä–∏ –ª—é–±–æ–º –∑–∞–ø—Ä–æ—Å–µ, –Ω–∞—á–∏–Ω–∞—é—â–µ–º—Å—è —Å https://urfu.ru/api/v2/schedule/groups/ –≤–µ—Ä–Ω—ë–º scheduleJson
        when(mockClient.get(startsWith("https://urfu.ru/api/v2/schedule/groups/"))).thenReturn(scheduleJson);

        // –ü–æ–¥–º–µ–Ω–∞ –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ –ø–æ–ª—è httpClient –≤ fetcher —á–µ—Ä–µ–∑ reflection (ScheduleFetcher —Å–æ–∑–¥–∞—ë—Ç –µ–≥–æ –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ)
        Field clientField = ScheduleFetcher.class.getDeclaredField("httpClient"); //–¥–æ—Å—Ç–∞—ë–º –ø—Ä–∏–≤–∞—Ç–Ω–æ–µ –ø–æ–ª–µ
        clientField.setAccessible(true); // —Ä–∞–∑—Ä–µ—à–∞–µ–º –ø–æ–¥–º–µ–Ω—É
        clientField.set(fetcher, mockClient); // –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ø–æ–¥–º–µ–Ω–∞

        User user = new User(1L, "Test", "–ú–ï–ù-241001", "–ò–ï–ù–∏–ú", "", "2", bot.fsm.DialogState.REGISTERED);

        Schedule schedule = fetcher.fetchForUser(user);
        // –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ ‚Äî –æ–Ω –¥–æ–ª–∂–µ–Ω –≤—ã–ø–æ–ª–Ω–∏—Ç—å "HTTP" –∑–∞–ø—Ä–æ—Å—ã (—á–µ—Ä–µ–∑ mock) –∏ —Å–æ–±—Ä–∞—Ç—å Schedule

        assertNotNull(schedule);

        assertEquals("–ú–ï–ù-241001", schedule.getGroupName());

        Map<String, List<Lesson>> weekly = schedule.getWeeklySchedule();
        assertTrue(weekly.containsKey("MONDAY") || weekly.size() > 0);
        // —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–µ–Ω—å

        // –ò—â–µ–º –≤ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏ —É—Ä–æ–∫ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞" –∏ –≤—Ä–µ–º–µ–Ω–µ–º –Ω–∞—á–∞–ª–∞ 09:00
        boolean found = weekly.values().stream()
                .flatMap(List::stream)
                .anyMatch(l -> "–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞".equals(l.getSubject()) && LocalTime.parse("09:00").equals(l.getStartTime()));

        assertTrue(found, "–ù–µ –Ω–∞–π–¥–µ–Ω–∞ –æ–∂–∏–¥–∞–µ–º–∞—è –ø–∞—Ä–∞ '–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞' 09:00");
    }

    @Test
    public void testScheduleCommand_realizationWithChatId_readsFromSqliteAndFormatsOutput() throws Exception {
        // –ù–æ–≤—ã–π, –Ω–∞–¥—ë–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø—Ä—è–º–æ —Å–æ–∑–¥–∞—ë–º schedules.db (–±–µ–∑ –Ω–µ–Ω–∞–¥—ë–∂–Ω–æ–≥–æ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è).
        String dbName = "schedules.db";
        File dbFile = new File(dbName);
        if (dbFile.exists()) {
            // –ø—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–π—Å—è –æ—Ç –ø—Ä–æ—à–ª—ã—Ö —Ç–µ—Å—Ç–æ–≤ —Ñ–∞–π–ª
            dbFile.delete();
        }

        // –°–æ–∑–¥–∞—ë–º –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏–º–µ–Ω–Ω–æ —Ç–æ—Ç —Ñ–∞–π–ª, –∫–æ—Ç–æ—Ä—ã–π –æ–∂–∏–¥–∞–µ—Ç ScheduleManager/ScheduleCommand
        SQLiteScheduleStorage storage = new SQLiteScheduleStorage(dbName);
        storage.initialize();

        Schedule schedule = new Schedule("g-42", "–ú–ï–ù-241001");
        Lesson lesson = new Lesson("–§–∏–∑–∏–∫–∞", java.time.LocalTime.of(10, 0),
                java.time.LocalTime.of(11, 30), "301");
        schedule.addLesson("MONDAY", lesson);

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ; –µ—Å–ª–∏ –æ–Ω–æ —É–∂–µ –µ—Å—Ç—å ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —ç—Ç–æ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (—á—Ç–æ–±—ã —Ç–µ—Å—Ç—ã –±—ã–ª–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º–∏)
        try {
            storage.saveSchedule(schedule);
        } catch (ScheduleStorageException e) {
            if (!e.getMessage().contains("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è —ç—Ç–æ–π –≥—Ä—É–ø–ø—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç")) {
                storage.close();
                throw e;
            }
            // else ‚Äî —É–∂–µ –µ—Å—Ç—å, –º–æ–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å
        } finally {
            // –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º storage (—á—Ç–æ–±—ã –Ω–µ –¥–µ—Ä–∂–∞—Ç—å —Ñ–∞–π–ª –æ—Ç–∫—Ä—ã—Ç—ã–º)
            storage.close();
        }

        User user = new User(CHAT_ID, "–ü—ë—Ç—Ä", "–ú–ï–ù-241001", "–ò–ï–ù–∏–ú", "–®–ù", "2", bot.fsm.DialogState.REGISTERED);
        when(userStorage.getUser(CHAT_ID)).thenReturn(user);

        ScheduleCommand scheduleCommand = new ScheduleCommand(userStorage);

        try {
            String out = scheduleCommand.realizationWithChatId(CHAT_ID, new String[]{"/schedule"});
            assertNotNull(out);
            assertTrue(out.contains("–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –≥—Ä—É–ø–ø—ã"));
            assertTrue(out.contains("–§–∏–∑–∏–∫–∞"));
            assertTrue(out.contains("10:00") || out.contains("10:0"));

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ –¥–Ω—é:
            String out2 = scheduleCommand.realizationWithChatId(CHAT_ID, new String[]{"/schedule", "Monday"});
            assertNotNull(out2);
            assertTrue(out2.contains("–§–∏–∑–∏–∫–∞"));
            assertTrue(out2.contains("301"));
        } finally {
            // –ß–∏—Å—Ç–∏–º —Ñ–∞–π–ª –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞
            File f = new File(dbName);
            if (f.exists()) {
                f.delete();
            }
        }
    }

    // –£—Ç–∏–ª—å ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Mockito-–º–∞—Ç—á–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ—Ü–µ–Ω–∏–≤–∞–µ—Ç –∞—Ä–≥—É–º–µ–Ω—Ç –∫–∞–∫ String, –Ω–∞—á–∏–Ω–∞—é—â–∏–π—Å—è —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞.
    // –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ when(...).thenReturn(...) –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è –ª—é–±—ã–º URL, –Ω–∞—á–∏–Ω–∞—é—â–∏–º—Å—è —Å –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞.
    private static String startsWith(String prefix) {
        return Mockito.argThat(s -> s != null && s.startsWith(prefix));
    }
}package bot.commands;

import bot.user.User;
import bot.user.UserStorage;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class ShareGroupCommandTest {

    private UserStorage mockUserStorage;
    private ShareGroupCommand cmd;

    @BeforeEach
    public void setup() {
        mockUserStorage = mock(UserStorage.class);
        cmd = new ShareGroupCommand(mockUserStorage, "TestBot", 1);
    }

    @Test
    public void start_notRegistered_returnsError() {
        long chatId = 200L;
        when(mockUserStorage.getUser(chatId)).thenReturn(null);
        String r = cmd.start(chatId);
        assertTrue(r.contains("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –í–≤–µ–¥–∏—Ç–µ /start —á—Ç–æ–±—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è."));
    }

    @Test
    public void start_noGroup_returnsError() {
        long chatId = 201L;
        User u = new User(chatId);
        u.setGroup(null);
        when(mockUserStorage.getUser(chatId)).thenReturn(u);
        String r = cmd.start(chatId);
        assertTrue(r.contains("‚ùå –£ –≤–∞—Å –Ω–µ —É–∫–∞–∑–∞–Ω–∞ –≥—Ä—É–ø–ø–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ."));
    }

    @Test
    public void start_valid_returnsLinkAndStartParam() {
        long chatId = 202L;
        User u = new User(chatId);
        u.setGroup("–ú–ï–ù-241001");
        when(mockUserStorage.getUser(chatId)).thenReturn(u);

        String r = cmd.start(chatId);
        assertTrue(r.contains("https://t.me/TestBot"));
        assertTrue(r.contains("‚úÖ –°—Å—ã–ª–∫–∞-–ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∞:"));
        assertTrue(r.contains("/start invite_"));
    }
}
package bot.commands;

import bot.fsm.DialogState;
import bot.user.User;
import bot.user.UserStorage;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;

import org.telegram.telegrambots.meta.api.methods.send.SendMessage;
import org.telegram.telegrambots.meta.api.objects.replykeyboard.ReplyKeyboardMarkup;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

public class StartCommandTest {

    private UserStorage mockUserStorage;
    private StartCommand startCommand;
    private final long CHAT_ID = 12345L;

    @BeforeEach
    public void setup() {

        mockUserStorage = mock(UserStorage.class);
        startCommand = new StartCommand(mockUserStorage);
    }

    @Test
    public void testProcessStart_newUser_createsUserAndAsksName() {

        when(mockUserStorage.getUser(CHAT_ID)).thenReturn(null);
        // –∫–æ–≥–¥–∞ StartCommand —Å–ø—Ä–æ—Å–∏—Ç userStorage.getUser(CHAT_ID) ‚Äî –≤–µ—Ä–Ω—ë—Ç—Å—è null (–Ω–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)

        SendMessage resp = startCommand.processStart(CHAT_ID);
        // –í—ã–ø–æ–ª–Ω—è–µ–º –º–µ—Ç–æ–¥ ‚Äî –ø–æ–ª—É—á–∞–µ–º SendMessage (–æ—Ç–≤–µ—Ç –±–æ—Ç–∞)

        ArgumentCaptor<User> captor = ArgumentCaptor.forClass(User.class);
        // ArgumentCaptor –ø–æ–∑–≤–æ–ª—è–µ—Ç "–ø–æ–π–º–∞—Ç—å" –æ–±—ä–µ–∫—Ç User, –∫–æ—Ç–æ—Ä—ã–π –±—ã–ª –ø–µ—Ä–µ–¥–∞–Ω –≤ saveUser

        verify(mockUserStorage, times(1)).saveUser(captor.capture());
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ saveUser –≤—ã–∑–≤–∞–Ω —Ä–æ–≤–Ω–æ 1 —Ä–∞–∑, –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –≤ captor

        User saved = captor.getValue();
        assertNotNull(saved);
        assertEquals(CHAT_ID, saved.getChatId());
        // —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ null –∏ chatId —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ç–µ—Å—Ç–æ–≤—ã–º

        assertNotNull(resp);
        // –æ—Ç–≤–µ—Ç –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å null

        assertTrue(resp.getText().contains("–≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"));
        // –æ–∂–∏–¥–∞–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç –ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –∏–º—è ‚Äî —Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–ø—É—Å—Ç–∏–º–∞ –∑–¥–µ—Å—å
    }

    @Test
    public void testProcessStart_alreadyRegistered_showsProfileAndButtons() {

        User registered = new User(CHAT_ID, "–ò–≤–∞–Ω", "–ú–ï–ù-241001", "–ò–Ω–≠–£", "–®–ì–£–ü", "2", DialogState.REGISTERED);
        // —Å–æ–∑–¥–∞—ë–º –æ–±—ä–µ–∫—Ç User, –∫–æ—Ç–æ—Ä—ã–π —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω (DialogState.REGISTERED)
        when(mockUserStorage.getUser(CHAT_ID)).thenReturn(registered);

        SendMessage resp = startCommand.processStart(CHAT_ID);

        ArgumentCaptor<User> captor = ArgumentCaptor.forClass(User.class);
        verify(mockUserStorage, times(1)).updateUser(captor.capture());
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ updateUser –≤—ã–∑—ã–≤–∞–ª—Å—è (StartCommand –¥–æ–ª–∂–µ–Ω –ø–æ–º–µ—Ç–∏—Ç—å user –∫–∞–∫ waitingForButton)

        User updated = captor.getValue();
        assertTrue(updated.getWaitingForButton());
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

        assertNotNull(resp);
        assertTrue(resp.getText().contains("–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã"));
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

        assertNotNull(resp.getReplyMarkup());
        assertTrue(resp.getReplyMarkup() instanceof ReplyKeyboardMarkup);
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤ –æ—Ç–≤–µ—Ç–µ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ (ReplyKeyboardMarkup)
    }

    @Test
    public void testProcessButtonResponse_yes_updatesStateToAskName() {

        User registered = new User(CHAT_ID, "–ò–≤–∞–Ω", "M", "U", "D", "1", DialogState.REGISTERED);
        registered.setWaitingForButton(true);
        // –≤—ã—Å—Ç–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –æ–∂–∏–¥–∞–Ω–∏—è –∫–Ω–æ–ø–∫–∏, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–ª–∞ –≤–≤–æ–¥ –∫–Ω–æ–ø–∫–∏
        when(mockUserStorage.getUser(CHAT_ID)).thenReturn(registered);

        SendMessage resp = startCommand.processButtonResponse(CHAT_ID, "–î–ê");
        // –≤—ã–∑—ã–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —Å —Ç–µ–∫—Å—Ç–æ–º "–î–ê"

        ArgumentCaptor<User> captor = ArgumentCaptor.forClass(User.class);
        verify(mockUserStorage, times(1)).updateUser(captor.capture());
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ updateUser –≤—ã–∑–≤–∞–Ω ‚Äî —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ–ª–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å—Å—è

        User updated = captor.getValue();
        assertEquals(DialogState.ASK_NAME, updated.getState());
        // —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ ASK_NAME

        assertNotNull(resp);
        assertTrue(resp.getText().contains("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –Ω–æ–≤–æ–µ –∏–º—è"));
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏–ª –≤–≤–µ—Å—Ç–∏ –Ω–æ–≤–æ–µ –∏–º—è
    }

    @Test
    public void testProcessButtonResponse_no_keepsDataAndInformsUser() {

        User registered = new User(CHAT_ID, "–ò–≤–∞–Ω", "M", "U", "D", "1", DialogState.REGISTERED);
        registered.setWaitingForButton(true);
        when(mockUserStorage.getUser(CHAT_ID)).thenReturn(registered);

        SendMessage resp = startCommand.processButtonResponse(CHAT_ID, "–ù–ï–¢");

        verify(mockUserStorage, times(1)).updateUser(any(User.class));
        // updateUser –¥–æ–ª–∂–µ–Ω –±—ã–ª –≤—ã–∑–≤–∞—Ç—å—Å—è (–≤–æ–∑–º–æ–∂–Ω–æ, —á—Ç–æ–±—ã –æ–±–Ω—É–ª–∏—Ç—å —Ñ–ª–∞–≥ waitingForButton)
        assertNotNull(resp);
        assertTrue(resp.getText().contains("–û—Ç–ª–∏—á–Ω–æ! –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã"));
        // –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    }

    @Test
    public void testFullRegistrationFlow_name_group_university_department_course() {
        // –¢–µ—Å—Ç –∏–º–∏—Ç–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –º–µ–Ω—è—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ User –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–∫-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.
        long chatId = 2222L;

        // 1) –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç ‚Äî –ø—Ä–æ—Ü–µ—Å—Å —Å—Ç–∞—Ä—Ç–∞ –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å –µ–≥–æ –∏ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –∏–º—è
        when(mockUserStorage.getUser(chatId)).thenReturn(null);
        SendMessage startResp = startCommand.processStart(chatId);
        verify(mockUserStorage, times(1)).saveUser(any(User.class));
        assertTrue(startResp.getText().contains("–≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è"));

        // 2) –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ ASK_NAME ‚Äî –≤–≤–æ–¥–∏–º –∏–º—è –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–µ—Ö–æ–¥ –≤ ASK_GROUP
        User u1 = new User(chatId);
        u1.setState(DialogState.ASK_NAME);
        when(mockUserStorage.getUser(chatId)).thenReturn(u1);
        SendMessage respAfterName = startCommand.processRegistration(chatId, "–ü—ë—Ç—Ä");

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ updateUser –≤—ã–∑–≤–∞–Ω —Ö–æ—Ç—è –±—ã —Ä–∞–∑; –∑–∞—Ö–≤–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π User
        ArgumentCaptor<User> cap1 = ArgumentCaptor.forClass(User.class);
        verify(mockUserStorage, atLeastOnce()).updateUser(cap1.capture());
        User afterName = cap1.getValue();

        assertEquals(DialogState.ASK_GROUP, afterName.getState());
        // —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å—Ç–∞–ª–æ ASK_GROUP

        // --- –í–∞—Ä–∏–∞–Ω—Ç A: –≥–∏–±–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–≤–µ—Ç–∞: –ª–∏–±–æ —Ç–µ–∫—Å—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç "–≥—Ä—É–ø–ø", –ª–∏–±–æ –µ—Å—Ç—å –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ ---
        assertNotNull(respAfterName);
        String text = respAfterName.getText();
        boolean textContainsGroup = text != null && text.toLowerCase().contains("–≥—Ä—É–ø–ø");
        boolean hasKeyboard = respAfterName.getReplyMarkup() != null;
        assertTrue(textContainsGroup || hasKeyboard);


        // 3) –î–∞–ª—å—à–µ ‚Äî —Å–∏–º—É–ª—è—Ü–∏—è –≤–≤–æ–¥–∞ –≥—Ä—É–ø–ø—ã: –±–æ—Ç –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –≤—ã–±–æ—Ä —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ (–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞)
        User u2 = new User(chatId);
        u2.setState(DialogState.ASK_GROUP);
        when(mockUserStorage.getUser(chatId)).thenReturn(u2);
        SendMessage respAfterGroup = startCommand.processRegistration(chatId, "–ú–ï–ù-241001");
        assertNotNull(respAfterGroup.getReplyMarkup()); // –æ–∂–∏–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∏–Ω—Å—Ç–∏—Ç—É—Ç–æ–≤

        // 4) –í–≤–æ–¥ —É–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç–∞ (–≤ –¥–∞–Ω–Ω–æ–º —Ç–µ—Å—Ç–µ –ø—Ä–∏–Ω–∏–º–∞–µ–º, —á—Ç–æ "–ò–Ω–≠–£" –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
        User u3 = new User(chatId);
        u3.setState(DialogState.ASK_UNIVERSITY);
        when(mockUserStorage.getUser(chatId)).thenReturn(u3);
        SendMessage respAfterUniv = startCommand.processRegistration(chatId, "–ò–Ω–≠–£");
        assertNotNull(respAfterUniv.getReplyMarkup()); // –æ–∂–∏–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–æ–≤

        // 5) –í—ã–±–æ—Ä –¥–µ–ø–∞—Ä—Ç–∞–º–µ–Ω—Ç–∞ -> –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–µ—Ä–µ—Ö–æ–¥ –∫ –≤—ã–±–æ—Ä—É –∫—É—Ä—Å–∞
        User u4 = new User(chatId);
        u4.setState(DialogState.ASK_DEPARTMENT);
        when(mockUserStorage.getUser(chatId)).thenReturn(u4);
        SendMessage respAfterDept = startCommand.processRegistration(chatId, "–®–ì–£–ü");
        assertNotNull(respAfterDept.getReplyMarkup()); // –æ–∂–∏–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∫—É—Ä—Å–æ–≤

        // 6) –í–≤–æ–¥ –∫—É—Ä—Å–∞ -> —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞
        User u5 = new User(chatId);
        u5.setState(DialogState.ASK_COURSE);
        u5.setName("–ü—ë—Ç—Ä");
        u5.setGroup("–ú–ï–ù-241001");
        u5.setUniversity("–ò–Ω–≠–£");
        u5.setDepartment("–®–ì–£–ü");
        when(mockUserStorage.getUser(chatId)).thenReturn(u5);
        SendMessage finalResp = startCommand.processRegistration(chatId, "2");

        verify(mockUserStorage, atLeastOnce()).updateUser(any(User.class));
        assertNotNull(finalResp);
        assertTrue(finalResp.getText().contains("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞") || finalResp.getText().contains("–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–ª–∏—Å—å"));
        // —É–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –±–æ—Ç —Å–æ–æ–±—â–∞–µ—Ç –æ–± —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    }

    @Test
    public void testValidation_emptyName_returnsErrorMessage() {
        long chatId = 3333L;
        User user = new User(chatId);
        user.setState(DialogState.ASK_NAME);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        SendMessage resp = startCommand.processRegistration(chatId, "   ");
        assertNotNull(resp);
        assertTrue(resp.getText().contains("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º"));
    }

    @Test
    public void testValidation_emptyGroup_returnsErrorMessage() {
        long chatId = 4444L;
        User user = new User(chatId);
        user.setState(DialogState.ASK_GROUP);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        SendMessage resp = startCommand.processRegistration(chatId, "");
        assertNotNull(resp);
        assertTrue(resp.getText().contains("–ì—Ä—É–ø–ø–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π"));
    }
}package bot.commands;

import bot.user.User;
import bot.user.UserStorage;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;

import static org.mockito.Mockito.*;
import static org.junit.jupiter.api.Assertions.*;

public class SubscriptionCommandTest {

    private UserStorage mockUserStorage;
    private SubscriptionCommand cmd;

    @BeforeEach
    public void setup() {
        mockUserStorage = mock(UserStorage.class);
        cmd = new SubscriptionCommand(mockUserStorage);
    }

    @Test
    public void realizationWithChatId_userNotRegistered_returnsError() {
        long chatId = 2000L;
        when(mockUserStorage.getUser(chatId)).thenReturn(null);

        String out = cmd.realizationWithChatId(chatId, new String[]{"/subscription", "status"});
        assertNotNull(out);
        assertTrue(out.contains("‚ùå –í—ã –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã"));
    }

    @Test
    public void realizationWithChatId_noArgs_returnsUsage() {
        long chatId = 2001L;
        User user = new User(chatId);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        String out = cmd.realizationWithChatId(chatId, new String[]{"/subscription"});
        assertNotNull(out);
        assertTrue(out.contains("/subscription on"));
    }

    @Test
    public void realizationWithChatId_on_enablesSubscription() {
        long chatId = 2002L;
        User user = new User(chatId);
        user.setSubscriptionEnabled(false);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        String out = cmd.realizationWithChatId(chatId, new String[]{"/subscription", "on"});
        assertNotNull(out);
        assertTrue(out.contains("‚úÖ –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–∫–ª—é—á–µ–Ω—ã"));
        verify(mockUserStorage, times(1)).updateUser(any(User.class));
    }

    @Test
    public void realizationWithChatId_off_disablesSubscription() {
        long chatId = 2003L;
        User user = new User(chatId);
        user.setSubscriptionEnabled(true);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        String out = cmd.realizationWithChatId(chatId, new String[]{"/subscription", "off"});
        assertNotNull(out);
        assertTrue(out.contains("üîï –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤—ã–∫–ª—é—á–µ–Ω—ã"));
        verify(mockUserStorage, times(1)).updateUser(any(User.class));
    }

    @Test
    public void realizationWithChatId_status_reportsCurrent() {
        long chatId = 2004L;
        User user = new User(chatId);
        user.setSubscriptionEnabled(true);
        when(mockUserStorage.getUser(chatId)).thenReturn(user);

        String out = cmd.realizationWithChatId(chatId, new String[]{"/subscription", "status"});
        assertNotNull(out);
        assertTrue(out.contains("–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏: –í–ö–õ–Æ–ß–ï–ù–ê") || out.contains("–í–ö–õ–Æ–ß–ï–ù–ê"));
    }
}
